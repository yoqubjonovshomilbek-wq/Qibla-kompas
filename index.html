<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>Qibla Kompas Pro</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>

  <style>
    :root{ color-scheme: dark; --glass: rgba(255,255,255,.08); --border: rgba(255,255,255,.12); }
    *{ box-sizing:border-box; }
    body{
      margin:0; min-height:100vh; display:flex; align-items:center; justify-content:center;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(0,195,255,.20), transparent 55%),
        radial-gradient(800px 520px at 80% 20%, rgba(255,0,200,.12), transparent 50%),
        radial-gradient(1000px 800px at 50% 90%, rgba(0,255,140,.10), transparent 60%),
        #070a0c;
      color:#fff;
      padding: 18px;
    }
    .card{
      width:min(460px, 100%);
      border-radius: 22px;
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border: 1px solid var(--border);
      box-shadow: 0 24px 70px rgba(0,0,0,.45);
      backdrop-filter: blur(14px);
      padding: 16px;
    }
    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
      margin-bottom: 10px;
    }
    .title{
      font-weight: 800;
      letter-spacing: .2px;
      font-size: 18px;
      margin: 0;
    }
    .sub{
      margin: 6px 0 0;
      opacity:.82;
      font-size: 13px;
      line-height: 1.35;
    }
    .chip{
      display:inline-flex; align-items:center; gap:6px;
      padding: 8px 10px;
      border-radius: 999px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
      font-size: 12px;
      opacity:.95;
      white-space: nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:50%; background:#ffd166; box-shadow:0 0 0 6px rgba(255,209,102,.12); }
    .dot.ok{ background:#9cffc7; box-shadow:0 0 0 6px rgba(156,255,199,.12); }
    .dot.bad{ background:#ff9a9a; box-shadow:0 0 0 6px rgba(255,154,154,.12); }

    .compassWrap{
      width: 300px; height: 300px; margin: 14px auto 12px; position: relative;
    }
    .dial{
      position:absolute; inset:0;
      border-radius:50%;
      background:
        radial-gradient(circle at 50% 50%, rgba(255,255,255,.18) 0 1px, transparent 2px),
        radial-gradient(circle at 50% 50%, rgba(255,255,255,.08), rgba(255,255,255,.03) 50%, rgba(0,0,0,.28));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: inset 0 0 0 10px rgba(255,255,255,.03), 0 20px 50px rgba(0,0,0,.45);
      overflow:hidden;
    }
    .grid{
      position:absolute; inset:18px; border-radius:50%;
      background:
        conic-gradient(
          rgba(255,255,255,.42) 0 1deg,
          transparent 1deg 10deg,
          rgba(255,255,255,.22) 10deg 11deg,
          transparent 11deg 30deg
        );
      mask: radial-gradient(circle, transparent 0 62%, #000 63% 100%);
      opacity:.9;
      pointer-events:none;
    }
    .northMark{
      position:absolute; left:50%; top:8px; transform:translateX(-50%);
      padding: 6px 10px; border-radius: 999px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.12);
      font-weight:800; font-size: 12px;
      letter-spacing: .2px;
    }

    /* Dial rotates opposite of heading for nicer feel */
    .dialRotate{
      position:absolute; inset:0;
      transform: rotate(0deg);
      transition: transform 120ms linear;
    }

    /* Qibla needle */
    .needle{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      transform: rotate(0deg);
      transition: transform 120ms linear;
      pointer-events:none;
    }
    .shaft{
      width: 18px; height: 118px; border-radius: 14px;
      background: linear-gradient(to top, rgba(255,255,255,.10), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
      position: relative;
    }
    .shaft:before{
      content:"";
      position:absolute; top:-22px; left:50%; transform:translateX(-50%);
      width:0;height:0;
      border-left:16px solid transparent;
      border-right:16px solid transparent;
      border-bottom:26px solid rgba(0,210,255,.95);
      filter: drop-shadow(0 8px 12px rgba(0,210,255,.25));
    }
    .center{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:12px; height:12px; border-radius:50%;
      background: rgba(255,255,255,.92);
      box-shadow: 0 0 0 10px rgba(255,255,255,.10);
    }

    .stats{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
      margin-top: 10px;
    }
    .tile{
      border-radius: 16px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      padding: 10px;
    }
    .tile b{ display:block; font-size: 12px; opacity:.75; }
    .tile div{ margin-top: 4px; font-weight: 900; font-size: 16px; letter-spacing:.2px; }

    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{
      border:0; cursor:pointer;
      padding: 10px 12px; border-radius: 14px;
      font-weight: 800;
      color:#fff;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
    }
    button:active{ transform: translateY(1px); }
    .primary{ background: rgba(0,160,255,.22); border-color: rgba(0,160,255,.36); }
    .danger{ background: rgba(255,80,80,.18); border-color: rgba(255,80,80,.32); }

    .hint{
      margin-top: 10px;
      font-size: 13px;
      opacity: .85;
      line-height: 1.35;
    }
    .hint a{ color:#7ad7ff; }
  </style>
</head>

<body>
<div class="card">
  <div class="top">
    <div>
      <h1 class="title">üß≠ Qibla Kompas Pro</h1>
      <p class="sub">GPS + kompas sensori. Telefonni tekis ushlang. Agar ‚Äúsakrasa‚Äù, kalibrovka qiling.</p>
    </div>
    <div class="chip" id="chip"><span class="dot" id="dot"></span><span id="chipTxt">Kutyapman‚Ä¶</span></div>
  </div>

  <div class="compassWrap">
    <div class="dial">
      <div class="dialRotate" id="dialRotate">
        <div class="grid"></div>
        <div class="northMark">N</div>
      </div>
    </div>

    <div class="needle" id="needle">
      <div class="shaft"></div>
    </div>
    <div class="center"></div>
  </div>

  <div class="stats">
    <div class="tile"><b>Qibla (bearing)</b><div id="qiblaTxt">‚Äî</div></div>
    <div class="tile"><b>Heading (kompas)</b><div id="headTxt">‚Äî</div></div>
    <div class="tile"><b>Strelka burilishi</b><div id="rotTxt">‚Äî</div></div>
    <div class="tile"><b>Joylashuv</b><div id="locTxt">‚Äî</div></div>
  </div>

  <div class="btns">
    <button class="primary" id="btnStart">Boshlash</button>
    <button id="btnPerm">Motion ruxsat</button>
    <button class="danger" id="btnStop">To‚Äòxtatish</button>
  </div>

  <div class="hint" id="hint">
    üí° iPhone‚Äôda albatta <b>Motion ruxsat</b> bering. Android‚Äôda kompas adashsa: telefonni ‚Äú8‚Äù shaklida aylantiring.
    HTTPS bo‚Äòlmasa sensorlar ishlamasligi mumkin.
  </div>
</div>

<script>
(() => {
  try { if (window.Telegram?.WebApp) { Telegram.WebApp.ready(); Telegram.WebApp.expand(); } } catch(e){}

  const KAABA = { lat: 21.422487, lon: 39.826206 };

  const needle = document.getElementById('needle');
  const dialRotate = document.getElementById('dialRotate');
  const qiblaTxt = document.getElementById('qiblaTxt');
  const headTxt  = document.getElementById('headTxt');
  const rotTxt   = document.getElementById('rotTxt');
  const locTxt   = document.getElementById('locTxt');
  const chipTxt  = document.getElementById('chipTxt');
  const dot      = document.getElementById('dot');

  const btnStart = document.getElementById('btnStart');
  const btnPerm  = document.getElementById('btnPerm');
  const btnStop  = document.getElementById('btnStop');

  let watchId = null;
  let lat=null, lon=null;

  // Raw heading from sensors (0..360, 0=N)
  let headingRaw = null;

  // Smoothed heading
  let heading = null;

  // Qibla bearing
  let qibla = null;

  // Helpers
  const toRad = d => d * Math.PI / 180;
  const toDeg = r => r * 180 / Math.PI;

  function norm360(x){ x%=360; if(x<0) x+=360; return x; }

  // Smooth angles (handles wrap-around)
  function smoothAngle(prev, next, alpha=0.18){
    if(prev == null) return next;
    // shortest direction
    let diff = ((next - prev + 540) % 360) - 180;
    return norm360(prev + diff * alpha);
  }

  function setStatus(text, state){
    chipTxt.textContent = text;
    dot.className = 'dot' + (state === 'ok' ? ' ok' : state === 'bad' ? ' bad' : '');
  }

  function bearing(lat1, lon1, lat2, lon2){
    const œÜ1 = toRad(lat1), œÜ2 = toRad(lat2);
    const ŒîŒª = toRad(lon2 - lon1);
    const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
    const x = Math.cos(œÜ1)*Math.sin(œÜ2) - Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
    return norm360(toDeg(Math.atan2(y, x)));
  }

  function update(){
    if(lat != null && lon != null){
      locTxt.textContent = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
      qibla = bearing(lat, lon, KAABA.lat, KAABA.lon);
      qiblaTxt.textContent = `${qibla.toFixed(1)}¬∞`;
    }

    if(headingRaw != null){
      heading = smoothAngle(heading, headingRaw);
      headTxt.textContent = `${heading.toFixed(1)}¬∞`;
      // Rotate dial opposite for nicer UX (north stays "up")
      dialRotate.style.transform = `rotate(${-heading}deg)`;
    }

    if(qibla != null && heading != null){
      const rot = norm360(qibla - heading); // relative direction to qibla
      needle.style.transform = `rotate(${rot}deg)`;
      rotTxt.textContent = `${rot.toFixed(1)}¬∞`;
      setStatus('Ishlayapti ‚úÖ', 'ok');
    } else {
      setStatus('Ruxsat/GPS kutilyapti‚Ä¶', '');
    }
  }

  // GEO
  function startGeo(){
    if(!navigator.geolocation){
      setStatus('GPS yo‚Äòq (brauzer)', 'bad'); return;
    }
    if(watchId != null) return;
    setStatus('GPS olinmoqda‚Ä¶', '');
    watchId = navigator.geolocation.watchPosition(
      p => { lat = p.coords.latitude; lon = p.coords.longitude; update(); },
      e => { setStatus('GPS xato: ' + e.message, 'bad'); },
      { enableHighAccuracy:true, maximumAge:1500, timeout:15000 }
    );
  }
  function stopGeo(){
    if(watchId != null) navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }

  // ORIENTATION
  function onOri(e){
    // iOS Safari best: webkitCompassHeading (0..360, 0=N)
    if(typeof e.webkitCompassHeading === 'number'){
      headingRaw = norm360(e.webkitCompassHeading);
      update();
      return;
    }

    // Others: alpha (0..360). Absolute is better but not always present.
    if(typeof e.alpha === 'number'){
      // Many Android devices: alpha already behaves like compass heading.
      // If it feels reversed on some devices, we can flip, but this version keeps it.
      headingRaw = norm360(e.alpha);
      update();
      return;
    }
  }

  function startOri(){
    window.addEventListener('deviceorientationabsolute', onOri, true);
    window.addEventListener('deviceorientation', onOri, true);
  }
  function stopOri(){
    window.removeEventListener('deviceorientationabsolute', onOri, true);
    window.removeEventListener('deviceorientation', onOri, true);
  }

  async function requestMotion(){
    try{
      const D = window.DeviceOrientationEvent;
      if(D && typeof D.requestPermission === 'function'){
        const res = await D.requestPermission();
        if(res === 'granted'){
          setStatus('Motion ruxsat ‚úÖ', 'ok');
          startOri();
        } else {
          setStatus('Motion ruxsat berilmadi', 'bad');
        }
      } else {
        // Android/most browsers
        startOri();
        setStatus('Kompas tinglanyapti‚Ä¶', '');
      }
    } catch(err){
      setStatus('Motion xato: ' + err.message, 'bad');
    }
  }

  // Buttons
  btnStart.addEventListener('click', async () => {
    startGeo();
    await requestMotion();
    update();
  });
  btnPerm.addEventListener('click', async () => {
    await requestMotion();
  });
  btnStop.addEventListener('click', () => {
    stopGeo(); stopOri();
    headingRaw = null; heading = null; qibla = null;
    qiblaTxt.textContent = headTxt.textContent = rotTxt.textContent = locTxt.textContent = '‚Äî';
    needle.style.transform = 'rotate(0deg)';
    dialRotate.style.transform = 'rotate(0deg)';
    setStatus('To‚Äòxtatildi', '');
  });

  setStatus('Boshlash tugmasini bosing', '');
})();
</script>
</body>
</html>
