<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Islomiy Ilova</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@400;500;700&display=swap');

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --g:#1db954;--gd:#158f3e;--gold:#d4a843;
  --bg:#04101e;--s1:#0b1e35;--s2:#102840;--s3:#163450;
  --border:rgba(29,185,84,0.18);--text:#e8f4fd;--muted:#567a96;
  --glow:rgba(29,185,84,0.4);
}
html,body{height:100%;overflow:hidden;}
body{font-family:'Tajawal',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;height:100dvh;}

/* NAV */
.nav{display:flex;background:var(--s1);border-bottom:1px solid var(--border);flex-shrink:0;z-index:50;}
.nb{flex:1;padding:12px 8px 10px;border:none;background:transparent;color:var(--muted);
  font-family:'Tajawal',sans-serif;font-size:12px;font-weight:500;cursor:pointer;
  display:flex;flex-direction:column;align-items:center;gap:3px;position:relative;transition:color .2s;}
.nb .ni{font-size:22px;}
.nb.on{color:var(--g);}
.nb::after{content:'';position:absolute;bottom:0;left:25%;right:25%;height:2px;
  border-radius:2px 2px 0 0;background:var(--g);transform:scaleX(0);transition:transform .2s;}
.nb.on::after{transform:scaleX(1);}

/* PAGES */
.pages{flex:1;position:relative;overflow:hidden;}
.pg{position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;
  opacity:0;pointer-events:none;transition:opacity .2s;}
.pg.on{opacity:1;pointer-events:all;}
.pg::-webkit-scrollbar{width:3px;}
.pg::-webkit-scrollbar-thumb{background:var(--s3);border-radius:3px;}

/* ============ QIBLA PAGE ============ */
.qp{display:flex;flex-direction:column;align-items:center;padding:18px 16px 30px;gap:14px;}

.ptitle{font-family:'Amiri',serif;font-size:22px;color:var(--gold);text-align:center;
  text-shadow:0 0 18px rgba(212,168,67,.4);}
.ptitle small{display:block;font-family:'Tajawal',sans-serif;font-size:11px;color:var(--muted);margin-top:2px;letter-spacing:1px;}

/* COMPASS */
.cwrap{position:relative;width:270px;height:270px;flex-shrink:0;}

.oring{position:absolute;inset:0;border-radius:50%;
  background:conic-gradient(from 0deg,#1a3a5c,#0b1e35,#1a3a5c,#0b1e35,#1a3a5c);
  box-shadow:0 0 20px rgba(0,0,0,.7),inset 0 0 12px rgba(0,0,0,.5);
  transition:background .3s,box-shadow .3s;}
.oring.ok{
  background:conic-gradient(from 0deg,var(--g),#0e7a30,var(--g),#0e7a30,var(--g));
  box-shadow:0 0 40px var(--glow),0 0 80px rgba(29,185,84,.25);
  animation:pr 1.2s ease-in-out infinite alternate;}
@keyframes pr{from{box-shadow:0 0 25px var(--glow),0 0 50px rgba(29,185,84,.2);}
  to{box-shadow:0 0 50px var(--glow),0 0 100px rgba(29,185,84,.3);}}

/* DIAL rotates opposite to phone heading */
.cdial{position:absolute;inset:6px;border-radius:50%;
  background:radial-gradient(ellipse at 35% 30%,#1b3860,#061528 75%);
  will-change:transform;transition:transform 0.1s linear;overflow:hidden;}
.dsvg{position:absolute;inset:0;width:100%;height:100%;}

/* ARROW layer - never moves, only inner SVG group rotates */
.alayer{position:absolute;inset:6px;border-radius:50%;pointer-events:none;}
.asvg{position:absolute;inset:0;width:100%;height:100%;}

/* Center kaaba */
.ck{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:46px;height:46px;background:radial-gradient(#1a5030,#091e12);
  border-radius:50%;border:2.5px solid var(--gold);
  display:flex;align-items:center;justify-content:center;font-size:22px;
  z-index:20;box-shadow:0 0 12px rgba(212,168,67,.3);}

/* INFO CARDS */
.dcard{background:linear-gradient(135deg,var(--s1),var(--s2));border:1.5px solid var(--border);
  border-radius:16px;padding:14px 24px;text-align:center;width:100%;position:relative;overflow:hidden;}
.dcard::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,var(--g),transparent);}
.dnum{font-size:42px;font-weight:700;line-height:1;color:var(--text);}
.dnum b{color:var(--g);}
.ddir{font-size:11px;color:var(--muted);margin-top:4px;letter-spacing:1px;text-transform:uppercase;}

.spill{display:inline-flex;align-items:center;gap:7px;padding:7px 18px;border-radius:30px;
  font-size:13px;font-weight:600;background:var(--s1);border:1.5px solid rgba(29,185,84,.2);
  color:var(--muted);transition:all .3s;}
.spill.ok{background:rgba(29,185,84,.12);border-color:var(--g);color:var(--g);}
.sdot{width:9px;height:9px;border-radius:50%;background:var(--muted);transition:background .3s;}
.spill.ok .sdot{background:var(--g);box-shadow:0 0 6px var(--g);animation:bk 1s infinite;}
@keyframes bk{0%,100%{opacity:1;}50%{opacity:.3;}}

.atxt{font-family:'Amiri',serif;font-size:16px;color:var(--gold);text-align:center;
  text-shadow:0 0 12px rgba(212,168,67,.4);opacity:0;transition:opacity .4s;
  min-height:0;overflow:hidden;max-height:0;}
.atxt.show{opacity:1;max-height:40px;}

.lbox{display:flex;align-items:center;gap:10px;background:rgba(11,30,53,.7);
  border:1px solid rgba(90,138,170,.15);border-radius:12px;padding:10px 14px;
  width:100%;font-size:12px;color:var(--muted);}
.lbox strong{color:var(--text);font-size:13px;display:block;}

.sbtn{background:linear-gradient(135deg,var(--gd),var(--g));border:none;border-radius:14px;
  padding:13px;color:#fff;font-family:'Tajawal',sans-serif;font-size:15px;font-weight:700;
  cursor:pointer;width:100%;box-shadow:0 4px 18px var(--glow);transition:transform .15s;}
.sbtn:active{transform:scale(.97);}

/* ============ QURAN PAGE ============ */
.qrp{display:flex;flex-direction:column;}
.qhdr{padding:14px 14px 10px;background:var(--s1);border-bottom:1px solid var(--border);
  position:sticky;top:0;z-index:10;flex-shrink:0;}
.qhdr h2{font-family:'Amiri',serif;font-size:20px;color:var(--gold);
  text-shadow:0 0 12px rgba(212,168,67,.3);text-align:center;margin-bottom:8px;}
.sbox{position:relative;}
.sbox input{width:100%;background:var(--s2);border:1.5px solid var(--border);border-radius:10px;
  padding:9px 12px 9px 36px;color:var(--text);font-family:'Tajawal',sans-serif;
  font-size:13px;outline:none;transition:border-color .2s;}
.sbox input:focus{border-color:var(--g);}
.sbox input::placeholder{color:var(--muted);}
.si{position:absolute;left:11px;top:50%;transform:translateY(-50%);font-size:14px;pointer-events:none;}
.rcrow{display:flex;gap:6px;margin-top:8px;overflow-x:auto;padding-bottom:2px;}
.rcrow::-webkit-scrollbar{display:none;}
.rchip{flex-shrink:0;padding:5px 12px;border-radius:20px;border:1.5px solid var(--border);
  background:var(--s2);color:var(--muted);font-size:11px;cursor:pointer;transition:all .2s;
  font-family:'Tajawal',sans-serif;white-space:nowrap;}
.rchip.on{background:rgba(29,185,84,.15);border-color:var(--g);color:var(--g);}

/* SURAH LIST */
.slist{padding:8px 10px;padding-bottom:150px;}
.si2{display:flex;align-items:center;gap:10px;padding:10px 11px;border-radius:11px;
  background:var(--s1);border:1px solid var(--border);margin-bottom:5px;cursor:pointer;
  transition:background .15s,border-color .15s;position:relative;overflow:hidden;}
.si2:active{transform:scale(.99);}
.si2.pl{background:rgba(29,185,84,.1);border-color:var(--g);}
.si2::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;
  background:var(--g);transform:scaleY(0);transition:transform .2s;border-radius:0 2px 2px 0;}
.si2.pl::before{transform:scaleY(1);}
.sno{width:32px;height:32px;background:var(--s2);border-radius:8px;
  display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;
  color:var(--g);flex-shrink:0;border:1px solid var(--border);}
.si2.pl .sno{background:var(--g);color:#fff;border-color:var(--g);}
.sinf{flex:1;min-width:0;}
.sar{font-family:'Amiri',serif;font-size:15px;color:var(--text);}
.suz{font-size:10px;color:var(--muted);margin-top:1px;}
.smeta{font-size:10px;color:var(--muted);text-align:right;flex-shrink:0;line-height:1.5;}
.pbtn{width:32px;height:32px;border-radius:50%;background:var(--s2);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;font-size:13px;flex-shrink:0;}
.si2.pl .pbtn{background:var(--g);border-color:var(--g);}

.nores{text-align:center;padding:40px 20px;color:var(--muted);font-size:13px;}

/* PLAYER */
.player{position:fixed;bottom:0;left:0;right:0;
  background:linear-gradient(0deg,var(--s1) 0%,rgba(11,30,53,.97) 100%);
  border-top:1px solid var(--border);padding:10px 14px 18px;z-index:200;
  transform:translateY(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);
  box-shadow:0 -8px 30px rgba(0,0,0,.6);}
.player.vis{transform:translateY(0);}
.pinfo{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px;}
.ptit{font-family:'Amiri',serif;font-size:15px;color:var(--gold);}
.prec{font-size:10px;color:var(--muted);margin-top:1px;}
.pcls{background:none;border:none;color:var(--muted);font-size:18px;cursor:pointer;padding:2px 6px;}
.prow{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.ptm{font-size:11px;color:var(--muted);min-width:32px;font-variant-numeric:tabular-nums;}
.pbar{flex:1;height:5px;background:var(--s3);border-radius:5px;cursor:pointer;position:relative;}
.pfil{height:100%;background:var(--g);border-radius:5px;width:0%;pointer-events:none;transition:width .25s linear;}
.pctrls{display:flex;align-items:center;justify-content:center;gap:20px;}
.cbtn{background:none;border:none;color:var(--muted);font-size:22px;cursor:pointer;padding:4px;transition:color .15s;}
.cbtn:hover{color:var(--text);}
.ppbtn{width:50px;height:50px;border-radius:50%;background:var(--g);border:none;
  display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;
  box-shadow:0 4px 15px var(--glow);transition:transform .1s;}
.ppbtn:active{transform:scale(.92);}
.loading-dots::after{content:'';animation:dots 1.2s infinite;display:inline-block;}
@keyframes dots{0%{content:'â³';}50%{content:'ğŸ”„';}100%{content:'â³';}}
</style>
</head>
<body>

<nav class="nav">
  <button class="nb on" id="nb0" onclick="goTab(0)">
    <span class="ni">ğŸ§­</span><span>Qibla</span>
  </button>
  <button class="nb" id="nb1" onclick="goTab(1)">
    <span class="ni">ğŸ“–</span><span>Qur'on</span>
  </button>
</nav>

<div class="pages">

  <!-- QIBLA -->
  <div class="pg qp on" id="pg0">
    <div class="ptitle">ğŸ•Œ Qibla Kompas<small>Makka al-Mukarrama yo'nalishi</small></div>

    <div class="cwrap" id="cwrap">
      <div class="oring" id="oring"></div>
      <div class="cdial" id="cdial">
        <svg class="dsvg" viewBox="0 0 250 250">
          <g id="tks"></g>
          <text x="125" y="28" text-anchor="middle" font-family="Tajawal" font-weight="700" font-size="17" fill="#e74c3c">N</text>
          <text x="125" y="234" text-anchor="middle" font-family="Tajawal" font-weight="700" font-size="15" fill="#4a80a8">S</text>
          <text x="232" y="130" text-anchor="middle" dominant-baseline="middle" font-family="Tajawal" font-weight="700" font-size="15" fill="#4a80a8">E</text>
          <text x="18" y="130" text-anchor="middle" dominant-baseline="middle" font-family="Tajawal" font-weight="700" font-size="15" fill="#4a80a8">W</text>
          <text x="125" y="49" text-anchor="middle" font-family="Tajawal" font-size="9" fill="#2a5878">0Â°</text>
          <text x="197" y="63" text-anchor="middle" font-family="Tajawal" font-size="9" fill="#2a5878">45Â°</text>
          <text x="213" y="132" text-anchor="middle" font-family="Tajawal" font-size="9" fill="#2a5878">90Â°</text>
          <text x="197" y="198" text-anchor="middle" font-family="Tajawal" font-size="9" fill="#2a5878">135Â°</text>
          <text x="125" y="215" text-anchor="middle" font-family="Tajawal" font-size="9" fill="#2a5878">180Â°</text>
          <text x="53" y="198" text-anchor="middle" font-family="Tajawal" font-size="9" fill="#2a5878">225Â°</text>
          <text x="37" y="132" text-anchor="middle" font-family="Tajawal" font-size="9" fill="#2a5878">270Â°</text>
          <text x="53" y="63" text-anchor="middle" font-family="Tajawal" font-size="9" fill="#2a5878">315Â°</text>
        </svg>
      </div>
      <div class="alayer">
        <svg class="asvg" viewBox="0 0 250 250" id="asvg">
          <!-- Arrow group - rotates around 125,125 -->
          <g id="arw">
            <polygon points="125,32 134,125 125,135 116,125" fill="#1db954" opacity=".95"/>
            <polygon points="125,135 134,125 144,150 125,143 106,150 116,125" fill="#158f3e" opacity=".9"/>
            <polygon points="125,32 133,72 117,72" fill="rgba(255,255,255,.28)"/>
            <circle cx="125" cy="125" r="5" fill="#1db954" opacity=".6"/>
            <text x="125" y="170" text-anchor="middle" font-family="Tajawal" font-size="10" font-weight="700" fill="#1db954">QIBLA</text>
          </g>
        </svg>
      </div>
      <div class="ck">ğŸ•‹</div>
    </div>

    <div class="dcard">
      <div class="dnum"><b id="dv">--</b>Â°</div>
      <div class="ddir" id="dd">Yo'nalish aniqlanmoqda...</div>
    </div>

    <div class="spill" id="sp"><div class="sdot"></div><span id="stxt">Kompas ishga tushirilmoqda</span></div>
    <div class="atxt" id="at">ğŸŒ¿ Allahu Akbar! Qibla topildi ğŸŒ¿</div>

    <div class="lbox"><span>ğŸ“</span><div><strong id="ln">Joylashuv aniqlanmoqda...</strong><span id="lc"></span></div></div>

    <button class="sbtn" id="sbtn" onclick="initCompass()">ğŸ§­ Kompasni Ishga Tushirish</button>
    <p style="font-size:11px;color:var(--muted);text-align:center;line-height:1.6;">
      Telefon sensori va GPS orqali aniqlaydi.<br>Sensor ishlamasa simulyatsiya rejimi yonadi.
    </p>
  </div>

  <!-- QURAN -->
  <div class="pg qrp" id="pg1">
    <div class="qhdr">
      <h2>ğŸ“– Qur'oni Karim</h2>
      <div class="sbox">
        <span class="si">ğŸ”</span>
        <input id="srch" type="text" placeholder="Sura nomi yoki raqami..." oninput="doFilter()">
      </div>
      <div class="rcrow" id="rcrow"></div>
    </div>
    <div class="slist" id="slist"><div class="nores">â³ Yuklanmoqda...</div></div>
  </div>

</div>

<!-- PLAYER -->
<div class="player" id="player">
  <div class="pinfo">
    <div><div class="ptit" id="ptit">â€”</div><div class="prec" id="prec">â€”</div></div>
    <button class="pcls" onclick="closePlayer()">âœ•</button>
  </div>
  <div class="prow">
    <span class="ptm" id="tc">0:00</span>
    <div class="pbar" id="pbar" onclick="seek(event)"><div class="pfil" id="pfil"></div></div>
    <span class="ptm" id="td">0:00</span>
  </div>
  <div class="pctrls">
    <button class="cbtn" onclick="moveSurah(-1)">â®</button>
    <button class="ppbtn" id="ppbtn" onclick="togglePlay()">â–¶</button>
    <button class="cbtn" onclick="moveSurah(1)">â­</button>
  </div>
</div>

<audio id="au"></audio>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TAB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goTab(i) {
  [0,1].forEach(j => {
    document.getElementById('nb'+j).classList.toggle('on', j===i);
    document.getElementById('pg'+j).classList.toggle('on', j===i);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QIBLA COMPASS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const KBL = {lat:21.4225, lng:39.8262};
let uLat=null, uLng=null, bearing=null, heading=0, aligned=false, started=false;

// Draw ticks on dial
(function(){
  const g = document.getElementById('tks');
  const cx=125,cy=125,r=110;
  for(let i=0;i<360;i+=5){
    const a=(i-90)*Math.PI/180;
    const maj=i%90===0, med=i%45===0, sm=i%15===0;
    const len=maj?13:med?9:sm?6:4;
    const col=maj?'#4a90d9':med?'#2a6090':sm?'#1a4560':'#0f2f40';
    const l=document.createElementNS('http://www.w3.org/2000/svg','line');
    l.setAttribute('x1',cx+r*Math.cos(a)); l.setAttribute('y1',cy+r*Math.sin(a));
    l.setAttribute('x2',cx+(r-len)*Math.cos(a)); l.setAttribute('y2',cy+(r-len)*Math.sin(a));
    l.setAttribute('stroke',col); l.setAttribute('stroke-width',maj?'2':'1');
    g.appendChild(l);
  }
})();

function bearing2(la1,lo1,la2,lo2){
  const R=d=>d*Math.PI/180;
  const y=Math.sin(R(lo2-lo1))*Math.cos(R(la2));
  const x=Math.cos(R(la1))*Math.sin(R(la2))-Math.sin(R(la1))*Math.cos(R(la2))*Math.cos(R(lo2-lo1));
  return(Math.atan2(y,x)*180/Math.PI+360)%360;
}
function dirName(d){
  return['Shimol','Shimoli-sharq','Sharq','Janubi-sharq','Janub',"Janubi-g'arb","G'arb","Shimoli-g'arb"][Math.round(d/45)%8];
}

function redraw(){
  if(bearing===null) return;
  const aa = bearing - heading;
  // Rotate arrow group around SVG center 125,125
  document.getElementById('arw').setAttribute('transform',`rotate(${aa},125,125)`);
  // Counter-rotate dial
  document.getElementById('cdial').style.transform=`rotate(${-heading}deg)`;
  document.getElementById('dv').textContent = Math.round(bearing);
  document.getElementById('dd').textContent = dirName(bearing);
  // Alignment check
  const n=((aa%360)+360)%360;
  const now = Math.min(n,360-n)<6;
  if(now!==aligned){
    aligned=now;
    document.getElementById('oring').classList.toggle('ok',now);
    document.getElementById('sp').classList.toggle('ok',now);
    document.getElementById('stxt').textContent=now?'âœ… Qibla topildi!':'Qiblani izlang...';
    const at=document.getElementById('at');
    at.classList.toggle('show',now);
  }
}

function setLoc(la,lo,label){
  uLat=la; uLng=lo;
  bearing=bearing2(la,lo,KBL.lat,KBL.lng);
  document.getElementById('ln').textContent=label;
  document.getElementById('lc').textContent=`Qibla: ${Math.round(bearing)}Â° ${dirName(bearing)}`;
  redraw();
}

function getGPS(){
  if(!navigator.geolocation){setLoc(41.2995,69.2401,'Toshkent (taxminiy)');return;}
  navigator.geolocation.getCurrentPosition(
    p=>{
      const la=p.coords.latitude, lo=p.coords.longitude;
      setLoc(la,lo,`${la.toFixed(3)}Â°, ${lo.toFixed(3)}Â°`);
      fetch(`https://nominatim.openstreetmap.org/reverse?lat=${la}&lon=${lo}&format=json`)
        .then(r=>r.json()).then(d=>{
          const c=d.address?.city||d.address?.town||d.address?.village||'';
          const co=d.address?.country||'';
          if(c||co) document.getElementById('ln').textContent=`${c}${c&&co?', ':''}${co}`;
        }).catch(()=>{});
    },
    ()=>setLoc(41.2995,69.2401,'Toshkent (taxminiy)'),
    {timeout:8000, maximumAge:60000}
  );
}

// Smoothing
let tgt=0, raf=null;
function smooth(){
  let diff=tgt-heading;
  if(diff>180) diff-=360;
  if(diff<-180) diff+=360;
  if(Math.abs(diff)>0.3){
    heading=(heading+diff*0.15+360)%360;
    redraw();
  }
  raf=requestAnimationFrame(smooth);
}

let simTimer=null;
function startSim(){
  document.getElementById('stxt').textContent='Simulyatsiya rejimi';
  let a=0;
  simTimer=setInterval(()=>{tgt=(tgt+1.5)%360;},30);
}

function onOrient(e){
  let h=null;
  if(e.webkitCompassHeading!=null) h=e.webkitCompassHeading;
  else if(e.absolute && e.alpha!=null) h=(360-e.alpha)%360;
  else if(e.alpha!=null) h=(360-e.alpha)%360;
  if(h!=null && !isNaN(h)) tgt=h;
}

function initCompass(){
  if(started) return;
  started=true;
  document.getElementById('sbtn').style.display='none';
  document.getElementById('stxt').textContent='GPS aniqlanmoqda...';
  getGPS();
  raf=requestAnimationFrame(smooth);

  const listen=()=>{
    window.addEventListener('deviceorientationabsolute',onOrient,true);
    window.addEventListener('deviceorientation',onOrient,true);
    document.getElementById('stxt').textContent='Kompas faol';
    // If no real data in 4s â†’ simulate
    setTimeout(()=>{
      if(Math.abs(tgt)<0.001) startSim();
    },4000);
  };

  if(typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){
    // iOS 13+ â€” must call on user gesture
    DeviceOrientationEvent.requestPermission()
      .then(s=>{ if(s==='granted') listen(); else startSim(); })
      .catch(startSim);
  } else {
    listen();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QURAN AUDIO
//  Using alquran.cloud (open CORS API)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// mp3quran.net â€” Telegram WebView da CORS muammosiz ishlaydi
const RECITERS=[
  {name:'Mishary Alafasy',    base:'https://server8.mp3quran.net/afs/'},
  {name:'Abdurrahman Sudais', base:'https://server11.mp3quran.net/sds/'},
  {name:'Husary',             base:'https://server13.mp3quran.net/husr/'},
  {name:'Saad Al-Ghamdi',    base:'https://server7.mp3quran.net/s_gmd/'},
];

const SURAHS=[
  {n:1,ar:'Ø§Ù„ÙØ§ØªØ­Ø©',uz:'Al-Fotiha',a:7,t:'Makka'},
  {n:2,ar:'Ø§Ù„Ø¨Ù‚Ø±Ø©',uz:'Al-Baqara',a:286,t:'Madina'},
  {n:3,ar:'Ø¢Ù„ Ø¹Ù…Ø±Ø§Ù†',uz:'Ali Imron',a:200,t:'Madina'},
  {n:4,ar:'Ø§Ù„Ù†Ø³Ø§Ø¡',uz:'An-Niso',a:176,t:'Madina'},
  {n:5,ar:'Ø§Ù„Ù…Ø§Ø¦Ø¯Ø©',uz:'Al-Moida',a:120,t:'Madina'},
  {n:6,ar:'Ø§Ù„Ø£Ù†Ø¹Ø§Ù…',uz:"Al-An'om",a:165,t:'Makka'},
  {n:7,ar:'Ø§Ù„Ø£Ø¹Ø±Ø§Ù',uz:"Al-A'rof",a:206,t:'Makka'},
  {n:8,ar:'Ø§Ù„Ø£Ù†ÙØ§Ù„',uz:'Al-Anfol',a:75,t:'Madina'},
  {n:9,ar:'Ø§Ù„ØªÙˆØ¨Ø©',uz:'At-Tavba',a:129,t:'Madina'},
  {n:10,ar:'ÙŠÙˆÙ†Ø³',uz:'Yunus',a:109,t:'Makka'},
  {n:11,ar:'Ù‡ÙˆØ¯',uz:'Hud',a:123,t:'Makka'},
  {n:12,ar:'ÙŠÙˆØ³Ù',uz:'Yusuf',a:111,t:'Makka'},
  {n:13,ar:'Ø§Ù„Ø±Ø¹Ø¯',uz:"Ar-Ra'd",a:43,t:'Madina'},
  {n:14,ar:'Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…',uz:'Ibrohim',a:52,t:'Makka'},
  {n:15,ar:'Ø§Ù„Ø­Ø¬Ø±',uz:'Al-Hijr',a:99,t:'Makka'},
  {n:16,ar:'Ø§Ù„Ù†Ø­Ù„',uz:'An-Nahl',a:128,t:'Makka'},
  {n:17,ar:'Ø§Ù„Ø¥Ø³Ø±Ø§Ø¡',uz:'Al-Isro',a:111,t:'Makka'},
  {n:18,ar:'Ø§Ù„ÙƒÙ‡Ù',uz:'Al-Kahf',a:110,t:'Makka'},
  {n:19,ar:'Ù…Ø±ÙŠÙ…',uz:'Maryam',a:98,t:'Makka'},
  {n:20,ar:'Ø·Ù‡',uz:'To Ha',a:135,t:'Makka'},
  {n:21,ar:'Ø§Ù„Ø£Ù†Ø¨ÙŠØ§Ø¡',uz:'Al-Anbiyo',a:112,t:'Makka'},
  {n:22,ar:'Ø§Ù„Ø­Ø¬',uz:'Al-Haj',a:78,t:'Madina'},
  {n:23,ar:'Ø§Ù„Ù…Ø¤Ù…Ù†ÙˆÙ†',uz:"Al-Mo'minun",a:118,t:'Makka'},
  {n:24,ar:'Ø§Ù„Ù†ÙˆØ±',uz:'An-Nur',a:64,t:'Madina'},
  {n:25,ar:'Ø§Ù„ÙØ±Ù‚Ø§Ù†',uz:'Al-Furqon',a:77,t:'Makka'},
  {n:26,ar:'Ø§Ù„Ø´Ø¹Ø±Ø§Ø¡',uz:"Ash-Shu'aro",a:227,t:'Makka'},
  {n:27,ar:'Ø§Ù„Ù†Ù…Ù„',uz:'An-Naml',a:93,t:'Makka'},
  {n:28,ar:'Ø§Ù„Ù‚ØµØµ',uz:'Al-Qasas',a:88,t:'Makka'},
  {n:29,ar:'Ø§Ù„Ø¹Ù†ÙƒØ¨ÙˆØª',uz:'Al-Ankabut',a:69,t:'Makka'},
  {n:30,ar:'Ø§Ù„Ø±ÙˆÙ…',uz:'Ar-Rum',a:60,t:'Makka'},
  {n:31,ar:'Ù„Ù‚Ù…Ø§Ù†',uz:'Luqmon',a:34,t:'Makka'},
  {n:32,ar:'Ø§Ù„Ø³Ø¬Ø¯Ø©',uz:'As-Sajda',a:30,t:'Makka'},
  {n:33,ar:'Ø§Ù„Ø£Ø­Ø²Ø§Ø¨',uz:'Al-Ahzob',a:73,t:'Madina'},
  {n:34,ar:'Ø³Ø¨Ø£',uz:'Saba',a:54,t:'Makka'},
  {n:35,ar:'ÙØ§Ø·Ø±',uz:'Fotir',a:45,t:'Makka'},
  {n:36,ar:'ÙŠØ³',uz:'Yo Sin',a:83,t:'Makka'},
  {n:37,ar:'Ø§Ù„ØµØ§ÙØ§Øª',uz:'As-Soffot',a:182,t:'Makka'},
  {n:38,ar:'Øµ',uz:'Sod',a:88,t:'Makka'},
  {n:39,ar:'Ø§Ù„Ø²Ù…Ø±',uz:'Az-Zumar',a:75,t:'Makka'},
  {n:40,ar:'ØºØ§ÙØ±',uz:"G'ofir",a:85,t:'Makka'},
  {n:41,ar:'ÙØµÙ„Øª',uz:'Fussilat',a:54,t:'Makka'},
  {n:42,ar:'Ø§Ù„Ø´ÙˆØ±Ù‰',uz:'Ash-Shura',a:53,t:'Makka'},
  {n:43,ar:'Ø§Ù„Ø²Ø®Ø±Ù',uz:'Az-Zukhruf',a:89,t:'Makka'},
  {n:44,ar:'Ø§Ù„Ø¯Ø®Ø§Ù†',uz:'Ad-Dukhan',a:59,t:'Makka'},
  {n:45,ar:'Ø§Ù„Ø¬Ø§Ø«ÙŠØ©',uz:'Al-Josiya',a:37,t:'Makka'},
  {n:46,ar:'Ø§Ù„Ø£Ø­Ù‚Ø§Ù',uz:'Al-Ahqof',a:35,t:'Makka'},
  {n:47,ar:'Ù…Ø­Ù…Ø¯',uz:'Muhammad',a:38,t:'Madina'},
  {n:48,ar:'Ø§Ù„ÙØªØ­',uz:'Al-Fath',a:29,t:'Madina'},
  {n:49,ar:'Ø§Ù„Ø­Ø¬Ø±Ø§Øª',uz:'Al-Hujurot',a:18,t:'Madina'},
  {n:50,ar:'Ù‚',uz:'Qof',a:45,t:'Makka'},
  {n:51,ar:'Ø§Ù„Ø°Ø§Ø±ÙŠØ§Øª',uz:'Az-Zoriyot',a:60,t:'Makka'},
  {n:52,ar:'Ø§Ù„Ø·ÙˆØ±',uz:'At-Tur',a:49,t:'Makka'},
  {n:53,ar:'Ø§Ù„Ù†Ø¬Ù…',uz:'An-Najm',a:62,t:'Makka'},
  {n:54,ar:'Ø§Ù„Ù‚Ù…Ø±',uz:'Al-Qamar',a:55,t:'Makka'},
  {n:55,ar:'Ø§Ù„Ø±Ø­Ù…Ù†',uz:'Ar-Rohman',a:78,t:'Madina'},
  {n:56,ar:'Ø§Ù„ÙˆØ§Ù‚Ø¹Ø©',uz:'Al-Voqia',a:96,t:'Makka'},
  {n:57,ar:'Ø§Ù„Ø­Ø¯ÙŠØ¯',uz:'Al-Hadid',a:29,t:'Madina'},
  {n:58,ar:'Ø§Ù„Ù…Ø¬Ø§Ø¯Ù„Ø©',uz:'Al-Mujodala',a:22,t:'Madina'},
  {n:59,ar:'Ø§Ù„Ø­Ø´Ø±',uz:'Al-Hashr',a:24,t:'Madina'},
  {n:60,ar:'Ø§Ù„Ù…Ù…ØªØ­Ù†Ø©',uz:'Al-Mumtahana',a:13,t:'Madina'},
  {n:61,ar:'Ø§Ù„ØµÙ',uz:'As-Saff',a:14,t:'Madina'},
  {n:62,ar:'Ø§Ù„Ø¬Ù…Ø¹Ø©',uz:"Al-Jum'a",a:11,t:'Madina'},
  {n:63,ar:'Ø§Ù„Ù…Ù†Ø§ÙÙ‚ÙˆÙ†',uz:'Al-Munofiqun',a:11,t:'Madina'},
  {n:64,ar:'Ø§Ù„ØªØºØ§Ø¨Ù†',uz:'At-Taghabun',a:18,t:'Madina'},
  {n:65,ar:'Ø§Ù„Ø·Ù„Ø§Ù‚',uz:'At-Talaq',a:12,t:'Madina'},
  {n:66,ar:'Ø§Ù„ØªØ­Ø±ÙŠÙ…',uz:'At-Tahrim',a:12,t:'Madina'},
  {n:67,ar:'Ø§Ù„Ù…Ù„Ùƒ',uz:'Al-Mulk',a:30,t:'Makka'},
  {n:68,ar:'Ø§Ù„Ù‚Ù„Ù…',uz:'Al-Qalam',a:52,t:'Makka'},
  {n:69,ar:'Ø§Ù„Ø­Ø§Ù‚Ø©',uz:'Al-Haqqa',a:52,t:'Makka'},
  {n:70,ar:'Ø§Ù„Ù…Ø¹Ø§Ø±Ø¬',uz:"Al-Ma'orij",a:44,t:'Makka'},
  {n:71,ar:'Ù†ÙˆØ­',uz:'Nuh',a:28,t:'Makka'},
  {n:72,ar:'Ø§Ù„Ø¬Ù†',uz:'Al-Jin',a:28,t:'Makka'},
  {n:73,ar:'Ø§Ù„Ù…Ø²Ù…Ù„',uz:'Al-Muzzammil',a:20,t:'Makka'},
  {n:74,ar:'Ø§Ù„Ù…Ø¯Ø«Ø±',uz:'Al-Muddaththir',a:56,t:'Makka'},
  {n:75,ar:'Ø§Ù„Ù‚ÙŠØ§Ù…Ø©',uz:'Al-Qiyoma',a:40,t:'Makka'},
  {n:76,ar:'Ø§Ù„Ø¥Ù†Ø³Ø§Ù†',uz:'Al-Inson',a:31,t:'Madina'},
  {n:77,ar:'Ø§Ù„Ù…Ø±Ø³Ù„Ø§Øª',uz:'Al-Mursalot',a:50,t:'Makka'},
  {n:78,ar:'Ø§Ù„Ù†Ø¨Ø£',uz:'An-Naba',a:40,t:'Makka'},
  {n:79,ar:'Ø§Ù„Ù†Ø§Ø²Ø¹Ø§Øª',uz:"An-Nozi'ot",a:46,t:'Makka'},
  {n:80,ar:'Ø¹Ø¨Ø³',uz:'Abasa',a:42,t:'Makka'},
  {n:81,ar:'Ø§Ù„ØªÙƒÙˆÙŠØ±',uz:'At-Takwir',a:29,t:'Makka'},
  {n:82,ar:'Ø§Ù„Ø§Ù†ÙØ·Ø§Ø±',uz:'Al-Infitor',a:19,t:'Makka'},
  {n:83,ar:'Ø§Ù„Ù…Ø·ÙÙÙŠÙ†',uz:'Al-Mutaffifin',a:36,t:'Makka'},
  {n:84,ar:'Ø§Ù„Ø§Ù†Ø´Ù‚Ø§Ù‚',uz:'Al-Inshiqoq',a:25,t:'Makka'},
  {n:85,ar:'Ø§Ù„Ø¨Ø±ÙˆØ¬',uz:'Al-Buruj',a:22,t:'Makka'},
  {n:86,ar:'Ø§Ù„Ø·Ø§Ø±Ù‚',uz:'At-Toriq',a:17,t:'Makka'},
  {n:87,ar:'Ø§Ù„Ø£Ø¹Ù„Ù‰',uz:"Al-A'lo",a:19,t:'Makka'},
  {n:88,ar:'Ø§Ù„ØºØ§Ø´ÙŠØ©',uz:"Al-G'oshiya",a:26,t:'Makka'},
  {n:89,ar:'Ø§Ù„ÙØ¬Ø±',uz:'Al-Fajr',a:30,t:'Makka'},
  {n:90,ar:'Ø§Ù„Ø¨Ù„Ø¯',uz:'Al-Balad',a:20,t:'Makka'},
  {n:91,ar:'Ø§Ù„Ø´Ù…Ø³',uz:'Ash-Shams',a:15,t:'Makka'},
  {n:92,ar:'Ø§Ù„Ù„ÙŠÙ„',uz:'Al-Layl',a:21,t:'Makka'},
  {n:93,ar:'Ø§Ù„Ø¶Ø­Ù‰',uz:'Ad-Duho',a:11,t:'Makka'},
  {n:94,ar:'Ø§Ù„Ø´Ø±Ø­',uz:'Ash-Sharh',a:8,t:'Makka'},
  {n:95,ar:'Ø§Ù„ØªÙŠÙ†',uz:'At-Tin',a:8,t:'Makka'},
  {n:96,ar:'Ø§Ù„Ø¹Ù„Ù‚',uz:'Al-Alaq',a:19,t:'Makka'},
  {n:97,ar:'Ø§Ù„Ù‚Ø¯Ø±',uz:'Al-Qadr',a:5,t:'Makka'},
  {n:98,ar:'Ø§Ù„Ø¨ÙŠÙ†Ø©',uz:'Al-Bayyina',a:8,t:'Madina'},
  {n:99,ar:'Ø§Ù„Ø²Ù„Ø²Ù„Ø©',uz:'Az-Zalzala',a:8,t:'Madina'},
  {n:100,ar:'Ø§Ù„Ø¹Ø§Ø¯ÙŠØ§Øª',uz:'Al-Odiyot',a:11,t:'Makka'},
  {n:101,ar:'Ø§Ù„Ù‚Ø§Ø±Ø¹Ø©',uz:"Al-Qori'a",a:11,t:'Makka'},
  {n:102,ar:'Ø§Ù„ØªÙƒØ§Ø«Ø±',uz:'At-Takosur',a:8,t:'Makka'},
  {n:103,ar:'Ø§Ù„Ø¹ØµØ±',uz:'Al-Asr',a:3,t:'Makka'},
  {n:104,ar:'Ø§Ù„Ù‡Ù…Ø²Ø©',uz:'Al-Humaza',a:9,t:'Makka'},
  {n:105,ar:'Ø§Ù„ÙÙŠÙ„',uz:'Al-Fil',a:5,t:'Makka'},
  {n:106,ar:'Ù‚Ø±ÙŠØ´',uz:'Quraysh',a:4,t:'Makka'},
  {n:107,ar:'Ø§Ù„Ù…Ø§Ø¹ÙˆÙ†',uz:"Al-Mo'un",a:7,t:'Makka'},
  {n:108,ar:'Ø§Ù„ÙƒÙˆØ«Ø±',uz:'Al-Kavshar',a:3,t:'Makka'},
  {n:109,ar:'Ø§Ù„ÙƒØ§ÙØ±ÙˆÙ†',uz:'Al-Kofirun',a:6,t:'Makka'},
  {n:110,ar:'Ø§Ù„Ù†ØµØ±',uz:'An-Nasr',a:3,t:'Madina'},
  {n:111,ar:'Ø§Ù„Ù…Ø³Ø¯',uz:'Al-Masad',a:5,t:'Makka'},
  {n:112,ar:'Ø§Ù„Ø¥Ø®Ù„Ø§Øµ',uz:'Al-Ikhlos',a:4,t:'Makka'},
  {n:113,ar:'Ø§Ù„ÙÙ„Ù‚',uz:'Al-Falaq',a:5,t:'Makka'},
  {n:114,ar:'Ø§Ù„Ù†Ø§Ø³',uz:'An-Nos',a:6,t:'Makka'},
];

// Audio state
const au=document.getElementById('au');
let reciter=0, curIdx=null, playing=false;
let filtered=[...SURAHS];

// Audio URL â€” mp3quran.net format: 001.mp3, 002.mp3 ...
function audioUrl(surahNum){
  const num=String(surahNum).padStart(3,'0');
  return `${RECITERS[reciter].base}${num}.mp3`;
}

// Build reciter tabs
function buildRec(){
  const row=document.getElementById('rcrow');
  row.innerHTML='';
  RECITERS.forEach((r,i)=>{
    const b=document.createElement('button');
    b.className='rchip'+(i===0?' on':'');
    b.textContent=r.name;
    b.onclick=()=>{
      reciter=i;
      document.querySelectorAll('.rchip').forEach((c,j)=>c.classList.toggle('on',j===i));
      if(curIdx!==null) loadSurah(curIdx, playing);
    };
    row.appendChild(b);
  });
}

// Render list
function renderList(list){
  const el=document.getElementById('slist');
  if(!list.length){el.innerHTML='<div class="nores">ğŸ” Hech narsa topilmadi</div>';return;}
  el.innerHTML='';
  list.forEach(s=>{
    const d=document.createElement('div');
    const idx=s.n-1;
    const isCur=curIdx===idx;
    d.className='si2'+(isCur?' pl':'');
    d.innerHTML=`
      <div class="sno">${s.n}</div>
      <div class="sinf">
        <div class="sar">${s.ar}</div>
        <div class="suz">${s.uz}</div>
      </div>
      <div class="smeta">${s.a} oyat<br><small>${s.t}</small></div>
      <div class="pbtn">${isCur&&playing?'â¸':'â–¶'}</div>`;
    d.onclick=()=>{
      if(curIdx===idx){togglePlay();}
      else{loadSurah(idx,true);}
    };
    el.appendChild(d);
  });
}

function doFilter(){
  const q=document.getElementById('srch').value.toLowerCase().trim();
  filtered=q?SURAHS.filter(s=>s.uz.toLowerCase().includes(q)||s.ar.includes(q)||String(s.n).includes(q)):[...SURAHS];
  renderList(filtered);
}

function fmt(s){
  if(isNaN(s)||!isFinite(s)) return'0:00';
  return `${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`;
}

function setPlayerInfo(s){
  document.getElementById('ptit').textContent=`${s.n}. ${s.ar} â€” ${s.uz}`;
  document.getElementById('prec').textContent=RECITERS[reciter].name;
}

function setPpBtn(state){
  // state: 'play' | 'pause' | 'loading'
  const b=document.getElementById('ppbtn');
  b.textContent=state==='pause'?'â¸':state==='loading'?'â³':'â–¶';
}

function loadSurah(idx, autoPlay){
  curIdx=idx;
  const s=SURAHS[idx];
  setPlayerInfo(s);
  document.getElementById('player').classList.add('vis');
  document.getElementById('pfil').style.width='0%';
  document.getElementById('tc').textContent='0:00';
  document.getElementById('td').textContent='0:00';
  setPpBtn('loading');

  au.pause();
  au.src=audioUrl(s.n);
  au.load();

  if(autoPlay){
    const p=au.play();
    if(p && p.catch) p.catch(err=>{
      console.warn('play error',err);
      setPpBtn('play');
      playing=false;
    });
  } else {
    setPpBtn('play');
  }
  renderList(filtered);
}

function togglePlay(){
  if(curIdx===null) return;
  if(playing){
    au.pause();
  } else {
    const p=au.play();
    if(p && p.catch) p.catch(e=>console.warn(e));
  }
}

function moveSurah(d){
  if(curIdx===null) return;
  const next=(curIdx+d+SURAHS.length)%SURAHS.length;
  loadSurah(next,true);
}

function closePlayer(){
  au.pause();
  playing=false; curIdx=null;
  document.getElementById('player').classList.remove('vis');
  renderList(filtered);
}

function seek(e){
  if(!au.duration) return;
  const r=document.getElementById('pbar').getBoundingClientRect();
  au.currentTime=((e.clientX-r.left)/r.width)*au.duration;
}

// Audio events
au.addEventListener('playing',()=>{playing=true;setPpBtn('pause');renderList(filtered);});
au.addEventListener('pause',()=>{playing=false;setPpBtn('play');renderList(filtered);});
au.addEventListener('ended',()=>moveSurah(1));
au.addEventListener('waiting',()=>setPpBtn('loading'));
au.addEventListener('canplay',()=>{ if(playing) setPpBtn('pause'); });
au.addEventListener('timeupdate',()=>{
  if(!au.duration) return;
  document.getElementById('pfil').style.width=(au.currentTime/au.duration*100)+'%';
  document.getElementById('tc').textContent=fmt(au.currentTime);
});
au.addEventListener('durationchange',()=>{
  document.getElementById('td').textContent=fmt(au.duration);
});
au.addEventListener('error',()=>{
  setPpBtn('play'); playing=false;
  document.getElementById('td').textContent='Xato';
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
buildRec();
renderList(SURAHS);

if(window.Telegram&&window.Telegram.WebApp){
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();
}

// Auto-start compass on page load
window.addEventListener('load',()=>setTimeout(initCompass,400));
</script>
</body>
</html>
