<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Islomiy Ilova</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Tajawal:wght@400;500;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --g:#1db954;--gd:#158f3e;--gold:#d4a843;
  --bg:#04101e;--s1:#0b1e35;--s2:#102840;--s3:#163450;
  --bdr:rgba(29,185,84,0.18);--tx:#e8f4fd;--mt:#567a96;
  --gw:rgba(29,185,84,0.45);
  --red:#ff4d4d;
}
html,body{height:100%;overflow:hidden;}
body{font-family:'Tajawal',sans-serif;background:var(--bg);color:var(--tx);display:flex;flex-direction:column;height:100dvh;}

/* NAV */
.nav{display:flex;background:var(--s1);border-bottom:1px solid var(--bdr);flex-shrink:0;z-index:50;}
.nb{flex:1;padding:13px 8px 11px;border:none;background:transparent;color:var(--mt);
  font-family:'Tajawal',sans-serif;font-size:12px;font-weight:600;cursor:pointer;
  display:flex;flex-direction:column;align-items:center;gap:3px;position:relative;transition:color .2s;}
.nb .ni{font-size:22px;}
.nb.on{color:var(--g);}
.nb::after{content:'';position:absolute;bottom:0;left:25%;right:25%;height:2px;border-radius:2px 2px 0 0;
  background:var(--g);transform:scaleX(0);transition:transform .2s;}
.nb.on::after{transform:scaleX(1);}

/* PAGES */
.pages{flex:1;position:relative;overflow:hidden;}
.pg{position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;
  opacity:0;pointer-events:none;transition:opacity .2s;}
.pg.on{opacity:1;pointer-events:all;}
.pg::-webkit-scrollbar{width:3px;}
.pg::-webkit-scrollbar-thumb{background:var(--s3);border-radius:3px;}

/* QIBLA */
.qp{display:flex;flex-direction:column;align-items:center;padding:16px 16px 26px;gap:12px;}
.ptitle{font-family:'Amiri',serif;font-size:22px;color:var(--gold);text-align:center;
  text-shadow:0 0 18px rgba(212,168,67,.4);}
.ptitle small{display:block;font-family:'Tajawal',sans-serif;font-size:11px;color:var(--mt);margin-top:2px;letter-spacing:1px;}

.cwrap{position:relative;width:270px;height:270px;flex-shrink:0;}
.oring{position:absolute;inset:0;border-radius:50%;padding:6px;
  background:conic-gradient(from 0deg,#1a3a5c,#0b1e35,#1a3a5c,#0b1e35,#1a3a5c);
  box-shadow:0 0 20px rgba(0,0,0,.7),inset 0 0 15px rgba(0,0,0,.5);
  transition:background .35s,box-shadow .35s;}
.oring.ok{
  background:conic-gradient(from 0deg,var(--g),#0e7a30,var(--g),#0e7a30,var(--g));
  box-shadow:0 0 55px var(--gw),0 0 110px rgba(29,185,84,.22);
  animation:pr 1.2s ease-in-out infinite alternate;
}
@keyframes pr{from{box-shadow:0 0 30px var(--gw),0 0 60px rgba(29,185,84,.2);}
  to{box-shadow:0 0 65px var(--gw),0 0 120px rgba(29,185,84,.28);} }

.cdial{position:absolute;inset:6px;border-radius:50%;
  background:radial-gradient(ellipse at 35% 30%,#1b3860,#061528 75%);
  overflow:hidden;will-change:transform;}
.dsvg{position:absolute;inset:0;width:100%;height:100%;}
.alayer{position:absolute;inset:6px;border-radius:50%;pointer-events:none;}
.asvg{position:absolute;inset:0;width:100%;height:100%;}
.ck{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:48px;height:48px;background:radial-gradient(#1a5030,#091e12);
  border-radius:50%;border:2.5px solid var(--gold);
  display:flex;align-items:center;justify-content:center;font-size:23px;z-index:20;
  box-shadow:0 0 14px rgba(212,168,67,.3);}

.dcard{background:linear-gradient(135deg,var(--s1),var(--s2));border:1.5px solid var(--bdr);
  border-radius:16px;padding:12px 20px;text-align:center;width:100%;position:relative;overflow:hidden;}
.dcard::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,var(--g),transparent);}
.dnum{font-size:40px;font-weight:800;line-height:1;color:var(--tx);}
.dnum b{color:var(--g);}
.ddir{font-size:11px;color:var(--mt);margin-top:5px;letter-spacing:1px;text-transform:uppercase;}

.spill{display:inline-flex;align-items:center;gap:7px;padding:7px 16px;border-radius:30px;
  font-size:13px;font-weight:700;background:var(--s1);border:1.5px solid rgba(29,185,84,.2);
  color:var(--mt);transition:all .25s;}
.spill.ok{background:rgba(29,185,84,.12);border-color:var(--g);color:var(--g);}
.sdot{width:9px;height:9px;border-radius:50%;background:var(--mt);transition:background .25s;}
.spill.ok .sdot{background:var(--g);box-shadow:0 0 6px var(--g);animation:bk 1s infinite;}
@keyframes bk{0%,100%{opacity:1;}50%{opacity:.3;}}

.atxt{font-family:'Amiri',serif;font-size:16px;color:var(--gold);text-align:center;
  text-shadow:0 0 12px rgba(212,168,67,.4);opacity:0;transition:opacity .35s;
  overflow:hidden;max-height:0;}
.atxt.show{opacity:1;max-height:34px;}

.lbox{display:flex;align-items:center;gap:10px;background:rgba(11,30,53,.7);
  border:1px solid rgba(90,138,170,.15);border-radius:12px;padding:10px 14px;width:100%;
  font-size:12px;color:var(--mt);}
.lbox strong{color:var(--tx);font-size:13px;display:block;}

.sbtn{background:linear-gradient(135deg,var(--gd),var(--g));border:none;border-radius:14px;
  padding:13px;color:#fff;font-family:'Tajawal',sans-serif;font-size:15px;font-weight:800;
  cursor:pointer;width:100%;box-shadow:0 4px 18px var(--gw);transition:transform .15s;}
.sbtn:active{transform:scale(.97);}
.info{font-size:11px;color:var(--mt);text-align:center;line-height:1.6;}
.warn{font-size:11px;color:rgba(255,255,255,.6);text-align:center;line-height:1.5;}
.warn b{color:var(--red);}

/* QURAN */
.qrp{display:flex;flex-direction:column;}
.qhdr{padding:13px 13px 9px;background:var(--s1);border-bottom:1px solid var(--bdr);
  position:sticky;top:0;z-index:10;flex-shrink:0;}
.qhdr h2{font-family:'Amiri',serif;font-size:20px;color:var(--gold);
  text-shadow:0 0 12px rgba(212,168,67,.3);text-align:center;margin-bottom:8px;}
.sbox{position:relative;}
.sbox input{width:100%;background:var(--s2);border:1.5px solid var(--bdr);border-radius:10px;
  padding:9px 12px 9px 36px;color:var(--tx);font-family:'Tajawal',sans-serif;font-size:13px;
  outline:none;transition:border-color .2s;}
.sbox input:focus{border-color:var(--g);}
.sbox input::placeholder{color:var(--mt);}
.si{position:absolute;left:11px;top:50%;transform:translateY(-50%);font-size:14px;pointer-events:none;}

.rcrow{display:flex;gap:6px;margin-top:8px;overflow-x:auto;padding-bottom:2px;}
.rcrow::-webkit-scrollbar{display:none;}
.rchip{flex-shrink:0;padding:5px 12px;border-radius:20px;border:1.5px solid var(--bdr);
  background:var(--s2);color:var(--mt);font-size:11px;cursor:pointer;
  transition:all .2s;font-family:'Tajawal',sans-serif;white-space:nowrap;}
.rchip.on{background:rgba(29,185,84,.15);border-color:var(--g);color:var(--g);}

.slist{padding:8px 10px 150px;}
.si2{display:flex;align-items:center;gap:10px;padding:10px 11px;border-radius:11px;
  background:var(--s1);border:1px solid var(--bdr);margin-bottom:5px;cursor:pointer;
  transition:background .15s,border-color .15s;position:relative;overflow:hidden;}
.si2.playing{background:rgba(29,185,84,.1);border-color:var(--g);}
.si2::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--g);
  transform:scaleY(0);transition:transform .2s;border-radius:0 2px 2px 0;}
.si2.playing::before{transform:scaleY(1);}
.sno{width:32px;height:32px;background:var(--s2);border-radius:8px;display:flex;align-items:center;
  justify-content:center;font-size:11px;font-weight:800;color:var(--g);flex-shrink:0;border:1px solid var(--bdr);}
.si2.playing .sno{background:var(--g);color:#fff;border-color:var(--g);}
.sinf{flex:1;min-width:0;}
.sar{font-family:'Amiri',serif;font-size:15px;color:var(--tx);}
.suz{font-size:10px;color:var(--mt);margin-top:1px;}
.smeta{font-size:10px;color:var(--mt);text-align:right;flex-shrink:0;line-height:1.5;}
.pbtn{width:32px;height:32px;border-radius:50%;background:var(--s2);border:1px solid var(--bdr);
  display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;}
.si2.playing .pbtn{background:var(--g);border-color:var(--g);color:#fff;}
.nores{text-align:center;padding:40px 20px;color:var(--mt);font-size:13px;}

/* PLAYER */
.player{position:fixed;bottom:0;left:0;right:0;
  background:linear-gradient(0deg,var(--s1) 0%,rgba(11,30,53,.98) 100%);
  border-top:1px solid var(--bdr);padding:10px 14px 20px;z-index:200;
  transform:translateY(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);
  box-shadow:0 -8px 30px rgba(0,0,0,.6);}
.player.vis{transform:translateY(0);}
.pinfo{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:8px;}
.ptit{font-family:'Amiri',serif;font-size:15px;color:var(--gold);}
.prec{font-size:10px;color:var(--mt);margin-top:1px;}
.pcls{background:none;border:none;color:var(--mt);font-size:18px;cursor:pointer;padding:2px 6px;}
.prow{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.ptm{font-size:11px;color:var(--mt);min-width:34px;font-variant-numeric:tabular-nums;}
.pbar{flex:1;height:5px;background:var(--s3);border-radius:5px;cursor:pointer;position:relative;}
.pfil{height:100%;background:var(--g);border-radius:5px;width:0%;pointer-events:none;transition:width .25s linear;}
.pctrls{display:flex;align-items:center;justify-content:center;gap:20px;}
.cbtn{background:none;border:none;color:var(--mt);font-size:22px;cursor:pointer;padding:4px;transition:color .15s;}
.cbtn:active{transform:scale(.95);}
.ppbtn{width:50px;height:50px;border-radius:50%;background:var(--g);border:none;
  display:flex;align-items:center;justify-content:center;font-size:20px;cursor:pointer;
  box-shadow:0 4px 15px var(--gw);transition:transform .1s;}
.ppbtn:active{transform:scale(.92);}
.perr{font-size:11px;color:var(--red);text-align:center;margin-top:4px;min-height:16px;}
</style>
</head>

<body>
<nav class="nav">
  <button class="nb on" id="nb0" onclick="goTab(0)"><span class="ni">üß≠</span><span>Qibla</span></button>
  <button class="nb" id="nb1" onclick="goTab(1)"><span class="ni">üìñ</span><span>Qur'on</span></button>
</nav>

<div class="pages">
  <!-- QIBLA -->
  <div class="pg qp on" id="pg0">
    <div class="ptitle">üïå Qibla Kompas<small>Makka al-Mukarrama yo'nalishi</small></div>

    <div class="cwrap">
      <div class="oring" id="oring"></div>

      <div class="cdial" id="cdial">
        <svg class="dsvg" viewBox="0 0 250 250" xmlns="http://www.w3.org/2000/svg">
          <g id="tks"></g>
          <text x="125" y="27" text-anchor="middle" font-family="Tajawal" font-weight="800" font-size="16" fill="#e74c3c">N</text>
          <text x="125" y="235" text-anchor="middle" font-family="Tajawal" font-weight="700" font-size="14" fill="#4a80a8">S</text>
          <text x="233" y="130" text-anchor="middle" dominant-baseline="middle" font-family="Tajawal" font-weight="700" font-size="14" fill="#4a80a8">E</text>
          <text x="17" y="130" text-anchor="middle" dominant-baseline="middle" font-family="Tajawal" font-weight="700" font-size="14" fill="#4a80a8">W</text>
        </svg>
      </div>

      <div class="alayer">
        <svg class="asvg" viewBox="0 0 250 250" xmlns="http://www.w3.org/2000/svg">
          <g id="arw">
            <polygon points="125,30 134,122 125,132 116,122" fill="rgba(0,0,0,.25)" transform="translate(2,2)"/>
            <polygon points="125,30 134,122 125,132 116,122" fill="#1db954"/>
            <polygon points="125,132 134,122 143,148 125,141 107,148 116,122" fill="#158f3e"/>
            <polygon points="125,30 132,70 118,70" fill="rgba(255,255,255,.3)"/>
            <circle cx="125" cy="125" r="5" fill="rgba(29,185,84,.5)"/>
            <text x="125" y="168" text-anchor="middle" font-family="Tajawal" font-size="10" font-weight="800" fill="#1db954">QIBLA</text>
          </g>
        </svg>
      </div>

      <div class="ck">üïã</div>
    </div>

    <div class="dcard">
      <div class="dnum"><b id="dv">--</b>¬∞</div>
      <div class="ddir" id="dd">Yo'nalish aniqlanmoqda...</div>
    </div>

    <div class="spill" id="sp">
      <div class="sdot"></div>
      <span id="stxt">Kompasni ishga tushirish uchun tugmani bosing</span>
    </div>

    <div class="atxt" id="at">üåø Allahu Akbar! Qibla topildi üåø</div>

    <div class="lbox">
      <span>üìç</span>
      <div><strong id="ln">Joylashuv aniqlanmoqda...</strong><span id="lc"></span></div>
    </div>

    <button class="sbtn" id="sbtn" onclick="initCompass()">üß≠ Kompasni Ishga Tushirish</button>
    <p class="warn">iPhone bo‚Äòlsa: ruxsat chiqsa <b>Allow</b> bosing. Kompas shundan keyin ishlaydi.</p>

    <p class="info">GPS + kompas sensori orqali Qibla yo'nalishini aniqlaydi.<br>Telefonni tekis ushlab turing.</p>
  </div>

  <!-- QURAN -->
  <div class="pg qrp" id="pg1">
    <div class="qhdr">
      <h2>üìñ Qur'oni Karim</h2>
      <div class="sbox">
        <span class="si">üîç</span>
        <input id="srch" type="text" placeholder="Sura nomi yoki raqami..." oninput="doFilter()">
      </div>
      <div class="rcrow" id="rcrow"></div>
    </div>
    <div class="slist" id="slist"></div>
  </div>
</div>

<!-- PLAYER -->
<div class="player" id="player">
  <div class="pinfo">
    <div>
      <div class="ptit" id="ptit">‚Äî</div>
      <div class="prec" id="prec">‚Äî</div>
    </div>
    <button class="pcls" onclick="closePlayer()">‚úï</button>
  </div>

  <div class="prow">
    <span class="ptm" id="tc">0:00</span>
    <div class="pbar" id="pbar" onclick="seek(event)"><div class="pfil" id="pfil"></div></div>
    <span class="ptm" id="td">0:00</span>
  </div>

  <div class="pctrls">
    <button class="cbtn" onclick="moveSurah(-1)">‚èÆ</button>
    <button class="ppbtn" id="ppbtn" onclick="togglePlay()">‚ñ∂</button>
    <button class="cbtn" onclick="moveSurah(1)">‚è≠</button>
  </div>

  <div class="perr" id="perr"></div>
</div>

<audio id="au" preload="none"></audio>

<script>
'use strict';

// ===== Telegram WebApp init =====
if (window.Telegram && window.Telegram.WebApp) {
  Telegram.WebApp.ready();
  Telegram.WebApp.expand();
}

// ===== Tabs =====
function goTab(i){
  [0,1].forEach(j=>{
    document.getElementById('nb'+j).classList.toggle('on', j===i);
    document.getElementById('pg'+j).classList.toggle('on', j===i);
  });
}

// ===== QIBLA COMPASS =====
const KAABA = { lat: 21.4225, lng: 39.8262 };

let qBearing=null;

let deviceHeading=0;     // smoothed
let targetHeading=0;     // raw
let gotHeading=false;    // 0¬∞ ham valid
let aligned=false;

let rafId=null;
let hasAbsolute=false;
let simInterval=null;
let compassStarted=false;

// Draw ticks once
(function(){
  const g=document.getElementById('tks');
  const cx=125, cy=125, r=110;
  for(let i=0;i<360;i+=5){
    const a=(i-90)*Math.PI/180;
    const maj=i%90===0, med=i%45===0, sm=i%15===0;
    const len=maj?14:med?10:sm?6:4;
    const col=maj?'#4a90d9':med?'#2a6090':sm?'#1a4060':'#0f2e40';
    const l=document.createElementNS('http://www.w3.org/2000/svg','line');
    l.setAttribute('x1',cx+r*Math.cos(a));
    l.setAttribute('y1',cy+r*Math.sin(a));
    l.setAttribute('x2',cx+(r-len)*Math.cos(a));
    l.setAttribute('y2',cy+(r-len)*Math.sin(a));
    l.setAttribute('stroke',col);
    l.setAttribute('stroke-width',maj?'2.5':'1');
    g.appendChild(l);
  }
})();

function calcBearing(la1,lo1,la2,lo2){
  const R=d=>d*Math.PI/180;
  const y=Math.sin(R(lo2-lo1))*Math.cos(R(la2));
  const x=Math.cos(R(la1))*Math.sin(R(la2))-Math.sin(R(la1))*Math.cos(R(la2))*Math.cos(R(lo2-lo1));
  return (Math.atan2(y,x)*180/Math.PI + 360) % 360;
}
function dirName(d){
  return ['Shimol (N)','Shimoli-sharq','Sharq (E)','Janubi-sharq',
          'Janub (S)',"Janubi-g'arb","G'arb (W)","Shimoli-g'arb"][Math.round(d/45)%8];
}
function setStatus(text){ document.getElementById('stxt').textContent=text; }

function setLocation(la,lo,label){
  qBearing = calcBearing(la,lo,KAABA.lat,KAABA.lng);
  document.getElementById('ln').textContent=label;
  document.getElementById('lc').textContent=`Qibla: ${Math.round(qBearing)}¬∞ ‚Äî ${dirName(qBearing)}`;
  document.getElementById('dv').textContent=Math.round(qBearing);
  document.getElementById('dd').textContent=dirName(qBearing);
}

function getGPS(){
  setStatus('GPS aniqlanmoqda...');
  if(!navigator.geolocation){
    setLocation(41.2995,69.2401,'Toshkent (taxminiy)');
    return;
  }
  navigator.geolocation.getCurrentPosition(
    pos=>{
      const la=pos.coords.latitude, lo=pos.coords.longitude;
      setLocation(la,lo,`${la.toFixed(3)}¬∞, ${lo.toFixed(3)}¬∞`);
      fetch(`https://nominatim.openstreetmap.org/reverse?lat=${la}&lon=${lo}&format=json`)
        .then(r=>r.json())
        .then(d=>{
          const c=d.address?.city||d.address?.town||d.address?.village||'';
          const co=d.address?.country||'';
          if(c||co) document.getElementById('ln').textContent = c+(c&&co?', ':'')+co;
        }).catch(()=>{});
    },
    ()=>setLocation(41.2995,69.2401,'Toshkent (taxminiy)'),
    {timeout:12000, maximumAge:60000, enableHighAccuracy:true}
  );
}

function onAbsolute(e){
  hasAbsolute=true;
  if(e.alpha!=null){
    targetHeading=(360-e.alpha)%360;
    gotHeading=true;
  }
}
function onRelative(e){
  if(hasAbsolute) return;
  if(e.webkitCompassHeading!=null){
    targetHeading=e.webkitCompassHeading;
    gotHeading=true;
  } else if(e.alpha!=null){
    targetHeading=(360-e.alpha)%360;
    gotHeading=true;
  }
}

function startSim(){
  setStatus('‚ö†Ô∏è Sensor topilmadi ‚Äî demo rejim');
  let a=0;
  simInterval=setInterval(()=>{ a=(a+0.9)%360; targetHeading=a; gotHeading=true; },30);
}

function smoothLoop(){
  if(gotHeading){
    let diff=targetHeading-deviceHeading;
    if(diff>180) diff-=360;
    if(diff<-180) diff+=360;
    deviceHeading=(deviceHeading+diff*0.12+360)%360;
  }
  applyCompass();
  rafId=requestAnimationFrame(smoothLoop);
}

function applyCompass(){
  if(qBearing===null) return;

  const arrowAngle=qBearing-deviceHeading;
  document.getElementById('arw').setAttribute('transform',`rotate(${arrowAngle},125,125)`);
  document.getElementById('cdial').style.transform=`rotate(${-deviceHeading}deg)`;

  const norm=((arrowAngle%360)+360)%360;
  const diff=Math.min(norm, 360-norm);
  const nowOk = gotHeading && diff < 7;

  if(nowOk!==aligned){
    aligned=nowOk;
    document.getElementById('oring').classList.toggle('ok', nowOk);
    document.getElementById('sp').classList.toggle('ok', nowOk);
    setStatus(nowOk ? '‚úÖ Qibla topildi!' : 'Qiblani izlang...');
    document.getElementById('at').classList.toggle('show', nowOk);
  }
}

async function initCompass(){
  if(compassStarted) return;
  compassStarted=true;

  const btn=document.getElementById('sbtn');
  btn.disabled=true;
  btn.textContent='‚è≥ Ishga tushmoqda...';

  getGPS();
  rafId=requestAnimationFrame(smoothLoop);

  const listen=()=>{
    window.addEventListener('deviceorientationabsolute', onAbsolute, true);
    window.addEventListener('deviceorientation', onRelative, true);
    setStatus('Kompas faol (telefonni sekin aylantiring)');
    setTimeout(()=>{ if(!gotHeading) startSim(); }, 4500);
  };

  try{
    if(typeof DeviceOrientationEvent!=='undefined' &&
       typeof DeviceOrientationEvent.requestPermission==='function'){
      const s=await DeviceOrientationEvent.requestPermission();
      if(s==='granted') listen(); else startSim();
    } else {
      listen();
    }
  } catch(e){
    startSim();
  }

  btn.style.display='none';
}

// ===== QURAN AUDIO =====
const RECITERS=[
  { name:'Mishary Alafasy', urls:[
      n=>`https://download.quranicaudio.com/quran/mishaari_raashid_al_3afaasee/${pad3(n)}.mp3`,
      n=>`https://server8.mp3quran.net/afs/${pad3(n)}.mp3`,
  ]},
  { name:'Abdurrahman Sudais', urls:[
      n=>`https://download.quranicaudio.com/quran/abdurrahmaan_as-sudays/${pad3(n)}.mp3`,
      n=>`https://server11.mp3quran.net/sds/${pad3(n)}.mp3`,
  ]},
  { name:'Husary', urls:[
      n=>`https://download.quranicaudio.com/quran/mahmood_khaleel_al-husaree/${pad3(n)}.mp3`,
      n=>`https://server13.mp3quran.net/husr/${pad3(n)}.mp3`,
  ]},
  { name:'Saad Al-Ghamdi', urls:[
      n=>`https://download.quranicaudio.com/quran/saad_al-ghaamidi/${pad3(n)}.mp3`,
      n=>`https://server7.mp3quran.net/s_gmd/${pad3(n)}.mp3`,
  ]},
];
function pad3(n){ return String(n).padStart(3,'0'); }

// ===== FULL 114 SURA LIST (your list, complete) =====
const SURAHS=[
  {n:1,ar:'ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©',uz:'Al-Fotiha',a:7,t:'Makka'},
  {n:2,ar:'ÿßŸÑÿ®ŸÇÿ±ÿ©',uz:'Al-Baqara',a:286,t:'Madina'},
  {n:3,ar:'ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ',uz:'Ali Imron',a:200,t:'Madina'},
  {n:4,ar:'ÿßŸÑŸÜÿ≥ÿßÿ°',uz:'An-Niso',a:176,t:'Madina'},
  {n:5,ar:'ÿßŸÑŸÖÿßÿ¶ÿØÿ©',uz:'Al-Moida',a:120,t:'Madina'},
  {n:6,ar:'ÿßŸÑÿ£ŸÜÿπÿßŸÖ',uz:"Al-An'om",a:165,t:'Makka'},
  {n:7,ar:'ÿßŸÑÿ£ÿπÿ±ÿßŸÅ',uz:"Al-A'rof",a:206,t:'Makka'},
  {n:8,ar:'ÿßŸÑÿ£ŸÜŸÅÿßŸÑ',uz:'Al-Anfol',a:75,t:'Madina'},
  {n:9,ar:'ÿßŸÑÿ™Ÿàÿ®ÿ©',uz:'At-Tavba',a:129,t:'Madina'},
  {n:10,ar:'ŸäŸàŸÜÿ≥',uz:'Yunus',a:109,t:'Makka'},
  {n:11,ar:'ŸáŸàÿØ',uz:'Hud',a:123,t:'Makka'},
  {n:12,ar:'ŸäŸàÿ≥ŸÅ',uz:'Yusuf',a:111,t:'Makka'},
  {n:13,ar:'ÿßŸÑÿ±ÿπÿØ',uz:"Ar-Ra'd",a:43,t:'Madina'},
  {n:14,ar:'ÿ•ÿ®ÿ±ÿßŸáŸäŸÖ',uz:'Ibrohim',a:52,t:'Makka'},
  {n:15,ar:'ÿßŸÑÿ≠ÿ¨ÿ±',uz:'Al-Hijr',a:99,t:'Makka'},
  {n:16,ar:'ÿßŸÑŸÜÿ≠ŸÑ',uz:'An-Nahl',a:128,t:'Makka'},
  {n:17,ar:'ÿßŸÑÿ•ÿ≥ÿ±ÿßÿ°',uz:'Al-Isro',a:111,t:'Makka'},
  {n:18,ar:'ÿßŸÑŸÉŸáŸÅ',uz:'Al-Kahf',a:110,t:'Makka'},
  {n:19,ar:'ŸÖÿ±ŸäŸÖ',uz:'Maryam',a:98,t:'Makka'},
  {n:20,ar:'ÿ∑Ÿá',uz:'To Ha',a:135,t:'Makka'},
  {n:21,ar:'ÿßŸÑÿ£ŸÜÿ®Ÿäÿßÿ°',uz:'Al-Anbiyo',a:112,t:'Makka'},
  {n:22,ar:'ÿßŸÑÿ≠ÿ¨',uz:'Al-Haj',a:78,t:'Madina'},
  {n:23,ar:'ÿßŸÑŸÖÿ§ŸÖŸÜŸàŸÜ',uz:"Al-Mo'minun",a:118,t:'Makka'},
  {n:24,ar:'ÿßŸÑŸÜŸàÿ±',uz:'An-Nur',a:64,t:'Madina'},
  {n:25,ar:'ÿßŸÑŸÅÿ±ŸÇÿßŸÜ',uz:'Al-Furqon',a:77,t:'Makka'},
  {n:26,ar:'ÿßŸÑÿ¥ÿπÿ±ÿßÿ°',uz:"Ash-Shu'aro",a:227,t:'Makka'},
  {n:27,ar:'ÿßŸÑŸÜŸÖŸÑ',uz:'An-Naml',a:93,t:'Makka'},
  {n:28,ar:'ÿßŸÑŸÇÿµÿµ',uz:'Al-Qasas',a:88,t:'Makka'},
  {n:29,ar:'ÿßŸÑÿπŸÜŸÉÿ®Ÿàÿ™',uz:'Al-Ankabut',a:69,t:'Makka'},
  {n:30,ar:'ÿßŸÑÿ±ŸàŸÖ',uz:'Ar-Rum',a:60,t:'Makka'},
  {n:31,ar:'ŸÑŸÇŸÖÿßŸÜ',uz:'Luqmon',a:34,t:'Makka'},
  {n:32,ar:'ÿßŸÑÿ≥ÿ¨ÿØÿ©',uz:'As-Sajda',a:30,t:'Makka'},
  {n:33,ar:'ÿßŸÑÿ£ÿ≠ÿ≤ÿßÿ®',uz:'Al-Ahzob',a:73,t:'Madina'},
  {n:34,ar:'ÿ≥ÿ®ÿ£',uz:'Saba',a:54,t:'Makka'},
  {n:35,ar:'ŸÅÿßÿ∑ÿ±',uz:'Fotir',a:45,t:'Makka'},
  {n:36,ar:'Ÿäÿ≥',uz:'Yo Sin',a:83,t:'Makka'},
  {n:37,ar:'ÿßŸÑÿµÿßŸÅÿßÿ™',uz:'As-Soffot',a:182,t:'Makka'},
  {n:38,ar:'ÿµ',uz:'Sod',a:88,t:'Makka'},
  {n:39,ar:'ÿßŸÑÿ≤ŸÖÿ±',uz:'Az-Zumar',a:75,t:'Makka'},
  {n:40,ar:'ÿ∫ÿßŸÅÿ±',uz:"G'ofir",a:85,t:'Makka'},
  {n:41,ar:'ŸÅÿµŸÑÿ™',uz:'Fussilat',a:54,t:'Makka'},
  {n:42,ar:'ÿßŸÑÿ¥Ÿàÿ±Ÿâ',uz:'Ash-Shura',a:53,t:'Makka'},
  {n:43,ar:'ÿßŸÑÿ≤ÿÆÿ±ŸÅ',uz:'Az-Zukhruf',a:89,t:'Makka'},
  {n:44,ar:'ÿßŸÑÿØÿÆÿßŸÜ',uz:'Ad-Dukhan',a:59,t:'Makka'},
  {n:45,ar:'ÿßŸÑÿ¨ÿßÿ´Ÿäÿ©',uz:'Al-Josiya',a:37,t:'Makka'},
  {n:46,ar:'ÿßŸÑÿ£ÿ≠ŸÇÿßŸÅ',uz:'Al-Ahqof',a:35,t:'Makka'},
  {n:47,ar:'ŸÖÿ≠ŸÖÿØ',uz:'Muhammad',a:38,t:'Madina'},
  {n:48,ar:'ÿßŸÑŸÅÿ™ÿ≠',uz:'Al-Fath',a:29,t:'Madina'},
  {n:49,ar:'ÿßŸÑÿ≠ÿ¨ÿ±ÿßÿ™',uz:'Al-Hujurot',a:18,t:'Madina'},
  {n:50,ar:'ŸÇ',uz:'Qof',a:45,t:'Makka'},
  {n:51,ar:'ÿßŸÑÿ∞ÿßÿ±Ÿäÿßÿ™',uz:'Az-Zoriyot',a:60,t:'Makka'},
  {n:52,ar:'ÿßŸÑÿ∑Ÿàÿ±',uz:'At-Tur',a:49,t:'Makka'},
  {n:53,ar:'ÿßŸÑŸÜÿ¨ŸÖ',uz:'An-Najm',a:62,t:'Makka'},
  {n:54,ar:'ÿßŸÑŸÇŸÖÿ±',uz:'Al-Qamar',a:55,t:'Makka'},
  {n:55,ar:'ÿßŸÑÿ±ÿ≠ŸÖŸÜ',uz:'Ar-Rohman',a:78,t:'Madina'},
  {n:56,ar:'ÿßŸÑŸàÿßŸÇÿπÿ©',uz:'Al-Voqia',a:96,t:'Makka'},
  {n:57,ar:'ÿßŸÑÿ≠ÿØŸäÿØ',uz:'Al-Hadid',a:29,t:'Madina'},
  {n:58,ar:'ÿßŸÑŸÖÿ¨ÿßÿØŸÑÿ©',uz:'Al-Mujodala',a:22,t:'Madina'},
  {n:59,ar:'ÿßŸÑÿ≠ÿ¥ÿ±',uz:'Al-Hashr',a:24,t:'Madina'},
  {n:60,ar:'ÿßŸÑŸÖŸÖÿ™ÿ≠ŸÜÿ©',uz:'Al-Mumtahana',a:13,t:'Madina'},
  {n:61,ar:'ÿßŸÑÿµŸÅ',uz:'As-Saff',a:14,t:'Madina'},
  {n:62,ar:'ÿßŸÑÿ¨ŸÖÿπÿ©',uz:"Al-Jum'a",a:11,t:'Madina'},
  {n:63,ar:'ÿßŸÑŸÖŸÜÿßŸÅŸÇŸàŸÜ',uz:'Al-Munofiqun',a:11,t:'Madina'},
  {n:64,ar:'ÿßŸÑÿ™ÿ∫ÿßÿ®ŸÜ',uz:'At-Taghabun',a:18,t:'Madina'},
  {n:65,ar:'ÿßŸÑÿ∑ŸÑÿßŸÇ',uz:'At-Talaq',a:12,t:'Madina'},
  {n:66,ar:'ÿßŸÑÿ™ÿ≠ÿ±ŸäŸÖ',uz:'At-Tahrim',a:12,t:'Madina'},
  {n:67,ar:'ÿßŸÑŸÖŸÑŸÉ',uz:'Al-Mulk',a:30,t:'Makka'},
  {n:68,ar:'ÿßŸÑŸÇŸÑŸÖ',uz:'Al-Qalam',a:52,t:'Makka'},
  {n:69,ar:'ÿßŸÑÿ≠ÿßŸÇÿ©',uz:'Al-Haqqa',a:52,t:'Makka'},
  {n:70,ar:'ÿßŸÑŸÖÿπÿßÿ±ÿ¨',uz:"Al-Ma'orij",a:44,t:'Makka'},
  {n:71,ar:'ŸÜŸàÿ≠',uz:'Nuh',a:28,t:'Makka'},
  {n:72,ar:'ÿßŸÑÿ¨ŸÜ',uz:'Al-Jin',a:28,t:'Makka'},
  {n:73,ar:'ÿßŸÑŸÖÿ≤ŸÖŸÑ',uz:'Al-Muzzammil',a:20,t:'Makka'},
  {n:74,ar:'ÿßŸÑŸÖÿØÿ´ÿ±',uz:'Al-Muddaththir',a:56,t:'Makka'},
  {n:75,ar:'ÿßŸÑŸÇŸäÿßŸÖÿ©',uz:'Al-Qiyoma',a:40,t:'Makka'},
  {n:76,ar:'ÿßŸÑÿ•ŸÜÿ≥ÿßŸÜ',uz:'Al-Inson',a:31,t:'Madina'},
  {n:77,ar:'ÿßŸÑŸÖÿ±ÿ≥ŸÑÿßÿ™',uz:'Al-Mursalot',a:50,t:'Makka'},
  {n:78,ar:'ÿßŸÑŸÜÿ®ÿ£',uz:'An-Naba',a:40,t:'Makka'},
  {n:79,ar:'ÿßŸÑŸÜÿßÿ≤ÿπÿßÿ™',uz:"An-Nozi'ot",a:46,t:'Makka'},
  {n:80,ar:'ÿπÿ®ÿ≥',uz:'Abasa',a:42,t:'Makka'},
  {n:81,ar:'ÿßŸÑÿ™ŸÉŸàŸäÿ±',uz:'At-Takwir',a:29,t:'Makka'},
  {n:82,ar:'ÿßŸÑÿßŸÜŸÅÿ∑ÿßÿ±',uz:'Al-Infitor',a:19,t:'Makka'},
  {n:83,ar:'ÿßŸÑŸÖÿ∑ŸÅŸÅŸäŸÜ',uz:'Al-Mutaffifin',a:36,t:'Makka'},
  {n:84,ar:'ÿßŸÑÿßŸÜÿ¥ŸÇÿßŸÇ',uz:'Al-Inshiqoq',a:25,t:'Makka'},
  {n:85,ar:'ÿßŸÑÿ®ÿ±Ÿàÿ¨',uz:'Al-Buruj',a:22,t:'Makka'},
  {n:86,ar:'ÿßŸÑÿ∑ÿßÿ±ŸÇ',uz:'At-Toriq',a:17,t:'Makka'},
  {n:87,ar:'ÿßŸÑÿ£ÿπŸÑŸâ',uz:"Al-A'lo",a:19,t:'Makka'},
  {n:88,ar:'ÿßŸÑÿ∫ÿßÿ¥Ÿäÿ©',uz:"Al-G'oshiya",a:26,t:'Makka'},
  {n:89,ar:'ÿßŸÑŸÅÿ¨ÿ±',uz:'Al-Fajr',a:30,t:'Makka'},
  {n:90,ar:'ÿßŸÑÿ®ŸÑÿØ',uz:'Al-Balad',a:20,t:'Makka'},
  {n:91,ar:'ÿßŸÑÿ¥ŸÖÿ≥',uz:'Ash-Shams',a:15,t:'Makka'},
  {n:92,ar:'ÿßŸÑŸÑŸäŸÑ',uz:'Al-Layl',a:21,t:'Makka'},
  {n:93,ar:'ÿßŸÑÿ∂ÿ≠Ÿâ',uz:'Ad-Duho',a:11,t:'Makka'},
  {n:94,ar:'ÿßŸÑÿ¥ÿ±ÿ≠',uz:'Ash-Sharh',a:8,t:'Makka'},
  {n:95,ar:'ÿßŸÑÿ™ŸäŸÜ',uz:'At-Tin',a:8,t:'Makka'},
  {n:96,ar:'ÿßŸÑÿπŸÑŸÇ',uz:'Al-Alaq',a:19,t:'Makka'},
  {n:97,ar:'ÿßŸÑŸÇÿØÿ±',uz:'Al-Qadr',a:5,t:'Makka'},
  {n:98,ar:'ÿßŸÑÿ®ŸäŸÜÿ©',uz:'Al-Bayyina',a:8,t:'Madina'},
  {n:99,ar:'ÿßŸÑÿ≤ŸÑÿ≤ŸÑÿ©',uz:'Az-Zalzala',a:8,t:'Madina'},
  {n:100,ar:'ÿßŸÑÿπÿßÿØŸäÿßÿ™',uz:'Al-Odiyot',a:11,t:'Makka'},
  {n:101,ar:'ÿßŸÑŸÇÿßÿ±ÿπÿ©',uz:"Al-Qori'a",a:11,t:'Makka'},
  {n:102,ar:'ÿßŸÑÿ™ŸÉÿßÿ´ÿ±',uz:'At-Takosur',a:8,t:'Makka'},
  {n:103,ar:'ÿßŸÑÿπÿµÿ±',uz:'Al-Asr',a:3,t:'Makka'},
  {n:104,ar:'ÿßŸÑŸáŸÖÿ≤ÿ©',uz:'Al-Humaza',a:9,t:'Makka'},
  {n:105,ar:'ÿßŸÑŸÅŸäŸÑ',uz:'Al-Fil',a:5,t:'Makka'},
  {n:106,ar:'ŸÇÿ±Ÿäÿ¥',uz:'Quraysh',a:4,t:'Makka'},
  {n:107,ar:'ÿßŸÑŸÖÿßÿπŸàŸÜ',uz:"Al-Mo'un",a:7,t:'Makka'},
  {n:108,ar:'ÿßŸÑŸÉŸàÿ´ÿ±',uz:'Al-Kavshar',a:3,t:'Makka'},
  {n:109,ar:'ÿßŸÑŸÉÿßŸÅÿ±ŸàŸÜ',uz:'Al-Kofirun',a:6,t:'Makka'},
  {n:110,ar:'ÿßŸÑŸÜÿµÿ±',uz:'An-Nasr',a:3,t:'Madina'},
  {n:111,ar:'ÿßŸÑŸÖÿ≥ÿØ',uz:'Al-Masad',a:5,t:'Makka'},
  {n:112,ar:'ÿßŸÑÿ•ÿÆŸÑÿßÿµ',uz:'Al-Ikhlos',a:4,t:'Makka'},
  {n:113,ar:'ÿßŸÑŸÅŸÑŸÇ',uz:'Al-Falaq',a:5,t:'Makka'},
  {n:114,ar:'ÿßŸÑŸÜÿßÿ≥',uz:'An-Nos',a:6,t:'Makka'},
];

// ===== Player state =====
const au=document.getElementById('au');
let reciter=0;
let curSurahNum=null;
let playing=false;
let filtered=[...SURAHS];
let tryingIndex=0;

// UI helpers
function setPP(s){ document.getElementById('ppbtn').textContent=s; }
function setErr(s){ document.getElementById('perr').textContent=s||''; }
function fmt(s){ if(!isFinite(s)||isNaN(s)) return '0:00'; return `${Math.floor(s/60)}:${String(Math.floor(s%60)).padStart(2,'0')}`; }

function openPlayer(){ document.getElementById('player').classList.add('vis'); }
function closePlayer(){
  au.pause(); playing=false; curSurahNum=null;
  setPP('‚ñ∂'); setErr('');
  document.getElementById('player').classList.remove('vis');
  renderList(filtered);
}

function buildRec(){
  const row=document.getElementById('rcrow'); row.innerHTML='';
  RECITERS.forEach((r,i)=>{
    const b=document.createElement('button');
    b.className='rchip'+(i===0?' on':'');
    b.textContent=r.name;
    b.onclick=()=>{
      reciter=i;
      document.querySelectorAll('.rchip').forEach((c,j)=>c.classList.toggle('on',j===i));
      if(curSurahNum!=null) loadSurah(curSurahNum, playing);
    };
    row.appendChild(b);
  });
}

function renderList(list){
  const el=document.getElementById('slist');
  if(!list.length){ el.innerHTML='<div class="nores">üîç Hech narsa topilmadi</div>'; return; }
  el.innerHTML='';
  list.forEach(s=>{
    const isCur = (curSurahNum === s.n);
    const d=document.createElement('div');
    d.className='si2'+(isCur?' playing':'');
    d.innerHTML=
      `<div class="sno">${s.n}</div>`+
      `<div class="sinf"><div class="sar">${s.ar}</div><div class="suz">${s.uz}</div></div>`+
      `<div class="smeta">${s.a} oyat<br><small>${s.t}</small></div>`+
      `<div class="pbtn">${isCur && playing ? '‚è∏' : '‚ñ∂'}</div>`;
    d.onclick=()=>{
      if(curSurahNum===s.n) togglePlay();
      else loadSurah(s.n, true); // user tap -> play allowed
    };
    el.appendChild(d);
  });
}

function doFilter(){
  const q=document.getElementById('srch').value.toLowerCase().trim();
  filtered = q ? SURAHS.filter(s=>s.uz.toLowerCase().includes(q) || s.ar.includes(q) || String(s.n).includes(q))
               : [...SURAHS];
  renderList(filtered);
}

function tryLoadUrl(surahNum, autoPlay){
  const urls=RECITERS[reciter].urls;
  if(tryingIndex>=urls.length){
    setPP('‚ñ∂'); playing=false;
    setErr("‚ùå Audio yuklanmadi. Internet/manba bloklangan bo‚Äòlishi mumkin.");
    renderList(filtered);
    return;
  }

  const url=urls[tryingIndex](surahNum);
  setErr('Yuklanmoqda...');
  setPP('‚è≥');

  au.onloadedmetadata=null;
  au.onerror=null;

  au.onerror=()=>{ tryingIndex++; tryLoadUrl(surahNum, autoPlay); };

  au.onloadedmetadata=()=>{
    setErr('');
    document.getElementById('td').textContent=fmt(au.duration);
    if(autoPlay){
      au.play().then(()=>{
        playing=true; setPP('‚è∏'); renderList(filtered);
      }).catch(()=>{
        playing=false; setPP('‚ñ∂');
        setErr("‚ö†Ô∏è Play uchun yana ‚ñ∂ bosing (Telegram ba‚Äôzan bloklaydi).");
      });
    } else {
      playing=false; setPP('‚ñ∂');
    }
  };

  au.src=url;
  au.load();
}

function loadSurah(surahNum, autoPlay){
  curSurahNum=surahNum;
  tryingIndex=0;

  const s=SURAHS.find(x=>x.n===surahNum);
  document.getElementById('ptit').textContent=`${s.n}. ${s.ar}  ${s.uz}`;
  document.getElementById('prec').textContent=RECITERS[reciter].name;

  openPlayer();
  document.getElementById('pfil').style.width='0%';
  document.getElementById('tc').textContent='0:00';
  document.getElementById('td').textContent='0:00';

  au.pause(); playing=false;
  renderList(filtered);
  tryLoadUrl(surahNum, autoPlay);
}

function togglePlay(){
  if(curSurahNum==null) return;

  if(playing){ au.pause(); return; }

  if(!au.src){
    loadSurah(curSurahNum, true);
    return;
  }

  au.play().then(()=>{
    playing=true; setPP('‚è∏'); setErr(''); renderList(filtered);
  }).catch(()=>{
    setErr("‚ö†Ô∏è Telegram audio ruxsat bermadi. Yana ‚ñ∂ bosing yoki boshqa qori tanlang.");
  });
}

function moveSurah(step){
  if(curSurahNum==null) return;
  const idx = filtered.findIndex(x=>x.n===curSurahNum);
  const next = filtered[(idx+step+filtered.length)%filtered.length];
  loadSurah(next.n, true);
}

function seek(e){
  if(!au.duration) return;
  const r=document.getElementById('pbar').getBoundingClientRect();
  const x=(e.clientX-r.left)/r.width;
  au.currentTime=Math.max(0,Math.min(au.duration,x*au.duration));
}

au.addEventListener('timeupdate',()=>{
  if(!au.duration) return;
  document.getElementById('pfil').style.width=(au.currentTime/au.duration*100)+'%';
  document.getElementById('tc').textContent=fmt(au.currentTime);
});
au.addEventListener('durationchange',()=>document.getElementById('td').textContent=fmt(au.duration));
au.addEventListener('playing',()=>{ playing=true; setPP('‚è∏'); setErr(''); renderList(filtered); });
au.addEventListener('pause',()=>{ playing=false; setPP('‚ñ∂'); renderList(filtered); });
au.addEventListener('ended',()=>moveSurah(1));

// Init Quran UI
buildRec();
renderList(SURAHS);
</script>
</body>
</html>
