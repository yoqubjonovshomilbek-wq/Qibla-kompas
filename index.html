<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Islomiy Ilova</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Amiri:ital,wght@0,400;0,700;1,400&family=Tajawal:wght@300;400;500;700&display=swap');

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}

:root{
  --emerald:#1db954;
  --emerald-dim:#158f3e;
  --gold:#d4a843;
  --gold-dim:#a07820;
  --bg:#05111f;
  --surface:#0b1e35;
  --surface2:#102840;
  --surface3:#163450;
  --border:rgba(29,185,84,0.15);
  --text:#e8f4fd;
  --muted:#5a8aaa;
  --glow:rgba(29,185,84,0.35);
}

html,body{height:100%;overflow:hidden;}

body{
  font-family:'Tajawal',sans-serif;
  background:var(--bg);
  color:var(--text);
  display:flex;
  flex-direction:column;
  height:100vh;
  height:100dvh;
}

/* ===== STARS BG ===== */
body::before{
  content:'';
  position:fixed;inset:0;
  background:
    radial-gradient(1px 1px at 15% 20%,rgba(255,255,255,.5) 0%,transparent 100%),
    radial-gradient(1px 1px at 75% 8%,rgba(255,255,255,.4) 0%,transparent 100%),
    radial-gradient(1px 1px at 45% 60%,rgba(255,255,255,.3) 0%,transparent 100%),
    radial-gradient(1px 1px at 88% 45%,rgba(255,255,255,.5) 0%,transparent 100%),
    radial-gradient(1px 1px at 8% 80%,rgba(255,255,255,.3) 0%,transparent 100%),
    radial-gradient(1px 1px at 55% 88%,rgba(255,255,255,.4) 0%,transparent 100%),
    radial-gradient(2px 2px at 28% 12%,rgba(255,255,255,.2) 0%,transparent 100%),
    radial-gradient(2px 2px at 92% 75%,rgba(255,255,255,.15) 0%,transparent 100%),
    radial-gradient(1px 1px at 62% 35%,rgba(255,255,255,.35) 0%,transparent 100%),
    radial-gradient(1px 1px at 33% 90%,rgba(255,255,255,.25) 0%,transparent 100%);
  pointer-events:none;z-index:0;
}

/* ===== TABS NAV ===== */
.tab-nav{
  display:flex;
  background:var(--surface);
  border-bottom:1px solid var(--border);
  position:relative;
  z-index:10;
  flex-shrink:0;
}
.tab-btn{
  flex:1;
  padding:14px 8px 12px;
  border:none;
  background:transparent;
  color:var(--muted);
  font-family:'Tajawal',sans-serif;
  font-size:13px;
  font-weight:500;
  cursor:pointer;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:4px;
  transition:color .25s;
  position:relative;
}
.tab-btn .tab-icon{font-size:22px;line-height:1;}
.tab-btn.active{color:var(--emerald);}
.tab-btn::after{
  content:'';
  position:absolute;bottom:0;left:20%;right:20%;
  height:2px;border-radius:2px 2px 0 0;
  background:var(--emerald);
  transform:scaleX(0);
  transition:transform .25s;
}
.tab-btn.active::after{transform:scaleX(1);}

/* ===== PAGES ===== */
.pages{flex:1;overflow:hidden;position:relative;}
.page{
  position:absolute;inset:0;
  overflow-y:auto;
  overflow-x:hidden;
  -webkit-overflow-scrolling:touch;
  opacity:0;
  pointer-events:none;
  transition:opacity .25s;
}
.page.active{opacity:1;pointer-events:all;}

/* ===== SCROLLBAR ===== */
.page::-webkit-scrollbar{width:4px;}
.page::-webkit-scrollbar-track{background:transparent;}
.page::-webkit-scrollbar-thumb{background:var(--surface3);border-radius:4px;}

/* ==================== QIBLA PAGE ==================== */
.qibla-page{
  display:flex;
  flex-direction:column;
  align-items:center;
  padding:16px 16px 24px;
  gap:16px;
  min-height:100%;
}

.page-title{
  text-align:center;
  font-family:'Amiri',serif;
  font-size:24px;
  color:var(--gold);
  text-shadow:0 0 20px rgba(212,168,67,.4);
  letter-spacing:.5px;
}
.page-title small{display:block;font-family:'Tajawal',sans-serif;font-size:11px;color:var(--muted);margin-top:3px;letter-spacing:1px;text-transform:uppercase;}

/* Compass */
.compass-wrap{
  position:relative;
  width:260px;height:260px;
  flex-shrink:0;
}

.outer-ring{
  position:absolute;inset:0;
  border-radius:50%;
  padding:5px;
  background:conic-gradient(from 0deg,#1a3a5c,#0b1e35,#1a3a5c,#0b1e35,#1a3a5c);
  box-shadow:0 0 25px rgba(11,30,53,.9),inset 0 0 15px rgba(0,0,0,.5);
  transition:background .4s,box-shadow .4s;
}
.outer-ring.aligned{
  background:conic-gradient(from 0deg,var(--emerald),#0e7a30,var(--emerald),#0e7a30,var(--emerald));
  box-shadow:0 0 35px var(--glow),0 0 70px var(--glow),inset 0 0 15px rgba(29,185,84,.15);
  animation:pulse-ring 1s ease-in-out infinite alternate;
}
@keyframes pulse-ring{
  from{box-shadow:0 0 25px var(--glow),0 0 50px var(--glow);}
  to{box-shadow:0 0 45px var(--glow),0 0 90px var(--glow);}
}

.compass-dial{
  position:absolute;inset:5px;
  border-radius:50%;
  background:radial-gradient(ellipse at 35% 30%,#1b3860,#061528 75%);
  overflow:hidden;
  will-change:transform;
}
.dial-svg{position:absolute;inset:0;width:100%;height:100%;}

/* Arrow overlay - never rotates as element, only SVG group inside */
.arrow-overlay{
  position:absolute;inset:5px;
  border-radius:50%;
  pointer-events:none;
}
.arrow-svg{position:absolute;inset:0;width:100%;height:100%;}

.center-kaaba{
  position:absolute;top:50%;left:50%;
  transform:translate(-50%,-50%);
  width:46px;height:46px;
  background:radial-gradient(circle,#1a5030,#091e12);
  border-radius:50%;
  border:2.5px solid var(--gold);
  display:flex;align-items:center;justify-content:center;
  font-size:22px;
  z-index:20;
  box-shadow:0 0 12px rgba(212,168,67,.3);
}

/* Degree card */
.deg-card{
  background:linear-gradient(135deg,var(--surface),var(--surface2));
  border:1.5px solid var(--border);
  border-radius:18px;
  padding:14px 28px;
  text-align:center;
  width:100%;
  position:relative;overflow:hidden;
}
.deg-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:1px;
  background:linear-gradient(90deg,transparent,var(--emerald),transparent);
}
.deg-num{font-size:44px;font-weight:700;color:var(--text);line-height:1;}
.deg-num span{color:var(--emerald);}
.deg-dir{font-size:12px;color:var(--muted);margin-top:4px;letter-spacing:1px;text-transform:uppercase;}

/* Status */
.status-pill{
  display:inline-flex;align-items:center;gap:7px;
  padding:7px 18px;border-radius:30px;
  font-size:13px;font-weight:600;
  background:var(--surface);
  border:1.5px solid rgba(29,185,84,.2);
  color:var(--muted);
  transition:all .3s;
}
.status-pill.aligned{
  background:rgba(29,185,84,.12);
  border-color:var(--emerald);
  color:var(--emerald);
}
.s-dot{width:9px;height:9px;border-radius:50%;background:var(--muted);transition:background .3s;}
.status-pill.aligned .s-dot{background:var(--emerald);box-shadow:0 0 6px var(--emerald);animation:blink 1s infinite;}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:.3;}}

.aligned-txt{
  font-family:'Amiri',serif;font-size:17px;
  color:var(--gold);text-align:center;
  text-shadow:0 0 12px rgba(212,168,67,.4);
  opacity:0;transition:opacity .4s;height:0;overflow:hidden;
}
.aligned-txt.show{opacity:1;height:auto;}

.loc-box{
  display:flex;align-items:center;gap:10px;
  background:rgba(11,30,53,.7);
  border:1px solid rgba(90,138,170,.2);
  border-radius:12px;padding:10px 14px;
  width:100%;font-size:12px;color:var(--muted);
}
.loc-box strong{color:var(--text);font-size:13px;display:block;}

.start-btn{
  background:linear-gradient(135deg,var(--emerald-dim),var(--emerald));
  border:none;border-radius:14px;padding:13px 28px;
  color:#fff;font-family:'Tajawal',sans-serif;
  font-size:15px;font-weight:700;cursor:pointer;
  width:100%;box-shadow:0 4px 18px var(--glow);
  transition:transform .15s,opacity .15s;
}
.start-btn:active{transform:scale(.97);opacity:.9;}

/* ==================== QURAN PAGE ==================== */
.quran-page{padding:0;}

.quran-header{
  padding:16px 16px 12px;
  background:linear-gradient(180deg,var(--surface) 0%,transparent 100%);
  position:sticky;top:0;z-index:5;
}
.quran-header h2{
  font-family:'Amiri',serif;
  font-size:22px;color:var(--gold);
  text-shadow:0 0 15px rgba(212,168,67,.3);
  text-align:center;margin-bottom:10px;
}

/* Search */
.search-box{
  position:relative;
}
.search-box input{
  width:100%;
  background:var(--surface2);
  border:1.5px solid var(--border);
  border-radius:12px;
  padding:10px 14px 10px 38px;
  color:var(--text);
  font-family:'Tajawal',sans-serif;
  font-size:14px;
  outline:none;
  transition:border-color .2s;
}
.search-box input:focus{border-color:var(--emerald);}
.search-box input::placeholder{color:var(--muted);}
.search-icon{
  position:absolute;left:12px;top:50%;transform:translateY(-50%);
  font-size:15px;pointer-events:none;
}

/* Reciter select */
.reciter-row{
  display:flex;gap:8px;margin-top:8px;overflow-x:auto;padding-bottom:4px;
}
.reciter-row::-webkit-scrollbar{display:none;}
.reciter-chip{
  flex-shrink:0;
  padding:6px 14px;border-radius:20px;
  border:1.5px solid var(--border);
  background:var(--surface2);
  color:var(--muted);font-size:12px;
  cursor:pointer;transition:all .2s;white-space:nowrap;
}
.reciter-chip.active{
  background:rgba(29,185,84,.15);
  border-color:var(--emerald);
  color:var(--emerald);
}

/* Surah list */
.surah-list{padding:8px 12px 24px;}
.surah-item{
  display:flex;align-items:center;gap:12px;
  padding:10px 12px;
  border-radius:12px;
  background:var(--surface);
  border:1px solid var(--border);
  margin-bottom:6px;
  cursor:pointer;
  transition:background .2s,border-color .2s,transform .15s;
  position:relative;overflow:hidden;
}
.surah-item:active{transform:scale(.98);}
.surah-item.playing{
  background:rgba(29,185,84,.1);
  border-color:var(--emerald);
}
.surah-item::before{
  content:'';position:absolute;left:0;top:0;bottom:0;
  width:3px;background:var(--emerald);
  transform:scaleY(0);transition:transform .2s;border-radius:0 2px 2px 0;
}
.surah-item.playing::before{transform:scaleY(1);}

.surah-num{
  width:34px;height:34px;
  background:var(--surface2);
  border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:700;
  color:var(--emerald);flex-shrink:0;
  border:1px solid var(--border);
}
.surah-item.playing .surah-num{
  background:var(--emerald);color:#fff;border-color:var(--emerald);
}

.surah-info{flex:1;min-width:0;}
.surah-name-ar{
  font-family:'Amiri',serif;
  font-size:16px;color:var(--text);
  line-height:1.2;
}
.surah-name-uz{
  font-size:11px;color:var(--muted);margin-top:1px;
}
.surah-meta{
  font-size:11px;color:var(--muted);
  text-align:right;flex-shrink:0;
  line-height:1.4;
}

.play-btn{
  width:34px;height:34px;
  border-radius:50%;
  background:var(--surface2);
  border:1.5px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  font-size:14px;flex-shrink:0;
  transition:background .2s,border-color .2s;
}
.surah-item.playing .play-btn{
  background:var(--emerald);border-color:var(--emerald);
}

/* Sticky player */
.audio-player{
  position:fixed;bottom:0;left:0;right:0;
  background:linear-gradient(0deg,var(--surface) 0%,rgba(11,30,53,.98) 100%);
  border-top:1px solid var(--border);
  padding:10px 16px 16px;
  z-index:100;
  transform:translateY(100%);
  transition:transform .3s cubic-bezier(.4,0,.2,1);
  box-shadow:0 -8px 30px rgba(0,0,0,.5);
}
.audio-player.visible{transform:translateY(0);}

.player-surah{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:8px;
}
.player-title{
  font-family:'Amiri',serif;font-size:16px;color:var(--gold);
}
.player-reciter{font-size:11px;color:var(--muted);margin-top:1px;}
.close-player{
  background:none;border:none;color:var(--muted);
  font-size:18px;cursor:pointer;padding:4px;
}

.progress-row{
  display:flex;align-items:center;gap:8px;margin-bottom:8px;
}
.time-txt{font-size:11px;color:var(--muted);min-width:35px;}
.progress-bar{
  flex:1;height:4px;background:var(--surface3);
  border-radius:4px;cursor:pointer;position:relative;
}
.progress-fill{
  height:100%;background:var(--emerald);border-radius:4px;
  width:0%;transition:width .3s linear;pointer-events:none;
}

.player-controls{
  display:flex;align-items:center;justify-content:center;gap:20px;
}
.ctrl-btn{
  background:none;border:none;color:var(--muted);
  font-size:20px;cursor:pointer;padding:6px;
  transition:color .2s;
}
.ctrl-btn:hover{color:var(--text);}
.play-pause{
  width:48px;height:48px;border-radius:50%;
  background:var(--emerald);border:none;
  display:flex;align-items:center;justify-content:center;
  font-size:20px;cursor:pointer;
  box-shadow:0 4px 15px var(--glow);
  transition:transform .15s;
}
.play-pause:active{transform:scale(.93);}

/* Loading spinner */
.spin{
  display:inline-block;
  width:16px;height:16px;
  border:2px solid rgba(255,255,255,.3);
  border-top-color:#fff;
  border-radius:50%;
  animation:spin .7s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg);}}

.no-results{
  text-align:center;padding:40px 20px;
  color:var(--muted);font-size:14px;
}

/* Scrollbar padding when player visible */
.quran-page.player-open{padding-bottom:130px;}
</style>
</head>
<body>

<!-- TAB NAV -->
<nav class="tab-nav">
  <button class="tab-btn active" id="tabQibla" onclick="switchTab('qibla')">
    <span class="tab-icon">üß≠</span>
    <span>Qibla</span>
  </button>
  <button class="tab-btn" id="tabQuran" onclick="switchTab('quran')">
    <span class="tab-icon">üìñ</span>
    <span>Qur'on</span>
  </button>
</nav>

<!-- PAGES -->
<div class="pages">

  <!-- ===== QIBLA PAGE ===== -->
  <div class="page qibla-page active" id="pageQibla">

    <div class="page-title">
      üïå Qibla Kompas
      <small>Makka al-Mukarrama yo'nalishi</small>
    </div>

    <div class="compass-wrap" id="compassWrap">
      <div class="outer-ring" id="outerRing"></div>

      <div class="compass-dial" id="compassDial">
        <svg class="dial-svg" viewBox="0 0 250 250" xmlns="http://www.w3.org/2000/svg">
          <g id="dialTicks"></g>
          <!-- Cardinals -->
          <text x="125" y="30" text-anchor="middle" font-family="Tajawal" font-weight="700" font-size="18" fill="#e74c3c">N</text>
          <text x="125" y="236" text-anchor="middle" font-family="Tajawal" font-weight="700" font-size="16" fill="#5a8aaa">S</text>
          <text x="228" y="131" text-anchor="middle" dominant-baseline="middle" font-family="Tajawal" font-weight="700" font-size="16" fill="#5a8aaa">E</text>
          <text x="22" y="131" text-anchor="middle" dominant-baseline="middle" font-family="Tajawal" font-weight="700" font-size="16" fill="#5a8aaa">W</text>
          <!-- Degree labels -->
          <text x="125" y="50" text-anchor="middle" font-family="Tajawal" font-size="10" fill="#2a6090">0¬∞</text>
          <text x="196" y="64" text-anchor="middle" font-family="Tajawal" font-size="10" fill="#2a6090">45¬∞</text>
          <text x="215" y="133" text-anchor="middle" font-family="Tajawal" font-size="10" fill="#2a6090">90¬∞</text>
          <text x="196" y="200" text-anchor="middle" font-family="Tajawal" font-size="10" fill="#2a6090">135¬∞</text>
          <text x="125" y="218" text-anchor="middle" font-family="Tajawal" font-size="10" fill="#2a6090">180¬∞</text>
          <text x="54" y="200" text-anchor="middle" font-family="Tajawal" font-size="10" fill="#2a6090">225¬∞</text>
          <text x="35" y="133" text-anchor="middle" font-family="Tajawal" font-size="10" fill="#2a6090">270¬∞</text>
          <text x="54" y="64" text-anchor="middle" font-family="Tajawal" font-size="10" fill="#2a6090">315¬∞</text>
        </svg>
      </div>

      <!-- Arrow overlay (fixed, never rotates) -->
      <div class="arrow-overlay">
        <svg class="arrow-svg" viewBox="0 0 250 250" xmlns="http://www.w3.org/2000/svg">
          <g id="qiblaArrow">
            <!-- Shadow -->
            <polygon points="125,35 133,125 125,134 117,125" fill="rgba(0,0,0,.3)" transform="translate(2,2)"/>
            <!-- Green arrow up -->
            <polygon points="125,35 133,125 125,134 117,125" fill="#1db954"/>
            <!-- Tail -->
            <polygon points="125,134 133,125 142,148 125,142 108,148 117,125" fill="#158f3e"/>
            <!-- Shine -->
            <polygon points="125,35 133,75 117,75" fill="rgba(255,255,255,.25)"/>
            <!-- QIBLA text -->
            <text x="125" y="172" text-anchor="middle" font-family="Tajawal" font-size="10" font-weight="700" fill="#1db954" opacity=".9">QIBLA</text>
          </g>
        </svg>
      </div>

      <div class="center-kaaba">üïã</div>
    </div>

    <div class="deg-card">
      <div class="deg-num"><span id="degVal">--</span>¬∞</div>
      <div class="deg-dir" id="degDir">Yo'nalish aniqlanmoqda...</div>
    </div>

    <div class="status-pill" id="statusPill">
      <div class="s-dot" id="sDot"></div>
      <span id="statusTxt">Kompas ishga tushirilmoqda</span>
    </div>

    <div class="aligned-txt" id="alignedTxt">üåø Allahu Akbar! Qibla topildi üåø</div>

    <div class="loc-box">
      <span>üìç</span>
      <div>
        <strong id="locName">Joylashuv aniqlanmoqda...</strong>
        <span id="locCoords"></span>
      </div>
    </div>

    <button class="start-btn" id="startBtn" onclick="startCompass()">üß≠ Kompasni Ishga Tushirish</button>

    <p style="font-size:11px;color:var(--muted);text-align:center;line-height:1.5;">
      GPS va kompas sensori orqali Qibla yo'nalishini aniqlaydi
    </p>
  </div>

  <!-- ===== QURAN PAGE ===== -->
  <div class="page quran-page" id="pageQuran">

    <div class="quran-header">
      <h2>üìñ Qur'oni Karim</h2>
      <div class="search-box">
        <span class="search-icon">üîç</span>
        <input type="text" id="searchInput" placeholder="Sura nomi yoki raqamini kiriting..." oninput="filterSurahs()">
      </div>
      <div class="reciter-row" id="reciterRow"></div>
    </div>

    <div class="surah-list" id="surahList">
      <div class="no-results" id="loadingMsg">‚è≥ Suralar yuklanmoqda...</div>
    </div>
  </div>

</div><!-- /pages -->

<!-- AUDIO PLAYER -->
<div class="audio-player" id="audioPlayer">
  <div class="player-surah">
    <div>
      <div class="player-title" id="playerTitle">‚Äî</div>
      <div class="player-reciter" id="playerReciter">‚Äî</div>
    </div>
    <button class="close-player" onclick="closePlayer()">‚úï</button>
  </div>
  <div class="progress-row">
    <span class="time-txt" id="timeCurrent">0:00</span>
    <div class="progress-bar" id="progressBar" onclick="seekAudio(event)">
      <div class="progress-fill" id="progressFill"></div>
    </div>
    <span class="time-txt" id="timeDuration">0:00</span>
  </div>
  <div class="player-controls">
    <button class="ctrl-btn" onclick="playPrev()" title="Oldingi">‚èÆ</button>
    <button class="play-pause" id="playPauseBtn" onclick="togglePlay()">‚ñ∂</button>
    <button class="ctrl-btn" onclick="playNext()" title="Keyingi">‚è≠</button>
  </div>
</div>

<audio id="audioEl" preload="none"></audio>

<script>
// ===================== TAB SWITCHING =====================
function switchTab(tab) {
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
  document.getElementById('page' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
}

// ===================== QIBLA COMPASS =====================
const KAABA = { lat: 21.4225, lng: 39.8262 };
let userLat = null, userLng = null;
let qiblaBearing = null;
let currentHeading = 0;
let isAligned = false;
let compassStarted = false;

function drawDialTicks() {
  const svg = document.getElementById('dialTicks');
  const cx = 125, cy = 125, r = 110;
  for (let i = 0; i < 360; i += 5) {
    const rad = (i - 90) * Math.PI / 180;
    const isMain = i % 90 === 0;
    const isMed = i % 45 === 0;
    const isMin45 = i % 15 === 0;
    const len = isMain ? 13 : isMed ? 10 : isMin45 ? 7 : 4;
    const color = isMain ? '#4a90d9' : isMed ? '#336699' : isMin45 ? '#1e5070' : '#132e40';
    const x1 = cx + r * Math.cos(rad), y1 = cy + r * Math.sin(rad);
    const x2 = cx + (r - len) * Math.cos(rad), y2 = cy + (r - len) * Math.sin(rad);
    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    line.setAttribute('x1', x1); line.setAttribute('y1', y1);
    line.setAttribute('x2', x2); line.setAttribute('y2', y2);
    line.setAttribute('stroke', color);
    line.setAttribute('stroke-width', isMain ? '2' : '1');
    svg.appendChild(line);
  }
}
drawDialTicks();

function calcBearing(lat1, lon1, lat2, lon2) {
  const r = d => d * Math.PI / 180;
  const y = Math.sin(r(lon2 - lon1)) * Math.cos(r(lat2));
  const x = Math.cos(r(lat1)) * Math.sin(r(lat2)) - Math.sin(r(lat1)) * Math.cos(r(lat2)) * Math.cos(r(lon2 - lon1));
  return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
}

function getDir(deg) {
  const d = ['Shimol','Shimoli-sharq','Sharq','Janubi-sharq','Janub','Janubi-g\'arb','G\'arb','Shimoli-g\'arb'];
  return d[Math.round(deg / 45) % 8];
}

function updateCompass() {
  if (qiblaBearing === null) return;
  const arrowAngle = qiblaBearing - currentHeading;
  // Arrow rotates around SVG center (125,125)
  document.getElementById('qiblaArrow').setAttribute('transform', `rotate(${arrowAngle} 125 125)`);
  // Dial counter-rotates with device
  document.getElementById('compassDial').style.transform = `rotate(${-currentHeading}deg)`;
  document.getElementById('degVal').textContent = Math.round(qiblaBearing);
  document.getElementById('degDir').textContent = getDir(qiblaBearing);

  const norm = ((arrowAngle % 360) + 360) % 360;
  const diff = Math.min(norm, 360 - norm);
  const nowAligned = diff < 5;
  if (nowAligned !== isAligned) {
    isAligned = nowAligned;
    const ring = document.getElementById('outerRing');
    const pill = document.getElementById('statusPill');
    const txt = document.getElementById('alignedTxt');
    if (isAligned) {
      ring.classList.add('aligned');
      pill.classList.add('aligned');
      pill.querySelector('span').textContent = '‚úÖ Qibla topildi!';
      txt.classList.add('show');
    } else {
      ring.classList.remove('aligned');
      pill.classList.remove('aligned');
      pill.querySelector('span').textContent = 'Qiblani izlang...';
      txt.classList.remove('show');
    }
  }
}

function getLocation() {
  if (!navigator.geolocation) {
    setDefaultLocation();
    return;
  }
  navigator.geolocation.getCurrentPosition(pos => {
    userLat = pos.coords.latitude;
    userLng = pos.coords.longitude;
    qiblaBearing = calcBearing(userLat, userLng, KAABA.lat, KAABA.lng);
    document.getElementById('locName').textContent = `${userLat.toFixed(3)}¬∞, ${userLng.toFixed(3)}¬∞`;
    document.getElementById('locCoords').textContent = `Qibla: ${Math.round(qiblaBearing)}¬∞ ${getDir(qiblaBearing)}`;
    updateCompass();
    fetch(`https://nominatim.openstreetmap.org/reverse?lat=${userLat}&lon=${userLng}&format=json`)
      .then(r => r.json())
      .then(d => {
        const c = d.address?.city || d.address?.town || d.address?.village || '';
        const co = d.address?.country || '';
        if (c || co) document.getElementById('locName').textContent = `${c}${c && co ? ', ' : ''}${co}`;
      }).catch(() => {});
  }, () => setDefaultLocation(), { timeout: 8000 });
}

function setDefaultLocation() {
  userLat = 41.2995; userLng = 69.2401;
  qiblaBearing = calcBearing(userLat, userLng, KAABA.lat, KAABA.lng);
  document.getElementById('locName').textContent = 'Toshkent (taxminiy)';
  document.getElementById('locCoords').textContent = `Qibla: ${Math.round(qiblaBearing)}¬∞`;
  updateCompass();
}

let targetHeading = 0;
function handleOrientation(e) {
  let h = null;
  if (e.webkitCompassHeading != null) h = e.webkitCompassHeading;
  else if (e.absolute && e.alpha != null) h = (360 - e.alpha) % 360;
  else if (e.alpha != null) h = (360 - e.alpha) % 360;
  if (h != null && !isNaN(h)) {
    targetHeading = h;
    let diff = targetHeading - currentHeading;
    if (diff > 180) diff -= 360;
    if (diff < -180) diff += 360;
    currentHeading = (currentHeading + diff * 0.2 + 360) % 360;
    updateCompass();
  }
}

function simulateCompass() {
  document.getElementById('statusTxt').textContent = 'Simulyatsiya rejimi';
  let a = 0;
  setInterval(() => { a = (a + 1) % 360; currentHeading = a; updateCompass(); }, 30);
}

function startCompass() {
  if (compassStarted) return;
  compassStarted = true;
  document.getElementById('startBtn').style.display = 'none';
  getLocation();
  const listen = () => {
    window.addEventListener('deviceorientationabsolute', handleOrientation, true);
    window.addEventListener('deviceorientation', handleOrientation, true);
    document.getElementById('statusTxt').textContent = 'Kompas faol';
  };
  if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission().then(s => {
      if (s === 'granted') listen(); else simulateCompass();
    }).catch(simulateCompass);
  } else {
    listen();
    setTimeout(() => { if (currentHeading === 0 && qiblaBearing !== null) simulateCompass(); }, 3000);
  }
}

// ===================== QURAN AUDIO =====================
const RECITERS = [
  { id: 'ar.alafasy',     name: 'Mishary Alafasy',  base: 'https://cdn.islamic.network/quran/audio/128/ar.alafasy/' },
  { id: 'ar.abdurrahmaansudais', name: 'Sudais',    base: 'https://cdn.islamic.network/quran/audio/128/ar.abdurrahmaansudais/' },
  { id: 'ar.husary',      name: 'Husary',            base: 'https://cdn.islamic.network/quran/audio/128/ar.husary/' },
  { id: 'ar.minshawi',    name: "Minshawi",          base: 'https://cdn.islamic.network/quran/audio/128/ar.minshawi/' },
];

const SURAHS = [
  {n:1,ar:'ÿßŸÑŸÅÿßÿ™ÿ≠ÿ©',uz:'Al-Fotiha',ayat:7,type:'Makka'},
  {n:2,ar:'ÿßŸÑÿ®ŸÇÿ±ÿ©',uz:'Al-Baqara',ayat:286,type:'Madina'},
  {n:3,ar:'ÿ¢ŸÑ ÿπŸÖÿ±ÿßŸÜ',uz:'Ali Imron',ayat:200,type:'Madina'},
  {n:4,ar:'ÿßŸÑŸÜÿ≥ÿßÿ°',uz:'An-Niso',ayat:176,type:'Madina'},
  {n:5,ar:'ÿßŸÑŸÖÿßÿ¶ÿØÿ©',uz:'Al-Moida',ayat:120,type:'Madina'},
  {n:6,ar:'ÿßŸÑÿ£ŸÜÿπÿßŸÖ',uz:'Al-An\'om',ayat:165,type:'Makka'},
  {n:7,ar:'ÿßŸÑÿ£ÿπÿ±ÿßŸÅ',uz:'Al-A\'rof',ayat:206,type:'Makka'},
  {n:8,ar:'ÿßŸÑÿ£ŸÜŸÅÿßŸÑ',uz:'Al-Anfol',ayat:75,type:'Madina'},
  {n:9,ar:'ÿßŸÑÿ™Ÿàÿ®ÿ©',uz:'At-Tavba',ayat:129,type:'Madina'},
  {n:10,ar:'ŸäŸàŸÜÿ≥',uz:'Yunus',ayat:109,type:'Makka'},
  {n:11,ar:'ŸáŸàÿØ',uz:'Hud',ayat:123,type:'Makka'},
  {n:12,ar:'ŸäŸàÿ≥ŸÅ',uz:'Yusuf',ayat:111,type:'Makka'},
  {n:13,ar:'ÿßŸÑÿ±ÿπÿØ',uz:'Ar-Ra\'d',ayat:43,type:'Madina'},
  {n:14,ar:'ÿ•ÿ®ÿ±ÿßŸáŸäŸÖ',uz:'Ibrohim',ayat:52,type:'Makka'},
  {n:15,ar:'ÿßŸÑÿ≠ÿ¨ÿ±',uz:'Al-Hijr',ayat:99,type:'Makka'},
  {n:16,ar:'ÿßŸÑŸÜÿ≠ŸÑ',uz:'An-Nahl',ayat:128,type:'Makka'},
  {n:17,ar:'ÿßŸÑÿ•ÿ≥ÿ±ÿßÿ°',uz:'Al-Isro',ayat:111,type:'Makka'},
  {n:18,ar:'ÿßŸÑŸÉŸáŸÅ',uz:'Al-Kahf',ayat:110,type:'Makka'},
  {n:19,ar:'ŸÖÿ±ŸäŸÖ',uz:'Maryam',ayat:98,type:'Makka'},
  {n:20,ar:'ÿ∑Ÿá',uz:'To Ha',ayat:135,type:'Makka'},
  {n:21,ar:'ÿßŸÑÿ£ŸÜÿ®Ÿäÿßÿ°',uz:'Al-Anbiyo',ayat:112,type:'Makka'},
  {n:22,ar:'ÿßŸÑÿ≠ÿ¨',uz:'Al-Haj',ayat:78,type:'Madina'},
  {n:23,ar:'ÿßŸÑŸÖÿ§ŸÖŸÜŸàŸÜ',uz:'Al-Mo\'minun',ayat:118,type:'Makka'},
  {n:24,ar:'ÿßŸÑŸÜŸàÿ±',uz:'An-Nur',ayat:64,type:'Madina'},
  {n:25,ar:'ÿßŸÑŸÅÿ±ŸÇÿßŸÜ',uz:'Al-Furqon',ayat:77,type:'Makka'},
  {n:26,ar:'ÿßŸÑÿ¥ÿπÿ±ÿßÿ°',uz:'Ash-Shu\'aro',ayat:227,type:'Makka'},
  {n:27,ar:'ÿßŸÑŸÜŸÖŸÑ',uz:'An-Naml',ayat:93,type:'Makka'},
  {n:28,ar:'ÿßŸÑŸÇÿµÿµ',uz:'Al-Qasas',ayat:88,type:'Makka'},
  {n:29,ar:'ÿßŸÑÿπŸÜŸÉÿ®Ÿàÿ™',uz:'Al-Ankabut',ayat:69,type:'Makka'},
  {n:30,ar:'ÿßŸÑÿ±ŸàŸÖ',uz:'Ar-Rum',ayat:60,type:'Makka'},
  {n:31,ar:'ŸÑŸÇŸÖÿßŸÜ',uz:'Luqmon',ayat:34,type:'Makka'},
  {n:32,ar:'ÿßŸÑÿ≥ÿ¨ÿØÿ©',uz:'As-Sajda',ayat:30,type:'Makka'},
  {n:33,ar:'ÿßŸÑÿ£ÿ≠ÿ≤ÿßÿ®',uz:'Al-Ahzob',ayat:73,type:'Madina'},
  {n:34,ar:'ÿ≥ÿ®ÿ£',uz:'Saba',ayat:54,type:'Makka'},
  {n:35,ar:'ŸÅÿßÿ∑ÿ±',uz:'Fotir',ayat:45,type:'Makka'},
  {n:36,ar:'Ÿäÿ≥',uz:'Yo Sin',ayat:83,type:'Makka'},
  {n:37,ar:'ÿßŸÑÿµÿßŸÅÿßÿ™',uz:'As-Soffot',ayat:182,type:'Makka'},
  {n:38,ar:'ÿµ',uz:'Sod',ayat:88,type:'Makka'},
  {n:39,ar:'ÿßŸÑÿ≤ŸÖÿ±',uz:'Az-Zumar',ayat:75,type:'Makka'},
  {n:40,ar:'ÿ∫ÿßŸÅÿ±',uz:"G'ofir",ayat:85,type:'Makka'},
  {n:41,ar:'ŸÅÿµŸÑÿ™',uz:'Fussilat',ayat:54,type:'Makka'},
  {n:42,ar:'ÿßŸÑÿ¥Ÿàÿ±Ÿâ',uz:'Ash-Shura',ayat:53,type:'Makka'},
  {n:43,ar:'ÿßŸÑÿ≤ÿÆÿ±ŸÅ',uz:'Az-Zukhruf',ayat:89,type:'Makka'},
  {n:44,ar:'ÿßŸÑÿØÿÆÿßŸÜ',uz:'Ad-Dukhan',ayat:59,type:'Makka'},
  {n:45,ar:'ÿßŸÑÿ¨ÿßÿ´Ÿäÿ©',uz:'Al-Josiya',ayat:37,type:'Makka'},
  {n:46,ar:'ÿßŸÑÿ£ÿ≠ŸÇÿßŸÅ',uz:'Al-Ahqof',ayat:35,type:'Makka'},
  {n:47,ar:'ŸÖÿ≠ŸÖÿØ',uz:'Muhammad',ayat:38,type:'Madina'},
  {n:48,ar:'ÿßŸÑŸÅÿ™ÿ≠',uz:'Al-Fath',ayat:29,type:'Madina'},
  {n:49,ar:'ÿßŸÑÿ≠ÿ¨ÿ±ÿßÿ™',uz:'Al-Hujurot',ayat:18,type:'Madina'},
  {n:50,ar:'ŸÇ',uz:'Qof',ayat:45,type:'Makka'},
  {n:51,ar:'ÿßŸÑÿ∞ÿßÿ±Ÿäÿßÿ™',uz:'Az-Zoriyot',ayat:60,type:'Makka'},
  {n:52,ar:'ÿßŸÑÿ∑Ÿàÿ±',uz:'At-Tur',ayat:49,type:'Makka'},
  {n:53,ar:'ÿßŸÑŸÜÿ¨ŸÖ',uz:'An-Najm',ayat:62,type:'Makka'},
  {n:54,ar:'ÿßŸÑŸÇŸÖÿ±',uz:'Al-Qamar',ayat:55,type:'Makka'},
  {n:55,ar:'ÿßŸÑÿ±ÿ≠ŸÖŸÜ',uz:'Ar-Rohman',ayat:78,type:'Madina'},
  {n:56,ar:'ÿßŸÑŸàÿßŸÇÿπÿ©',uz:'Al-Voqia',ayat:96,type:'Makka'},
  {n:57,ar:'ÿßŸÑÿ≠ÿØŸäÿØ',uz:'Al-Hadid',ayat:29,type:'Madina'},
  {n:58,ar:'ÿßŸÑŸÖÿ¨ÿßÿØŸÑÿ©',uz:'Al-Mujodala',ayat:22,type:'Madina'},
  {n:59,ar:'ÿßŸÑÿ≠ÿ¥ÿ±',uz:'Al-Hashr',ayat:24,type:'Madina'},
  {n:60,ar:'ÿßŸÑŸÖŸÖÿ™ÿ≠ŸÜÿ©',uz:'Al-Mumtahana',ayat:13,type:'Madina'},
  {n:61,ar:'ÿßŸÑÿµŸÅ',uz:'As-Saff',ayat:14,type:'Madina'},
  {n:62,ar:'ÿßŸÑÿ¨ŸÖÿπÿ©',uz:'Al-Jum\'a',ayat:11,type:'Madina'},
  {n:63,ar:'ÿßŸÑŸÖŸÜÿßŸÅŸÇŸàŸÜ',uz:'Al-Munofiqun',ayat:11,type:'Madina'},
  {n:64,ar:'ÿßŸÑÿ™ÿ∫ÿßÿ®ŸÜ',uz:'At-Taghabun',ayat:18,type:'Madina'},
  {n:65,ar:'ÿßŸÑÿ∑ŸÑÿßŸÇ',uz:'At-Talaq',ayat:12,type:'Madina'},
  {n:66,ar:'ÿßŸÑÿ™ÿ≠ÿ±ŸäŸÖ',uz:'At-Tahrim',ayat:12,type:'Madina'},
  {n:67,ar:'ÿßŸÑŸÖŸÑŸÉ',uz:'Al-Mulk',ayat:30,type:'Makka'},
  {n:68,ar:'ÿßŸÑŸÇŸÑŸÖ',uz:'Al-Qalam',ayat:52,type:'Makka'},
  {n:69,ar:'ÿßŸÑÿ≠ÿßŸÇÿ©',uz:'Al-Haqqa',ayat:52,type:'Makka'},
  {n:70,ar:'ÿßŸÑŸÖÿπÿßÿ±ÿ¨',uz:'Al-Ma\'orij',ayat:44,type:'Makka'},
  {n:71,ar:'ŸÜŸàÿ≠',uz:'Nuh',ayat:28,type:'Makka'},
  {n:72,ar:'ÿßŸÑÿ¨ŸÜ',uz:'Al-Jin',ayat:28,type:'Makka'},
  {n:73,ar:'ÿßŸÑŸÖÿ≤ŸÖŸÑ',uz:'Al-Muzzammil',ayat:20,type:'Makka'},
  {n:74,ar:'ÿßŸÑŸÖÿØÿ´ÿ±',uz:'Al-Muddaththir',ayat:56,type:'Makka'},
  {n:75,ar:'ÿßŸÑŸÇŸäÿßŸÖÿ©',uz:'Al-Qiyoma',ayat:40,type:'Makka'},
  {n:76,ar:'ÿßŸÑÿ•ŸÜÿ≥ÿßŸÜ',uz:'Al-Inson',ayat:31,type:'Madina'},
  {n:77,ar:'ÿßŸÑŸÖÿ±ÿ≥ŸÑÿßÿ™',uz:'Al-Mursalot',ayat:50,type:'Makka'},
  {n:78,ar:'ÿßŸÑŸÜÿ®ÿ£',uz:'An-Naba',ayat:40,type:'Makka'},
  {n:79,ar:'ÿßŸÑŸÜÿßÿ≤ÿπÿßÿ™',uz:'An-Nozi\'ot',ayat:46,type:'Makka'},
  {n:80,ar:'ÿπÿ®ÿ≥',uz:'Abasa',ayat:42,type:'Makka'},
  {n:81,ar:'ÿßŸÑÿ™ŸÉŸàŸäÿ±',uz:'At-Takwir',ayat:29,type:'Makka'},
  {n:82,ar:'ÿßŸÑÿßŸÜŸÅÿ∑ÿßÿ±',uz:'Al-Infitor',ayat:19,type:'Makka'},
  {n:83,ar:'ÿßŸÑŸÖÿ∑ŸÅŸÅŸäŸÜ',uz:'Al-Mutaffifin',ayat:36,type:'Makka'},
  {n:84,ar:'ÿßŸÑÿßŸÜÿ¥ŸÇÿßŸÇ',uz:'Al-Inshiqoq',ayat:25,type:'Makka'},
  {n:85,ar:'ÿßŸÑÿ®ÿ±Ÿàÿ¨',uz:'Al-Buruj',ayat:22,type:'Makka'},
  {n:86,ar:'ÿßŸÑÿ∑ÿßÿ±ŸÇ',uz:'At-Toriq',ayat:17,type:'Makka'},
  {n:87,ar:'ÿßŸÑÿ£ÿπŸÑŸâ',uz:'Al-A\'lo',ayat:19,type:'Makka'},
  {n:88,ar:'ÿßŸÑÿ∫ÿßÿ¥Ÿäÿ©',uz:'Al-G\'oshiya',ayat:26,type:'Makka'},
  {n:89,ar:'ÿßŸÑŸÅÿ¨ÿ±',uz:'Al-Fajr',ayat:30,type:'Makka'},
  {n:90,ar:'ÿßŸÑÿ®ŸÑÿØ',uz:'Al-Balad',ayat:20,type:'Makka'},
  {n:91,ar:'ÿßŸÑÿ¥ŸÖÿ≥',uz:'Ash-Shams',ayat:15,type:'Makka'},
  {n:92,ar:'ÿßŸÑŸÑŸäŸÑ',uz:'Al-Layl',ayat:21,type:'Makka'},
  {n:93,ar:'ÿßŸÑÿ∂ÿ≠Ÿâ',uz:'Ad-Duho',ayat:11,type:'Makka'},
  {n:94,ar:'ÿßŸÑÿ¥ÿ±ÿ≠',uz:'Ash-Sharh',ayat:8,type:'Makka'},
  {n:95,ar:'ÿßŸÑÿ™ŸäŸÜ',uz:'At-Tin',ayat:8,type:'Makka'},
  {n:96,ar:'ÿßŸÑÿπŸÑŸÇ',uz:'Al-Alaq',ayat:19,type:'Makka'},
  {n:97,ar:'ÿßŸÑŸÇÿØÿ±',uz:'Al-Qadr',ayat:5,type:'Makka'},
  {n:98,ar:'ÿßŸÑÿ®ŸäŸÜÿ©',uz:'Al-Bayyina',ayat:8,type:'Madina'},
  {n:99,ar:'ÿßŸÑÿ≤ŸÑÿ≤ŸÑÿ©',uz:'Az-Zalzala',ayat:8,type:'Madina'},
  {n:100,ar:'ÿßŸÑÿπÿßÿØŸäÿßÿ™',uz:'Al-Odiyot',ayat:11,type:'Makka'},
  {n:101,ar:'ÿßŸÑŸÇÿßÿ±ÿπÿ©',uz:'Al-Qori\'a',ayat:11,type:'Makka'},
  {n:102,ar:'ÿßŸÑÿ™ŸÉÿßÿ´ÿ±',uz:'At-Takosur',ayat:8,type:'Makka'},
  {n:103,ar:'ÿßŸÑÿπÿµÿ±',uz:'Al-Asr',ayat:3,type:'Makka'},
  {n:104,ar:'ÿßŸÑŸáŸÖÿ≤ÿ©',uz:'Al-Humaza',ayat:9,type:'Makka'},
  {n:105,ar:'ÿßŸÑŸÅŸäŸÑ',uz:'Al-Fil',ayat:5,type:'Makka'},
  {n:106,ar:'ŸÇÿ±Ÿäÿ¥',uz:'Quraysh',ayat:4,type:'Makka'},
  {n:107,ar:'ÿßŸÑŸÖÿßÿπŸàŸÜ',uz:'Al-Mo\'un',ayat:7,type:'Makka'},
  {n:108,ar:'ÿßŸÑŸÉŸàÿ´ÿ±',uz:'Al-Kavshar',ayat:3,type:'Makka'},
  {n:109,ar:'ÿßŸÑŸÉÿßŸÅÿ±ŸàŸÜ',uz:'Al-Kofirun',ayat:6,type:'Makka'},
  {n:110,ar:'ÿßŸÑŸÜÿµÿ±',uz:'An-Nasr',ayat:3,type:'Madina'},
  {n:111,ar:'ÿßŸÑŸÖÿ≥ÿØ',uz:'Al-Masad',ayat:5,type:'Makka'},
  {n:112,ar:'ÿßŸÑÿ•ÿÆŸÑÿßÿµ',uz:'Al-Ikhlos',ayat:4,type:'Makka'},
  {n:113,ar:'ÿßŸÑŸÅŸÑŸÇ',uz:'Al-Falaq',ayat:5,type:'Makka'},
  {n:114,ar:'ÿßŸÑŸÜÿßÿ≥',uz:'An-Nos',ayat:6,type:'Makka'},
];

let currentReciter = 0;
let currentSurahIdx = null;
let isPlaying = false;
let filteredSurahs = [...SURAHS];

const audio = document.getElementById('audioEl');

// Build reciter chips
function buildReciters() {
  const row = document.getElementById('reciterRow');
  row.innerHTML = '';
  RECITERS.forEach((r, i) => {
    const chip = document.createElement('button');
    chip.className = 'reciter-chip' + (i === 0 ? ' active' : '');
    chip.textContent = r.name;
    chip.onclick = () => selectReciter(i);
    row.appendChild(chip);
  });
}

function selectReciter(i) {
  currentReciter = i;
  document.querySelectorAll('.reciter-chip').forEach((c, j) => c.classList.toggle('active', j === i));
  if (currentSurahIdx !== null) {
    const wasPlaying = isPlaying;
    loadSurah(currentSurahIdx, wasPlaying);
  }
}

// Build surah list
function buildSurahList(list) {
  const container = document.getElementById('surahList');
  if (list.length === 0) {
    container.innerHTML = '<div class="no-results">üîç Hech narsa topilmadi</div>';
    return;
  }
  container.innerHTML = '';
  list.forEach(s => {
    const item = document.createElement('div');
    item.className = 'surah-item' + (currentSurahIdx === s.n - 1 ? ' playing' : '');
    item.id = `surah-${s.n}`;
    item.innerHTML = `
      <div class="surah-num">${s.n}</div>
      <div class="surah-info">
        <div class="surah-name-ar">${s.ar}</div>
        <div class="surah-name-uz">${s.uz}</div>
      </div>
      <div class="surah-meta">${s.ayat} oyat<br><small>${s.type}</small></div>
      <div class="play-btn">${currentSurahIdx === s.n - 1 && isPlaying ? '‚è∏' : '‚ñ∂'}</div>
    `;
    item.onclick = () => {
      const idx = s.n - 1;
      if (currentSurahIdx === idx) {
        togglePlay();
      } else {
        loadSurah(idx, true);
      }
    };
    container.appendChild(item);
  });
}

function filterSurahs() {
  const q = document.getElementById('searchInput').value.toLowerCase().trim();
  if (!q) {
    filteredSurahs = [...SURAHS];
  } else {
    filteredSurahs = SURAHS.filter(s =>
      s.uz.toLowerCase().includes(q) ||
      s.ar.includes(q) ||
      String(s.n).includes(q)
    );
  }
  buildSurahList(filteredSurahs);
}

function getAudioUrl(surahNum) {
  const num = String(surahNum).padStart(3, '0');
  return RECITERS[currentReciter].base + num + '.mp3';
}

function loadSurah(idx, autoPlay = true) {
  currentSurahIdx = idx;
  const s = SURAHS[idx];
  const url = getAudioUrl(s.n);

  // Update player UI
  document.getElementById('playerTitle').textContent = `${s.n}. ${s.ar} ‚Äî ${s.uz}`;
  document.getElementById('playerReciter').textContent = RECITERS[currentReciter].name;
  document.getElementById('audioPlayer').classList.add('visible');
  document.getElementById('pageQuran').classList.add('player-open');
  document.getElementById('progressFill').style.width = '0%';
  document.getElementById('timeCurrent').textContent = '0:00';
  document.getElementById('timeDuration').textContent = '0:00';
  document.getElementById('playPauseBtn').innerHTML = '<div class="spin"></div>';

  audio.src = url;
  audio.load();
  if (autoPlay) {
    audio.play().then(() => {
      isPlaying = true;
      document.getElementById('playPauseBtn').textContent = '‚è∏';
    }).catch(() => {
      isPlaying = false;
      document.getElementById('playPauseBtn').textContent = '‚ñ∂';
    });
  }

  buildSurahList(filteredSurahs);
}

function togglePlay() {
  if (currentSurahIdx === null) return;
  if (isPlaying) {
    audio.pause();
    isPlaying = false;
    document.getElementById('playPauseBtn').textContent = '‚ñ∂';
  } else {
    audio.play().then(() => {
      isPlaying = true;
      document.getElementById('playPauseBtn').textContent = '‚è∏';
    });
  }
  buildSurahList(filteredSurahs);
}

function playNext() {
  if (currentSurahIdx === null) return;
  const next = (currentSurahIdx + 1) % SURAHS.length;
  loadSurah(next, true);
}

function playPrev() {
  if (currentSurahIdx === null) return;
  const prev = (currentSurahIdx - 1 + SURAHS.length) % SURAHS.length;
  loadSurah(prev, true);
}

function closePlayer() {
  audio.pause();
  isPlaying = false;
  currentSurahIdx = null;
  document.getElementById('audioPlayer').classList.remove('visible');
  document.getElementById('pageQuran').classList.remove('player-open');
  buildSurahList(filteredSurahs);
}

function seekAudio(e) {
  if (!audio.duration) return;
  const bar = document.getElementById('progressBar');
  const rect = bar.getBoundingClientRect();
  const ratio = (e.clientX - rect.left) / rect.width;
  audio.currentTime = ratio * audio.duration;
}

function fmtTime(s) {
  if (isNaN(s)) return '0:00';
  const m = Math.floor(s / 60);
  const sec = Math.floor(s % 60);
  return `${m}:${sec.toString().padStart(2, '0')}`;
}

audio.addEventListener('timeupdate', () => {
  if (!audio.duration) return;
  const pct = (audio.currentTime / audio.duration) * 100;
  document.getElementById('progressFill').style.width = pct + '%';
  document.getElementById('timeCurrent').textContent = fmtTime(audio.currentTime);
});

audio.addEventListener('durationchange', () => {
  document.getElementById('timeDuration').textContent = fmtTime(audio.duration);
});

audio.addEventListener('ended', () => {
  isPlaying = false;
  playNext();
});

audio.addEventListener('canplay', () => {
  if (isPlaying) document.getElementById('playPauseBtn').textContent = '‚è∏';
});

// ===================== INIT =====================
buildReciters();
document.getElementById('loadingMsg').style.display = 'none';
buildSurahList(SURAHS);

if (window.Telegram && window.Telegram.WebApp) {
  window.Telegram.WebApp.ready();
  window.Telegram.WebApp.expand();
}

window.addEventListener('load', () => setTimeout(startCompass, 600));
</script>
</body>
</html>
