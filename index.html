<!doctype html>
<html lang="uz">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"/>
  <title>Qibla Kompas</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{color-scheme:dark;--ok:#62ffb0;--cyan:#00d2ff;--bg:#070a0c}
    *{box-sizing:border-box}
    body{
      margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(0,195,255,.18), transparent 55%),
        radial-gradient(800px 520px at 80% 20%, rgba(255,0,200,.10), transparent 50%),
        radial-gradient(1000px 800px at 50% 90%, rgba(0,255,140,.08), transparent 60%),
        var(--bg);
      color:#fff;padding:18px;
    }
    .card{
      width:min(480px,100%);border-radius:22px;
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.12);
      box-shadow:0 26px 70px rgba(0,0,0,.48);
      backdrop-filter:blur(14px);
      padding:16px;
    }
    .top{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    h1{margin:0;font-size:18px;font-weight:900}
    .sub{margin:6px 0 0;opacity:.82;font-size:13px;line-height:1.35}
    .chip{display:inline-flex;gap:8px;align-items:center;padding:8px 10px;border-radius:999px;
      background:rgba(0,0,0,.22);border:1px solid rgba(255,255,255,.10);font-size:12px;white-space:nowrap}
    .dot{width:9px;height:9px;border-radius:50%;background:#ffd166;box-shadow:0 0 0 6px rgba(255,209,102,.12)}
    .dot.ok{background:var(--ok);box-shadow:0 0 0 6px rgba(98,255,176,.12)}
    .dot.bad{background:#ff9a9a;box-shadow:0 0 0 6px rgba(255,154,154,.12)}

    .compass{width:320px;height:320px;margin:14px auto 10px;position:relative}
    .dial{position:absolute;inset:0;border-radius:50%;
      background:radial-gradient(circle at 50% 50%, rgba(255,255,255,.08), rgba(0,0,0,.30));
      border:1px solid rgba(255,255,255,.14);
      box-shadow:inset 0 0 0 10px rgba(255,255,255,.03), 0 22px 56px rgba(0,0,0,.45);overflow:hidden}
    .dialRotate{position:absolute;inset:0;transform:rotate(0deg);transition:transform 90ms linear}
    .ticks{position:absolute;inset:18px;border-radius:50%;
      background:conic-gradient(rgba(255,255,255,.45) 0 1deg, transparent 1deg 10deg,
                               rgba(255,255,255,.22) 10deg 11deg, transparent 11deg 30deg);
      mask:radial-gradient(circle, transparent 0 62%, #000 63% 100%);opacity:.92}
    .N{position:absolute;left:50%;top:10px;transform:translateX(-50%);
      padding:6px 10px;border-radius:999px;background:rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);font-weight:900;font-size:12px}

    .needle{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      transform:rotate(0deg);transition:transform 90ms linear;pointer-events:none}
    .shaft{width:18px;height:126px;border-radius:14px;
      background:linear-gradient(to top, rgba(255,255,255,.10), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.18);box-shadow:0 14px 34px rgba(0,0,0,.40);position:relative}
    .shaft:before{
      content:"";position:absolute;top:-24px;left:50%;transform:translateX(-50%);
      width:0;height:0;border-left:16px solid transparent;border-right:16px solid transparent;
      border-bottom:28px solid var(--cyan);
      filter:drop-shadow(0 8px 12px rgba(0,210,255,.22));
      transition:border-bottom-color 120ms linear;
    }
    .shaft.ok:before{border-bottom-color:var(--ok);filter:drop-shadow(0 10px 14px rgba(98,255,176,.22))}
    .center{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
      width:12px;height:12px;border-radius:50%;background:rgba(255,255,255,.92);
      box-shadow:0 0 0 10px rgba(255,255,255,.10)}

    .big{margin-top:6px;text-align:center;font-weight:950;font-size:34px}
    .big span{opacity:.85;font-size:20px;font-weight:900;margin-left:8px}

    .stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .tile{border-radius:16px;padding:10px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10)}
    .tile b{display:block;font-size:12px;opacity:.75}
    .tile div{margin-top:4px;font-weight:900;font-size:16px}

    .btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{border:0;cursor:pointer;padding:10px 12px;border-radius:14px;font-weight:900;color:#fff;
      background:rgba(255,255,255,.10);border:1px solid rgba(255,255,255,.14)}
    button:active{transform:translateY(1px)}
    .primary{background:rgba(0,160,255,.22);border-color:rgba(0,160,255,.36)}
    .danger{background:rgba(255,80,80,.18);border-color:rgba(255,80,80,.32)}
    .hint{margin-top:10px;font-size:13px;opacity:.86;line-height:1.35}
  </style>
</head>
<body>
<div class="card">
  <div class="top">
    <div>
      <h1>üß≠ Qibla Kompas</h1>
      <div class="sub">Telegram ichida ishlaydi. Qibla topilganda strelka yashil bo‚Äòladi.</div>
    </div>
    <div class="chip"><span class="dot" id="dot"></span><span id="status">Boshlash bosing‚Ä¶</span></div>
  </div>

  <div class="compass">
    <div class="dial">
      <div class="dialRotate" id="dialRotate">
        <div class="ticks"></div>
        <div class="N">N</div>
      </div>
    </div>
    <div class="needle" id="needle"><div class="shaft" id="shaft"></div></div>
    <div class="center"></div>
  </div>

  <div class="big" id="bigDeg">‚Äî<span id="bigDir"></span></div>

  <div class="stats">
    <div class="tile"><b>Qibla (bearing)</b><div id="qiblaTxt">‚Äî</div></div>
    <div class="tile"><b>Heading</b><div id="headTxt">‚Äî</div></div>
    <div class="tile"><b>Farq (¬±)</b><div id="diffTxt">‚Äî</div></div>
    <div class="tile"><b>Joylashuv</b><div id="locTxt">‚Äî</div></div>
  </div>

  <div class="btns">
    <button class="primary" id="btnStart">Boshlash</button>
    <button id="btnPerm">Motion ruxsat</button>
    <button id="btnChrome">Chrome‚Äôda ochish</button>
    <button class="danger" id="btnStop">To‚Äòxtatish</button>
  </div>

  <div class="hint" id="hint">
    üí° Agar Telegram ichida kompas qotib qolsa ‚Äî bu WebView cheklovi bo‚Äòlishi mumkin.
    ‚ÄúChrome‚Äôda ochish‚Äù tugmasini bosing (1 bosishda ochadi).
  </div>
</div>

<script>
(() => {
  // Telegram init
  try { if (window.Telegram?.WebApp) { Telegram.WebApp.ready(); Telegram.WebApp.expand(); } } catch(e){}

  const KAABA = { lat: 21.422487, lon: 39.826206 };
  const TOL = 2; // ¬±2¬∞ ichida yashil

  const $ = id => document.getElementById(id);
  const dot = $('dot'), statusEl = $('status');
  const dialRotate = $('dialRotate');
  const needle = $('needle');
  const shaft = $('shaft');

  const qiblaTxt = $('qiblaTxt'), headTxt = $('headTxt'), diffTxt = $('diffTxt'), locTxt = $('locTxt');
  const bigDeg = $('bigDeg'), bigDir = $('bigDir');

  const btnStart = $('btnStart'), btnPerm = $('btnPerm'), btnStop = $('btnStop'), btnChrome = $('btnChrome');

  let watchId=null;
  let lat=null, lon=null;
  let qibla=null;

  let headingRaw=null;   // 0..360
  let heading=null;      // smoothed 0..360
  let gotAnySensorEvent = false;
  let sensorTimer = null;

  // throttle UI
  let lastUpdate=0;
  const UPDATE_MS=40;

  const toRad = d => d*Math.PI/180;
  const toDeg = r => r*180/Math.PI;
  const norm360 = x => ((x%360)+360)%360;

  function setStatus(t, kind){
    statusEl.textContent=t;
    dot.className = 'dot' + (kind==='ok'?' ok':kind==='bad'?' bad':'');
  }

  function dirText(deg){
    const dirs=["N","NE","E","SE","S","SW","W","NW"];
    return dirs[Math.round(deg/45)%8];
  }

  function angDiff(a,b){ // signed (-180..180)
    return ((a - b + 540) % 360) - 180;
  }

  function smoothAngle(prev,next,alpha=0.20){
    if(prev==null) return next;
    const d = angDiff(next, prev);
    return norm360(prev + d*alpha);
  }

  function bearing(lat1, lon1, lat2, lon2){
    const œÜ1=toRad(lat1), œÜ2=toRad(lat2);
    const ŒîŒª=toRad(lon2-lon1);
    const y=Math.sin(ŒîŒª)*Math.cos(œÜ2);
    const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
    return norm360(toDeg(Math.atan2(y,x)));
  }

  function screenAngle(){
    const so = screen.orientation && typeof screen.orientation.angle === 'number'
      ? screen.orientation.angle
      : (typeof window.orientation === 'number' ? window.orientation : 0);
    return so || 0;
  }

  function computeHeading(e){
    // iOS best
    if(typeof e.webkitCompassHeading === 'number') return norm360(e.webkitCompassHeading);

    // Android WebView/Chrome
    if(typeof e.alpha === 'number'){
      // compensate screen rotation
      return norm360(e.alpha + screenAngle());
    }
    return null;
  }

  function updateUI(force=false){
    const now=Date.now();
    if(!force && now-lastUpdate<UPDATE_MS) return;
    lastUpdate=now;

    if(lat!=null && lon!=null){
      locTxt.textContent = `${lat.toFixed(5)}, ${lon.toFixed(5)}`;
      qibla = bearing(lat, lon, KAABA.lat, KAABA.lon);
      qiblaTxt.textContent = `${qibla.toFixed(1)}¬∞`;
      bigDeg.firstChild.nodeValue = `${Math.round(qibla)}¬∞`;
      bigDir.textContent = dirText(qibla);
    }

    if(headingRaw!=null){
      heading = smoothAngle(heading, headingRaw);
      headTxt.textContent = `${heading.toFixed(1)}¬∞`;
      dialRotate.style.transform = `rotate(${-heading}deg)`;
    }

    if(qibla!=null && heading!=null){
      const rot = norm360(qibla - heading);
      needle.style.transform = `rotate(${rot}deg)`;

      const d = Math.abs(angDiff(qibla, heading));
      diffTxt.textContent = `${d.toFixed(1)}¬∞`;

      const ok = d <= TOL;
      shaft.classList.toggle('ok', ok);
      setStatus(ok ? `Topildi ‚úÖ (¬±${TOL}¬∞)` : 'Yo‚Äònaltiring‚Ä¶', ok?'ok':'');
    } else {
      setStatus('Ruxsat/GPS kutilyapti‚Ä¶', '');
    }
  }

  // SENSOR
  function onOri(e){
    const h = computeHeading(e);
    if(h==null) return;
    gotAnySensorEvent = true;
    headingRaw = h;
    updateUI();
  }

  function startOri(){
    window.addEventListener('deviceorientationabsolute', onOri, true);
    window.addEventListener('deviceorientation', onOri, true);

    // If in 2 seconds we got nothing -> show strong hint
    clearTimeout(sensorTimer);
    sensorTimer = setTimeout(() => {
      if(!gotAnySensorEvent){
        setStatus('Telegram WebView kompas bermayapti üò¨', 'bad');
      }
    }, 2000);
  }

  function stopOri(){
    window.removeEventListener('deviceorientationabsolute', onOri, true);
    window.removeEventListener('deviceorientation', onOri, true);
  }

  async function requestMotion(){
    try{
      const D = window.DeviceOrientationEvent;
      if(D && typeof D.requestPermission === 'function'){
        const res = await D.requestPermission();
        if(res === 'granted'){
          setStatus('Motion ruxsat ‚úÖ', 'ok');
          startOri();
        } else setStatus('Motion ruxsat berilmadi', 'bad');
      } else {
        startOri();
        setStatus('Kompas ishga tushdi‚Ä¶', '');
      }
    } catch(err){
      setStatus('Motion xato: '+err.message, 'bad');
    }
  }

  // GEO
  function startGeo(){
    if(!navigator.geolocation){ setStatus('GPS yo‚Äòq', 'bad'); return; }
    if(watchId!=null) return;
    setStatus('GPS olinmoqda‚Ä¶', '');
    watchId = navigator.geolocation.watchPosition(
      p => { lat=p.coords.latitude; lon=p.coords.longitude; updateUI(true); },
      e => { setStatus('GPS xato: '+e.message, 'bad'); },
      { enableHighAccuracy:true, maximumAge:1500, timeout:15000 }
    );
  }

  function stopGeo(){
    if(watchId!=null) navigator.geolocation.clearWatch(watchId);
    watchId=null;
  }

  // Buttons
  btnStart.onclick = async () => { startGeo(); gotAnySensorEvent=false; await requestMotion(); updateUI(true); };
  btnPerm.onclick  = requestMotion;
  btnStop.onclick  = () => {
    stopGeo(); stopOri();
    lat=lon=qibla=headingRaw=heading=null;
    gotAnySensorEvent=false;
    needle.style.transform='rotate(0deg)';
    dialRotate.style.transform='rotate(0deg)';
    qiblaTxt.textContent=headTxt.textContent=diffTxt.textContent=locTxt.textContent='‚Äî';
    bigDeg.firstChild.nodeValue='‚Äî'; bigDir.textContent='';
    shaft.classList.remove('ok');
    setStatus('To‚Äòxtatildi', '');
  };

  // Open in Chrome from Telegram (best workaround)
  btnChrome.onclick = () => {
    const url = window.location.href;
    try{
      if(window.Telegram?.WebApp?.openLink){
        Telegram.WebApp.openLink(url, { try_instant_view: false });
      } else {
        window.open(url, '_blank');
      }
    }catch(e){
      window.open(url, '_blank');
    }
  };

  setStatus('Boshlash bosing‚Ä¶', '');
})();
</script>
</body>
</html>
