<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Islomiy Ilova - Qibla & Qur'on</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Nunito:wght@400;600;700;800&family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
:root{
  --g:#1db954;--gd:#158f3e;--gold:#d4a843;
  --bg:#0a0f1a;--s1:#0b1e35;--s2:#102840;--s3:#163450;
  --bdr:rgba(29,185,84,0.18);--tx:#e8f4fd;--mt:#567a96;
  --gw:rgba(29,185,84,0.4);
}
html,body{height:100%;overflow:hidden;}
body{font-family:'Tajawal',sans-serif;background:var(--bg);color:var(--tx);
  display:flex;flex-direction:column;height:100dvh;}

/* Stars */
.stars{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
.star{position:absolute;border-radius:50%;background:#fff;opacity:0;animation:tw var(--d) ease-in-out infinite var(--dl)}
@keyframes tw{0%,100%{opacity:0}50%{opacity:.65}}

/* NAV */
.nav{display:flex;background:var(--s1);border-bottom:1px solid var(--bdr);flex-shrink:0;z-index:50;}
.nb{flex:1;padding:13px 8px 11px;border:none;background:transparent;color:var(--mt);
  font-family:'Tajawal',sans-serif;font-size:12px;font-weight:500;cursor:pointer;
  display:flex;flex-direction:column;align-items:center;gap:3px;position:relative;transition:color .2s;}
.nb .ni{font-size:22px;}.nb.on{color:var(--g);}
.nb::after{content:'';position:absolute;bottom:0;left:25%;right:25%;height:2px;
  border-radius:2px 2px 0 0;background:var(--g);transform:scaleX(0);transition:transform .2s;}
.nb.on::after{transform:scaleX(1);}
.pages{flex:1;position:relative;overflow:hidden;}
.pg{position:absolute;inset:0;overflow-y:auto;overflow-x:hidden;
  -webkit-overflow-scrolling:touch;opacity:0;pointer-events:none;transition:opacity .2s;}
.pg.on{opacity:1;pointer-events:all;}
.pg::-webkit-scrollbar{width:3px;}
.pg::-webkit-scrollbar-thumb{background:var(--s3);border-radius:3px;}

/* QIBLA */
#pg0{display:flex;flex-direction:column;align-items:center;padding-bottom:24px;}
.qstatus{z-index:10;display:flex;align-items:center;gap:7px;padding:10px 0 4px}
.qdot{width:8px;height:8px;border-radius:50%;background:#3a4455;transition:all .4s}
.qdot.on{background:#22c55e;box-shadow:0 0 8px rgba(34,197,94,.6);animation:pd 1.8s infinite}
@keyframes pd{0%,100%{transform:scale(1)}50%{transform:scale(1.3)}}
.qstxt{font-size:11px;color:#6b7685;font-weight:700;letter-spacing:1px}

.qcwrap{z-index:10;position:relative;display:flex;align-items:center;justify-content:center;margin:4px 0 8px}
.qgring{position:absolute;border-radius:50%;width:306px;height:306px;box-shadow:0 0 38px 5px rgba(34,197,94,.1);transition:box-shadow .7s;pointer-events:none;}
.qgring.on{box-shadow:0 0 65px 22px rgba(34,197,94,.55),0 0 120px 45px rgba(34,197,94,.22);animation:qgp 1.1s ease-in-out infinite;}
@keyframes qgp{0%,100%{box-shadow:0 0 65px 22px rgba(34,197,94,.55),0 0 120px 45px rgba(34,197,94,.22)}50%{box-shadow:0 0 85px 32px rgba(34,197,94,.75),0 0 160px 65px rgba(34,197,94,.3)}}
#qcv{width:295px;height:295px;border-radius:50%;display:block}
.qkaaba{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:58px;height:58px;border-radius:50%;background:radial-gradient(circle at 38% 32%,#42a5f5,#0d47a1);display:flex;align-items:center;justify-content:center;font-size:28px;z-index:20;box-shadow:0 0 0 3px rgba(255,255,255,.12),0 4px 18px rgba(0,0,0,.55);transition:box-shadow .5s;}
.qkaaba.on{box-shadow:0 0 0 4px #22c55e,0 0 24px rgba(34,197,94,.65)}

.qdegwrap{z-index:10;text-align:center;margin-bottom:8px}
.qdval{font-family:'Nunito',sans-serif;font-size:52px;font-weight:800;color:#e8edf5;letter-spacing:-2px;line-height:1;transition:color .5s}
.qdval.on{color:#22c55e}
.qddir{font-size:13px;color:#6b7685;letter-spacing:2px;font-weight:700;text-transform:uppercase;margin-top:2px}
.qbadge{display:inline-block;background:#121826;border:1px solid rgba(255,255,255,.07);border-radius:20px;padding:5px 14px;font-size:12px;color:#6b7685;margin-top:5px;}
.qbadge b{color:#f0c040;font-weight:700}

.qloccard{z-index:10;width:calc(100% - 32px);max-width:340px;background:#131922;border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:13px 16px;display:flex;align-items:center;gap:12px;margin-bottom:10px;}
.qlocico{width:38px;height:38px;border-radius:12px;background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.2);display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
.qlocname{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.qloccoords{font-size:11px;color:#6b7685;margin-top:1px}

.qbanner{z-index:10;width:calc(100% - 32px);max-width:340px;background:linear-gradient(135deg,rgba(34,197,94,.16),rgba(34,197,94,.05));border:1px solid rgba(34,197,94,.35);border-radius:14px;padding:12px 16px;display:flex;align-items:center;gap:10px;opacity:0;transform:translateY(8px);transition:opacity .5s,transform .5s;}
.qbanner.show{opacity:1;transform:translateY(0)}
.qbt{font-size:14px;font-weight:800;color:#22c55e}
.qbs{font-size:11px;color:#6b7685}

.qdbg{z-index:10;width:calc(100% - 32px);max-width:340px;background:#0f1520;border:1px solid rgba(255,255,255,.06);border-radius:12px;padding:10px 14px;margin-top:8px;font-size:11px;color:#6b7685;line-height:1.8;display:none;}
.qdbg.show{display:block}

.qls{position:fixed;inset:0;background:#0a0f1a;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:300;gap:16px;transition:opacity .6s;}
.qls.hide{opacity:0;pointer-events:none}
.qlic{font-size:66px;animation:qfl 2.2s ease-in-out infinite}
@keyframes qfl{0%,100%{transform:translateY(0) rotate(-3deg)}50%{transform:translateY(-13px) rotate(3deg)}}
.qspin{width:34px;height:34px;border-radius:50%;border:3px solid rgba(255,255,255,.08);border-top-color:#22c55e;animation:qsp .8s linear infinite}
@keyframes qsp{to{transform:rotate(360deg)}}
.qlsub{font-size:13px;color:rgba(107,118,133,.75)}
.qpbtn{display:none;background:linear-gradient(135deg,#22c55e,#15803d);border:none;color:#fff;padding:14px 32px;border-radius:50px;font-size:15px;font-family:inherit;font-weight:800;cursor:pointer;box-shadow:0 4px 22px rgba(34,197,94,.4);letter-spacing:.5px;}
.qpbtn:active{transform:scale(.96)}

@keyframes qflash{0%,100%{background:#0a0f1a}45%{background:rgba(34,197,94,.07)}}
body.qfl{animation:qflash .7s ease}

/* QURAN */
.qrp{display:flex;flex-direction:column;}
.qhdr{padding:13px 13px 9px;background:var(--s1);border-bottom:1px solid var(--bdr);position:sticky;top:0;z-index:10;}
.qhdr h2{font-family:'Amiri',serif;font-size:20px;color:var(--gold);text-shadow:0 0 12px rgba(212,168,67,.3);text-align:center;margin-bottom:8px;}
.sbox{position:relative;}
.sbox input{width:100%;background:var(--s2);border:1.5px solid var(--bdr);border-radius:10px;padding:9px 12px 9px 36px;color:var(--tx);font-family:'Tajawal',sans-serif;font-size:13px;outline:none;}
.sbox input:focus{border-color:var(--g);}
.sbox input::placeholder{color:var(--mt);}
.si{position:absolute;left:11px;top:50%;transform:translateY(-50%);font-size:14px;pointer-events:none;}
.rcrow{display:flex;gap:6px;margin-top:8px;overflow-x:auto;padding-bottom:2px;}
.rcrow::-webkit-scrollbar{display:none;}
.rchip{flex-shrink:0;padding:5px 12px;border-radius:20px;border:1.5px solid var(--bdr);background:var(--s2);color:var(--mt);font-size:11px;cursor:pointer;transition:all .2s;font-family:'Tajawal',sans-serif;white-space:nowrap;}
.rchip.on{background:rgba(29,185,84,.15);border-color:var(--g);color:var(--g);}
.slist{padding:8px 10px 160px;}
.si2{display:flex;align-items:center;gap:10px;padding:10px 11px;border-radius:11px;background:var(--s1);border:1px solid var(--bdr);margin-bottom:5px;cursor:pointer;transition:background .15s;position:relative;overflow:hidden;}
.si2.pl{background:rgba(29,185,84,.1);border-color:var(--g);}
.si2::before{content:'';position:absolute;left:0;top:0;bottom:0;width:3px;background:var(--g);transform:scaleY(0);transition:transform .2s;border-radius:0 2px 2px 0;}
.si2.pl::before{transform:scaleY(1);}
.sno{width:32px;height:32px;background:var(--s2);border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--g);flex-shrink:0;border:1px solid var(--bdr);}
.si2.pl .sno{background:var(--g);color:#fff;border-color:var(--g);}
.sinf{flex:1;min-width:0;}
.sar{font-family:'Amiri',serif;font-size:15px;color:var(--tx);}
.suz{font-size:10px;color:var(--mt);margin-top:1px;}
.smeta{font-size:10px;color:var(--mt);text-align:right;flex-shrink:0;line-height:1.5;}
.pbtn{width:32px;height:32px;border-radius:50%;background:var(--s2);border:1px solid var(--bdr);display:flex;align-items:center;justify-content:center;font-size:12px;flex-shrink:0;}
.si2.pl .pbtn{background:var(--g);border-color:var(--g);}
.nores{text-align:center;padding:40px 20px;color:var(--mt);font-size:13px;}

/* PLAYER */
.player{position:fixed;bottom:0;left:0;right:0;background:linear-gradient(0deg,#081828 0%,rgba(11,30,53,.99) 100%);border-top:1px solid var(--bdr);padding:10px 14px 20px;z-index:200;transform:translateY(100%);transition:transform .3s cubic-bezier(.4,0,.2,1);box-shadow:0 -8px 30px rgba(0,0,0,.7);}
.player.vis{transform:translateY(0);}
.pinfo{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:6px;}
.ptit{font-family:'Amiri',serif;font-size:15px;color:var(--gold);}
.psub{font-size:10px;color:var(--mt);margin-top:2px;}
.pcls{background:none;border:none;color:var(--mt);font-size:18px;cursor:pointer;padding:2px 6px;}
.prow{display:flex;align-items:center;gap:8px;margin-bottom:8px;}
.ptm{font-size:11px;color:var(--mt);min-width:30px;font-variant-numeric:tabular-nums;}
.pbar{flex:1;height:5px;background:var(--s3);border-radius:5px;cursor:pointer;}
.pfil{height:100%;background:var(--g);border-radius:5px;width:0%;transition:width .25s linear;pointer-events:none;}
.pctrls{display:flex;align-items:center;justify-content:center;gap:20px;}
.cbtn{background:none;border:none;color:var(--mt);font-size:22px;cursor:pointer;padding:4px;}
.ppbtn{width:50px;height:50px;border-radius:50%;background:var(--g);border:none;display:flex;align-items:center;justify-content:center;font-size:22px;cursor:pointer;box-shadow:0 4px 15px var(--gw);transition:transform .1s;}
.ppbtn:active{transform:scale(.92);}
.pmsg{font-size:11px;color:var(--mt);text-align:center;margin-top:5px;min-height:16px;line-height:1.4;}
.pmsg.err{color:#e74c3c;}
</style>
</head>
<body>

<div class="stars" id="stars"></div>

<div class="qls" id="QLS">
  <div class="qlic">üïå</div>
  <div style="font-size:18px;font-weight:800;color:#e8edf5">Qibla Kompas</div>
  <div id="QLSbody" style="display:flex;flex-direction:column;align-items:center;gap:11px">
    <div class="qspin"></div>
    <div class="qlsub">Yuklanmoqda...</div>
  </div>
  <button class="qpbtn" id="qpbtn">üìç Ruxsat berish</button>
</div>

<nav class="nav">
  <button class="nb on" id="nb0" onclick="goTab(0)"><span class="ni">üß≠</span><span>Qibla</span></button>
  <button class="nb" id="nb1" onclick="goTab(1)"><span class="ni">üìñ</span><span>Qur'on</span></button>
</nav>

<div class="pages">
  <div class="pg on" id="pg0">
    <div class="qstatus">
      <div class="qdot" id="qdot"></div>
      <div class="qstxt" id="qstxt">Sensor kutilmoqda...</div>
    </div>
    <div class="qcwrap">
      <div class="qgring" id="qgring"></div>
      <canvas id="qcv" width="590" height="590"></canvas>
      <div class="qkaaba" id="qkaaba">üïã</div>
    </div>
    <div class="qdegwrap">
      <div class="qdval" id="qdval">--¬∞</div>
      <div class="qddir" id="qddir">Yuklanmoqda</div>
      <div class="qbadge">Qibla: <b id="qqbdg">--¬∞</b></div>
    </div>
    <div class="qloccard">
      <div class="qlocico">üìç</div>
      <div style="min-width:0;flex:1">
        <div class="qlocname" id="qlname">Joylashuv aniqlanmoqda...</div>
        <div class="qloccoords" id="qlcoords"></div>
      </div>
    </div>
    <div class="qbanner" id="qbanner">
      <div style="font-size:22px">‚ú®</div>
      <div>
        <div class="qbt">Qibla topildi!</div>
        <div class="qbs">Siz to'g'ri yo'nalishdasiz ‚Äî Alloh qabul qilsin</div>
      </div>
    </div>
    <div class="qdbg" id="qdbg"></div>
  </div>

  <div class="pg qrp" id="pg1">
    <div class="qhdr">
      <h2>üìñ Qur'oni Karim</h2>
      <div class="sbox"><span class="si">üîç</span>
        <input id="srch" type="text" placeholder="Sura nomi yoki raqami..." oninput="doFilter()">
      </div>
      <div class="rcrow" id="rcrow"></div>
    </div>
    <div class="slist" id="slist"></div>
  </div>
</div>

<div class="player" id="player">
  <div class="pinfo">
    <div><div class="ptit" id="ptit">‚Äî</div><div class="psub" id="psub">‚Äî</div></div>
    <button class="pcls" onclick="closePlayer()">‚úï</button>
  </div>
  <div class="prow">
    <span class="ptm" id="tc">0:00</span>
    <div class="pbar" id="pbar" onclick="seekAudio(event)"><div class="pfil" id="pfil"></div></div>
    <span class="ptm" id="td">--:--</span>
  </div>
  <div class="pctrls">
    <button class="cbtn" onclick="moveSurah(-1)">‚èÆ</button>
    <button class="ppbtn" id="ppbtn" onclick="togglePlay()">‚ñ∂</button>
    <button class="cbtn" onclick="moveSurah(1)">‚è≠</button>
  </div>
  <div class="pmsg" id="pmsg"></div>
</div>
<audio id="au" preload="none"></audio>

<script>
'use strict';

function goTab(i){
  [0,1].forEach(j=>{
    document.getElementById('nb'+j).classList.toggle('on',j===i);
    document.getElementById('pg'+j).classList.toggle('on',j===i);
  });
}

// Stars
(()=>{
  const c=document.getElementById('stars');
  for(let i=0;i<75;i++){
    const s=document.createElement('div');s.className='star';
    const sz=Math.random()<.25?3:Math.random()<.5?2:1;
    s.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--d:${1.8+Math.random()*5}s;--dl:-${Math.random()*7}s`;
    c.appendChild(s);
  }
})();

const KA_LAT=21.4225,KA_LON=39.8262;
let userLat=41.2995,userLon=69.2401;
let qiblaTrue=0,rawHead=0,smoothHead=0,sensorOK=false,gpsOK=false,prevAligned=false,kaabaClicks=0;

function calcQibla(lat,lon){
  const R=d=>d*Math.PI/180,œÜ1=R(lat),œÜ2=R(KA_LAT),ŒîŒª=R(KA_LON-lon);
  const y=Math.sin(ŒîŒª)*Math.cos(œÜ2);
  const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
  return norm(Math.atan2(y,x)*180/Math.PI);
}
function norm(a){return((a%360)+360)%360;}
function lerpAng(cur,tgt,t){let d=norm(tgt)-norm(cur);if(d>180)d-=360;if(d<-180)d+=360;return cur+d*t;}
function isAligned(){let d=norm(qiblaTrue)-norm(smoothHead);if(d>180)d-=360;if(d<-180)d+=360;return Math.abs(d)<5;}
function cardDir(deg){return["Shimol","Shim-Sharq","Sharq","Jan-Sharq","Janub","Jan-G ªarb","G ªarb","Shim-G ªarb"][Math.round(norm(deg)/45)%8];}

const qcv=document.getElementById('qcv');
const qctx=qcv.getContext('2d');
const SZ=590,CX=SZ/2,CY=SZ/2;

function drawCompass(heading){
  qctx.clearRect(0,0,SZ,SZ);
  const aln=isAligned();
  const rim=qctx.createLinearGradient(0,0,SZ,SZ);
  if(aln){rim.addColorStop(0,'#4ade80');rim.addColorStop(1,'#16a34a');}
  else{rim.addColorStop(0,'#22c55e');rim.addColorStop(1,'#0b5e22');}
  qctx.beginPath();qctx.arc(CX,CY,287,0,Math.PI*2);qctx.fillStyle=rim;qctx.fill();
  const face=qctx.createRadialGradient(CX,CY,50,CX,CY,255);
  face.addColorStop(0,'#1a2030');face.addColorStop(1,'#0a0f1a');
  qctx.beginPath();qctx.arc(CX,CY,257,0,Math.PI*2);
  qctx.fillStyle=face;
  qctx.shadowColor=aln?'rgba(34,197,94,.28)':'transparent';
  qctx.shadowBlur=aln?32:0;
  qctx.fill();qctx.shadowBlur=0;

  qctx.save();qctx.translate(CX,CY);qctx.rotate(-heading*Math.PI/180);
  for(let i=0;i<360;i++){
    const rad=i*Math.PI/180,maj=i%30===0,med=i%10===0&&!maj;
    const len=maj?25:med?15:8,r1=250,r2=r1-len;
    qctx.beginPath();
    qctx.moveTo(Math.cos(rad)*r1,Math.sin(rad)*r1);
    qctx.lineTo(Math.cos(rad)*r2,Math.sin(rad)*r2);
    qctx.strokeStyle=maj?'rgba(255,255,255,.88)':med?'rgba(255,255,255,.35)':'rgba(255,255,255,.11)';
    qctx.lineWidth=maj?2.6:1.6;qctx.stroke();
  }
  qctx.font='600 17px Nunito,sans-serif';qctx.fillStyle='rgba(190,205,225,.62)';
  qctx.textA
(Content truncated due to size limit. Use line ranges to read remaining content)
