<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qibla Kompas</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
        }
        #compass-container {
            position: relative;
            width: 300px;
            height: 300px;
            border: 10px solid gray;
            border-radius: 50%;
        }
        #compass {
            width: 300px;
            height: 300px;
        }
        #direction {
            font-size: 24px;
            margin-top: 20px;
        }
        #location {
            font-size: 18px;
            margin-top: 10px;
        }
        .border-green {
            border-color: green;
        }
        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 300px;
            height: 300px;
            pointer-events: none;
            display: none;
        }
        .star {
            position: absolute;
            width: 20px;
            height: 20px;
            background: gold;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            opacity: 0;
            animation: sparkle 1s infinite;
        }
        @keyframes sparkle {
            0% { opacity: 0; transform: scale(0) rotate(0deg); }
            50% { opacity: 1; transform: scale(1) rotate(180deg); }
            100% { opacity: 0; transform: scale(0) rotate(360deg); }
        }
        .star1 { top: 10%; left: 20%; animation-delay: 0s; }
        .star2 { top: 20%; left: 70%; animation-delay: 0.2s; }
        .star3 { top: 50%; left: 10%; animation-delay: 0.4s; }
        .star4 { top: 70%; left: 80%; animation-delay: 0.6s; }
        .star5 { top: 40%; left: 50%; animation-delay: 0.8s; }
        .star6 { top: 80%; left: 30%; animation-delay: 1s; }
        .star7 { top: 30%; left: 40%; animation-delay: 1.2s; }
        .star8 { top: 60%; left: 60%; animation-delay: 1.4s; }
    </style>
</head>
<body>
    <h1>Qibla Kompas</h1>
    <div id="compass-container">
        <canvas id="compass" width="300" height="300"></canvas>
        <div class="stars" id="stars">
            <div class="star star1"></div>
            <div class="star star2"></div>
            <div class="star star3"></div>
            <div class="star star4"></div>
            <div class="star star5"></div>
            <div class="star star6"></div>
            <div class="star star7"></div>
            <div class="star star8"></div>
        </div>
    </div>
    <div id="direction">0° N</div>
    <div id="location">Joylashuv aniqlanmoqda...</div>
    <script>
        const meccaLat = 21.4225;
        const meccaLon = 39.8262;
        let qiblaBearing = 0;
        let currentHeading = 0;
        const canvas = document.getElementById('compass');
        const ctx = canvas.getContext('2d');
        const radius = 150;
        const center = radius;
        const container = document.getElementById('compass-container');
        const directionText = document.getElementById('direction');
        const locationText = document.getElementById('location');
        const stars = document.getElementById('stars');

        function drawDial() {
            // Doira
            ctx.beginPath();
            ctx.arc(center, center, radius - 10, 0, 2 * Math.PI);
            ctx.strokeStyle = 'lightblue';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Graduslar va chiziqlar
            ctx.font = '12px Arial';
            ctx.fillStyle = 'black';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            for (let i = 0; i < 360; i += 10) {
                const angle = (i * Math.PI / 180) - Math.PI / 2; // Topdan boshlab
                const sin = Math.sin(angle);
                const cos = Math.cos(angle);
                ctx.beginPath();
                ctx.moveTo(center + (radius - 20) * sin, center + (radius - 20) * cos);
                ctx.lineTo(center + (radius - 5) * sin, center + (radius - 5) * cos);
                ctx.strokeStyle = 'lightblue';
                ctx.lineWidth = 1;
                ctx.stroke();
                if (i % 30 === 0) {
                    ctx.fillText(i.toString(), center + (radius - 35) * sin, center + (radius - 35) * cos);
                }
            }

            // Tomonlar
            const dirLabels = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            const dirAngles = [0, 45, 90, 135, 180, 225, 270, 315];
            for (let i = 0; i < 8; i++) {
                const angle = (dirAngles[i] * Math.PI / 180) - Math.PI / 2;
                const sin = Math.sin(angle);
                const cos = Math.cos(angle);
                ctx.fillText(dirLabels[i], center + (radius - 60) * sin, center + (radius - 60) * cos);
            }
        }

        function drawKaaba() {
            // Oddiy Kaaba ikoni
            ctx.beginPath();
            ctx.rect(center - 20, center - 20, 40, 40);
            ctx.fillStyle = 'black';
            ctx.fill();
            ctx.beginPath();
            ctx.arc(center, center, 20, 0, 2 * Math.PI);
            ctx.fillStyle = 'blue';
            ctx.fill();
        }

        function drawArrow() {
            // Strelka (yashil uchburchak yuqoriga qarab)
            ctx.beginPath();
            ctx.moveTo(center, center - radius + 50);
            ctx.lineTo(center - 20, center - 20);
            ctx.lineTo(center + 20, center - 20);
            ctx.closePath();
            ctx.fillStyle = 'green';
            ctx.fill();
        }

        function updateCompass() {
            let relative = qiblaBearing - currentHeading;
            relative = (relative + 360) % 360;
            if (relative > 180) relative -= 360;

            const isAligned = Math.abs(relative) < 5;
            if (isAligned) {
                container.classList.add('border-green');
                stars.style.display = 'block';
            } else {
                container.classList.remove('border-green');
                stars.style.display = 'none';
            }

            ctx.clearRect(0, 0, 300, 300);
            drawDial();
            drawKaaba();
            ctx.save();
            ctx.translate(center, center);
            ctx.rotate(relative * Math.PI / 180);
            ctx.translate(-center, -center);
            drawArrow();
            ctx.restore();
        }

        function calculateQibla(lat, lon) {
            const lat1 = lat * Math.PI / 180;
            const lon1 = lon * Math.PI / 180;
            const lat2 = meccaLat * Math.PI / 180;
            const lon2 = meccaLon * Math.PI / 180;
            const dLon = lon2 - lon1;
            const y = Math.sin(dLon) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
            let bearing = Math.atan2(y, x) * 180 / Math.PI;
            bearing = (bearing + 360) % 360;
            qiblaBearing = bearing;
            directionText.textContent = Math.round(bearing) + '° ' + bearingToDirection(bearing);
            updateCompass();
        }

        function bearingToDirection(bearing) {
            const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
            const index = Math.round(bearing / 45) % 8;
            return directions[index];
        }

        function getLocationName(lat, lon) {
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=10&addressdetails=1`)
                .then(response => response.json())
                .then(data => {
                    locationText.textContent = data.display_name || 'Noma\'lum joy';
                })
                .catch(() => {
                    locationText.textContent = 'Joylashuv nomi topilmadi';
                });
        }

        function onOrientation(e) {
            let heading;
            if (e.webkitCompassHeading !== undefined) {
                heading = e.webkitCompassHeading;
            } else if (e.alpha !== null) {
                heading = 360 - e.alpha;
            } else {
                return;
            }
            currentHeading = heading;
            updateCompass();
        }

        function requestPermission() {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permission => {
                        if (permission === 'granted') {
                            window.addEventListener('deviceorientation', onOrientation);
                        } else {
                            alert('Ruxsat berilmadi');
                        }
                    })
                    .catch(console.error);
            } else {
                window.addEventListener('deviceorientation', onOrientation);
            }
        }

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                position => {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    calculateQibla(lat, lon);
                    getLocationName(lat, lon);
                    requestPermission();
                },
                error => {
                    locationText.textContent = 'Joylashuvga ruxsat berilmadi';
                    alert('Joylashuv ma\'lumotlariga ruxsat bering');
                }
            );
        } else {
            locationText.textContent = 'Geolokatsiya qo\'llab-quvvatlanmaydi';
        }

        // Dastlabki chizish
        drawDial();
        drawKaaba();
        drawArrow();
    </script>
</body>
</html>
