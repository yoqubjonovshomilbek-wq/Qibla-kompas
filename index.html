<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Qibla Kompas</title>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }

  body {
    background: #0d1117;
    color: #e6edf3;
    font-family: 'Nunito', sans-serif;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    overflow-x: hidden;
    padding-bottom: 30px;
  }

  .stars { position:fixed; inset:0; z-index:0; pointer-events:none; overflow:hidden; }
  .star {
    position:absolute; border-radius:50%;
    background:#fff; opacity:0;
    animation: twinkle var(--d) ease-in-out infinite var(--delay);
  }
  @keyframes twinkle { 0%,100%{ opacity:0; } 50%{ opacity:0.6; } }

  .header {
    z-index:10; width:100%;
    display:flex; align-items:center; justify-content:center;
    padding: 20px 20px 6px;
    flex-direction:column; gap:2px;
  }
  .arabic { font-family:'Amiri',serif; font-size:26px; color:#f0c040; }
  .latin  { font-size:12px; color:#8b949e; letter-spacing:4px; text-transform:uppercase; font-weight:700; }

  .status {
    z-index:10; display:flex; align-items:center; gap:8px;
    padding: 4px 0 10px;
  }
  .dot {
    width:8px; height:8px; border-radius:50%; background:#8b949e;
    transition: background 0.4s, box-shadow 0.4s;
  }
  .dot.on { background:#2ec55e; box-shadow:0 0 8px rgba(46,197,94,0.6); animation:pdot 1.8s infinite; }
  @keyframes pdot { 0%,100%{transform:scale(1)} 50%{transform:scale(1.35)} }
  .status-txt { font-size:12px; color:#8b949e; font-weight:700; letter-spacing:1px; }

  .compass-wrap {
    z-index:10; position:relative;
    display:flex; align-items:center; justify-content:center;
    margin: 4px 0 10px;
  }

  .glow-ring {
    position:absolute; border-radius:50%;
    width:300px; height:300px;
    box-shadow: 0 0 40px 6px rgba(46,197,94,0.12);
    transition: box-shadow 0.7s;
    pointer-events:none;
  }
  .glow-ring.aligned {
    box-shadow: 0 0 70px 25px rgba(46,197,94,0.55),
                0 0 130px 50px rgba(46,197,94,0.22);
    animation: gpulse 1s ease-in-out infinite;
  }
  @keyframes gpulse {
    0%,100%{ box-shadow:0 0 70px 25px rgba(46,197,94,0.55),0 0 130px 50px rgba(46,197,94,0.22); }
    50%    { box-shadow:0 0 90px 35px rgba(46,197,94,0.8),0 0 170px 70px rgba(46,197,94,0.35); }
  }

  canvas#c { width:290px; height:290px; border-radius:50%; display:block; }

  .kaaba {
    position:absolute; top:50%; left:50%;
    transform:translate(-50%,-50%);
    width:56px; height:56px; border-radius:50%;
    background:radial-gradient(circle at 38% 32%, #42a5f5, #0d47a1);
    display:flex; align-items:center; justify-content:center;
    font-size:28px; z-index:20;
    box-shadow:0 0 0 3px rgba(255,255,255,0.13), 0 4px 20px rgba(0,0,0,0.5);
    transition:box-shadow 0.5s;
  }
  .kaaba.aligned { box-shadow:0 0 0 4px #2ec55e, 0 0 26px rgba(46,197,94,0.7); }

  .deg-wrap { z-index:10; text-align:center; margin-bottom:10px; }
  .deg-val {
    font-size:54px; font-weight:800; color:#e6edf3;
    letter-spacing:-2px; line-height:1;
    transition:color 0.5s;
  }
  .deg-val.aligned { color:#2ec55e; }
  .deg-dir { font-size:14px; color:#8b949e; letter-spacing:2px; font-weight:700; text-transform:uppercase; margin-top:2px; }
  .qibla-badge {
    display:inline-block; background:#161b22;
    border:1px solid rgba(255,255,255,0.07);
    border-radius:20px; padding:5px 14px;
    font-size:12px; color:#8b949e; margin-top:6px;
  }
  .qibla-badge span { color:#f0c040; font-weight:700; }

  .loc-card {
    z-index:10; width:calc(100% - 36px); max-width:340px;
    background:#161b22; border:1px solid rgba(255,255,255,0.07);
    border-radius:16px; padding:13px 16px;
    display:flex; align-items:center; gap:12px; margin-bottom:12px;
  }
  .loc-icon {
    width:38px; height:38px; border-radius:12px;
    background:rgba(46,197,94,0.1); border:1px solid rgba(46,197,94,0.22);
    display:flex; align-items:center; justify-content:center; font-size:18px; flex-shrink:0;
  }
  .loc-name { font-size:14px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
  .loc-coords { font-size:11px; color:#8b949e; margin-top:1px; }

  .banner {
    z-index:10; width:calc(100% - 36px); max-width:340px;
    background:linear-gradient(135deg,rgba(46,197,94,0.18),rgba(46,197,94,0.06));
    border:1px solid rgba(46,197,94,0.38);
    border-radius:14px; padding:12px 16px;
    display:flex; align-items:center; gap:10px;
    opacity:0; transform:translateY(8px);
    transition:opacity 0.5s, transform 0.5s;
  }
  .banner.show { opacity:1; transform:translateY(0); }
  .banner-t { font-size:14px; font-weight:800; color:#2ec55e; }
  .banner-s { font-size:11px; color:#8b949e; }

  .loading {
    position:fixed; inset:0; background:#0d1117;
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    z-index:200; gap:18px; transition:opacity 0.6s;
  }
  .loading.hide { opacity:0; pointer-events:none; }
  .load-icon { font-size:68px; animation:float 2.2s ease-in-out infinite; }
  @keyframes float { 0%,100%{transform:translateY(0) rotate(-3deg)} 50%{transform:translateY(-14px) rotate(3deg)} }
  .spin {
    width:36px; height:36px; border-radius:50%;
    border:3px solid rgba(255,255,255,0.08);
    border-top-color:#2ec55e; animation:sp 0.8s linear infinite;
  }
  @keyframes sp { to{transform:rotate(360deg)} }
  .load-sub { font-size:13px; color:rgba(139,148,158,0.7); }
  .perm-btn {
    display:none; background:linear-gradient(135deg,#2ec55e,#1a8f42);
    border:none; color:#fff; padding:14px 34px; border-radius:50px;
    font-size:15px; font-family:inherit; font-weight:800;
    cursor:pointer; box-shadow:0 4px 24px rgba(46,197,94,0.4);
    letter-spacing:0.5px;
  }
  .perm-btn:active { transform:scale(0.96); }

  @keyframes qflash { 0%,100%{background:#0d1117} 40%{background:rgba(46,197,94,0.07)} }
  body.flash { animation:qflash 0.7s ease; }
</style>
</head>
<body>

<div class="stars" id="stars"></div>

<div class="loading" id="LS">
  <div class="load-icon">üïå</div>
  <div style="font-size:18px;font-weight:800;color:#e6edf3;">Qibla Kompas</div>
  <div id="LSinner" style="display:flex;flex-direction:column;align-items:center;gap:12px;">
    <div class="spin"></div>
    <div class="load-sub">Yuklanmoqda...</div>
  </div>
  <button class="perm-btn" id="permBtn" onclick="askPermission()">üìç Ruxsat berish</button>
</div>

<div class="header">
  <div class="arabic">ÿßŸÑŸÇÿ®ŸÑÿ©</div>
  <div class="latin">Qibla Kompas</div>
</div>

<div class="status">
  <div class="dot" id="dot"></div>
  <div class="status-txt" id="stxt">Sensor kutilmoqda...</div>
</div>

<div class="compass-wrap">
  <div class="glow-ring" id="glow"></div>
  <canvas id="c" width="580" height="580"></canvas>
  <div class="kaaba" id="kaaba">üïã</div>
</div>

<div class="deg-wrap">
  <div class="deg-val" id="dval">--¬∞</div>
  <div class="deg-dir" id="ddir">Kompas yuklanmoqda</div>
  <div class="qibla-badge">Qibla: <span id="qbadge">--¬∞</span></div>
</div>

<div class="loc-card">
  <div class="loc-icon">üìç</div>
  <div>
    <div class="loc-name" id="lname">Joylashuv aniqlanmoqda...</div>
    <div class="loc-coords" id="lcoords"></div>
  </div>
</div>

<div class="banner" id="banner">
  <div style="font-size:22px;">‚ú®</div>
  <div>
    <div class="banner-t">Qibla topildi!</div>
    <div class="banner-s">Siz to'g'ri yo'nalishdasiz ‚Äî Alloh qabul qilsin</div>
  </div>
</div>

<script>
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   QIBLA BEARING MATH (Critical):
   
   qiblaTrue  = great-circle bearing from user to Mecca (0-360, clockwise from North)
   deviceHead = where the device's TOP is pointing, clockwise from North
   
   needleAngleDeg = qiblaTrue - deviceHead
   
   Example: Toshkent ‚Üí Mecca ‚âà 248¬∞
   - Device points North (head=0):  needle at 248¬∞ ‚Üí arrow points SW ‚úì
   - Device rotates right 30¬∞ (head=30): needle at 218¬∞ ‚Üí still tracks Mecca ‚úì
   - Device points at Mecca (head=248): needle at 0¬∞ ‚Üí arrow points straight up ‚úì
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

// Stars
(()=>{
  const c=document.getElementById('stars');
  for(let i=0;i<70;i++){
    const s=document.createElement('div');s.className='star';
    const sz=Math.random()<0.3?3:Math.random()<0.5?2:1;
    s.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--d:${2+Math.random()*5}s;--delay:-${Math.random()*6}s`;
    c.appendChild(s);
  }
})();

// ‚îÄ‚îÄ State ‚îÄ‚îÄ
const MECCA_LAT = 21.4225;
const MECCA_LON = 39.8262;

let userLat    = 41.2995;   // default: Toshkent
let userLon    = 69.2401;
let qiblaTrue  = 248.5;     // will be recalculated from GPS
let deviceHead = 0;         // raw sensor heading (0=North, clockwise)
let smoothHead = 0;         // interpolated heading
let sensorReady = false;
let wasAligned  = false;

// ‚îÄ‚îÄ Bearing calculation ‚îÄ‚îÄ
// Returns clockwise bearing in degrees from (lat1,lon1) to Mecca
function calcQibla(lat, lon) {
  const toRad = d => d * Math.PI / 180;
  const œÜ1 = toRad(lat), œÜ2 = toRad(MECCA_LAT);
  const ŒîŒª = toRad(MECCA_LON - lon);
  const y = Math.sin(ŒîŒª) * Math.cos(œÜ2);
  const x = Math.cos(œÜ1) * Math.sin(œÜ2) - Math.sin(œÜ1) * Math.cos(œÜ2) * Math.cos(ŒîŒª);
  const brng = Math.atan2(y, x) * 180 / Math.PI;
  return ((brng % 360) + 360) % 360;
}

// ‚îÄ‚îÄ Angle utils ‚îÄ‚îÄ
function norm(d) { return ((d % 360) + 360) % 360; }

function lerpAngle(cur, tgt, t) {
  let d = norm(tgt) - norm(cur);
  if (d > 180) d -= 360;
  if (d < -180) d += 360;
  return cur + d * t;
}

function isAligned() {
  let diff = norm(qiblaTrue) - norm(smoothHead);
  if (diff > 180) diff -= 360;
  if (diff < -180) diff += 360;
  return Math.abs(diff) < 5;
}

function cardDir(deg) {
  const dirs = ["Shimol","Shim-Sharq","Sharq","Jan-Sharq","Janub","Jan-G'arb","G'arb","Shim-G'arb"];
  return dirs[Math.round(norm(deg) / 45) % 8];
}

// ‚îÄ‚îÄ Canvas ‚îÄ‚îÄ
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
const W = 580, CX = W/2, CY = W/2;

function draw() {
  ctx.clearRect(0, 0, W, W);
  const aligned = isAligned();

  // Outer rim (green border)
  const rimG = ctx.createLinearGradient(0, 0, W, W);
  rimG.addColorStop(0, aligned ? '#3ddc84' : '#2ec55e');
  rimG.addColorStop(1, aligned ? '#1a8f42' : '#0b5e22');
  ctx.beginPath(); ctx.arc(CX, CY, 285, 0, Math.PI*2);
  ctx.fillStyle = rimG; ctx.fill();

  // Face background
  const faceG = ctx.createRadialGradient(CX, CY, 40, CX, CY, 252);
  faceG.addColorStop(0, '#1c2530');
  faceG.addColorStop(1, '#0d1117');
  ctx.beginPath(); ctx.arc(CX, CY, 255, 0, Math.PI*2);
  ctx.fillStyle = faceG;
  ctx.shadowColor = aligned ? 'rgba(46,197,94,0.3)' : 'transparent';
  ctx.shadowBlur  = aligned ? 28 : 0;
  ctx.fill();
  ctx.shadowBlur = 0;

  /* ‚îÄ‚îÄ Rotating disc: ticks + cardinal labels ‚îÄ‚îÄ
     Rotates -heading so the disc follows the real world.
     N label stays aligned with geographic North. */
  ctx.save();
  ctx.translate(CX, CY);
  ctx.rotate(-smoothHead * Math.PI / 180);

  // Degree ticks
  for (let i = 0; i < 360; i++) {
    const rad = i * Math.PI / 180;
    const isMaj = i % 30 === 0;
    const isMed = i % 10 === 0 && !isMaj;
    const len   = isMaj ? 24 : isMed ? 15 : 8;
    const r1 = 248, r2 = r1 - len;
    ctx.beginPath();
    ctx.moveTo(Math.cos(rad)*r1, Math.sin(rad)*r1);
    ctx.lineTo(Math.cos(rad)*r2, Math.sin(rad)*r2);
    ctx.strokeStyle = isMaj ? 'rgba(255,255,255,0.85)' : isMed ? 'rgba(255,255,255,0.35)' : 'rgba(255,255,255,0.12)';
    ctx.lineWidth   = isMaj ? 2.5 : 1.5;
    ctx.stroke();
  }

  // Degree numbers
  ctx.font = '600 17px Nunito,sans-serif';
  ctx.fillStyle = 'rgba(200,215,230,0.65)';
  ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  for (let i = 0; i < 360; i += 30) {
    if (i % 90 === 0) continue;
    const rad = i * Math.PI / 180;
    ctx.save();
    ctx.translate(Math.sin(rad)*180, -Math.cos(rad)*180);
    ctx.rotate(rad);
    ctx.fillText(i, 0, 0);
    ctx.restore();
  }

  // Cardinals
  const cards = ['N','E','S','W'];
  ctx.font = 'bold 36px Nunito,sans-serif';
  ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
  for (let i = 0; i < 4; i++) {
    const rad = i * Math.PI / 2;
    ctx.fillStyle = i === 0 ? '#ef4444' : 'rgba(255,255,255,0.82)';
    ctx.fillText(cards[i], Math.sin(rad)*208, -Math.cos(rad)*208);
  }

  // Intercardinals
  const inter = ['NE','SE','SW','NW'];
  ctx.font = 'bold 15px Nunito,sans-serif';
  ctx.fillStyle = 'rgba(255,255,255,0.28)';
  for (let i = 0; i < 4; i++) {
    const rad = (i*90 + 45) * Math.PI / 180;
    ctx.fillText(inter[i], Math.sin(rad)*200, -Math.cos(rad)*200);
  }

  ctx.restore(); // end rotating disc

  /* ‚îÄ‚îÄ Qibla needle (SCREEN-FIXED arrow pointing at Mecca) ‚îÄ‚îÄ
     
     needleAngle = qiblaTrue - smoothHead
     
     When device faces North (smoothHead=0): arrow points at qiblaTrue.
     When device rotates: smoothHead grows, arrow counter-rotates to stay on Mecca.
  */
  const needleAngleDeg = norm(qiblaTrue - smoothHead);
  const needleRad      = needleAngleDeg * Math.PI / 180;

  // Convert to x,y direction unit vectors
  const nx =  Math.sin(needleRad); // x component (East positive)
  const ny = -Math.cos(needleRad); // y component (North = -y on canvas)

  ctx.save();
  ctx.translate(CX, CY);

  // Soft glow trail from center toward Qibla
  const trailGrad = ctx.createLinearGradient(0, 0, nx*240, ny*240);
  trailGrad.addColorStop(0,   'rgba(240,192,64,0)');
  trailGrad.addColorStop(0.5, 'rgba(240,192,64,0.12)');
  trailGrad.addColorStop(1,   'rgba(240,192,64,0.45)');
  ctx.beginPath(); ctx.moveTo(0,0); ctx.lineTo(nx*240, ny*240);
  ctx.strokeStyle = trailGrad; ctx.lineWidth = 12; ctx.stroke();

  // Gold arc highlight on rim at Qibla direction
  const arcHalf = 0.13;
  const arcAngle = needleRad - Math.PI/2; // canvas arc is measured from 3 o'clock
  ctx.beginPath();
  ctx.arc(0, 0, 262, arcAngle - arcHalf, arcAngle + arcHalf);
  ctx.strokeStyle = 'rgba(240,192,64,0.75)';
  ctx.lineWidth = 18;
  ctx.stroke();

  // Gold arrowhead ‚Äî rotated to needleRad
  ctx.save();
  ctx.rotate(needleRad); // rotate so local "up" (0,-1) points toward Qibla
  ctx.shadowColor = 'rgba(240,192,64,0.8)';
  ctx.shadowBlur  = 22;

  // Arrow tip
  ctx.beginPath();
  ctx.moveTo(0, -244);      // tip
  ctx.lineTo( 12, -210);
  ctx.lineTo(  0, -220);
  ctx.lineTo(-12, -210);
  ctx.closePath();
  ctx.fillStyle = '#f0c040';
  ctx.fill();

  // Arrow shaft
  ctx.beginPath();
  ctx.moveTo( 6, -210);
  ctx.lineTo( 4, -130);
  ctx.lineTo(-4, -130);
  ctx.lineTo(-6, -210);
  ctx.closePath();
  ctx.fillStyle = 'rgba(240,192,64,0.55)';
  ctx.fill();
  ctx.shadowBlur = 0;
  ctx.restore();

  ctx.restore(); // end translate(CX,CY)

  // Pulsing aligned ring
  if (aligned) {
    const pulse = (Math.sin(Date.now() / 280) + 1) / 2;
    ctx.beginPath(); ctx.arc(CX, CY, 255, 0, Math.PI*2);
    ctx.strokeStyle = `rgba(46,197,94,${0.3 + pulse * 0.5})`;
    ctx.lineWidth = 7;
    ctx.stroke();
  }

  // Fixed green North pointer triangle at top of canvas (screen-fixed)
  ctx.save();
  ctx.translate(CX, CY);
  ctx.shadowColor = '#2ec55e'; ctx.shadowBlur = 14;
  ctx.beginPath();
  ctx.moveTo(0, -261);
  ctx.lineTo( 9, -242);
  ctx.lineTo(-9, -242);
  ctx.closePath();
  ctx.fillStyle = '#2ec55e';
  ctx.fill();
  ctx.shadowBlur = 0;
  ctx.restore();
}

// ‚îÄ‚îÄ Animation loop ‚îÄ‚îÄ
function loop() {
  smoothHead = lerpAngle(smoothHead, deviceHead, 0.10);
  draw();

  const aligned = isAligned();
  const headDeg = Math.round(norm(smoothHead));

  document.getElementById('dval').textContent = headDeg + '¬∞';
  document.getElementById('dval').classList.toggle('aligned', aligned);
  document.getElementById('ddir').textContent = cardDir(smoothHead);
  document.getElementById('glow').classList.toggle('aligned', aligned);
  document.getElementById('kaaba').classList.toggle('aligned', aligned);
  document.getElementById('banner').classList.toggle('show', aligned);

  if (aligned && !wasAligned && sensorReady) {
    wasAligned = true;
    document.body.classList.add('flash');
    setTimeout(() => document.body.classList.remove('flash'), 750);
    if (navigator.vibrate) navigator.vibrate([70, 50, 110]);
  } else if (!aligned) {
    wasAligned = false;
  }

  requestAnimationFrame(loop);
}

// ‚îÄ‚îÄ Orientation event ‚îÄ‚îÄ
function onOrientation(e) {
  let heading;

  if (typeof e.webkitCompassHeading === 'number') {
    // iOS: webkitCompassHeading is already clockwise from magnetic North
    heading = e.webkitCompassHeading;
  } else if (typeof e.alpha === 'number') {
    // Android standard: alpha = counter-clockwise rotation of device from North
    // Convert to clockwise heading: heading = (360 - alpha) mod 360
    heading = norm(360 - e.alpha);
  } else {
    return;
  }

  deviceHead = heading;

  if (!sensorReady) {
    sensorReady = true;
    document.getElementById('dot').classList.add('on');
    document.getElementById('stxt').textContent = 'Kompas faol';
    hideLoading();
  }
}

// ‚îÄ‚îÄ Geolocation ‚îÄ‚îÄ
function startGeo() {
  if (!navigator.geolocation) { setDefaultLoc(); return; }
  navigator.geolocation.getCurrentPosition(
    pos => {
      userLat   = pos.coords.latitude;
      userLon   = pos.coords.longitude;
      qiblaTrue = calcQibla(userLat, userLon);
      document.getElementById('qbadge').textContent = Math.round(qiblaTrue) + '¬∞';
      reverseGeo(userLat, userLon);
    },
    () => setDefaultLoc(),
    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
  );
}

function setDefaultLoc() {
  qiblaTrue = calcQibla(userLat, userLon);
  document.getElementById('qbadge').textContent = Math.round(qiblaTrue) + '¬∞';
  document.getElementById('lname').textContent = "Toshkent, O'zbekiston";
  document.getElementById('lcoords').textContent =
    userLat.toFixed(4) + '¬∞N, ' + userLon.toFixed(4) + '¬∞E';
}

function reverseGeo(lat, lon) {
  fetch('https://nominatim.openstreetmap.org/reverse?lat='+lat+'&lon='+lon+'&format=json&accept-language=uz')
    .then(r => r.json())
    .then(d => {
      const a = d.address;
      const city = a.city || a.town || a.village || a.county || 'Joylashuv';
      document.getElementById('lname').textContent = city + ', ' + (a.country || '');
      document.getElementById('lcoords').textContent =
        lat.toFixed(4) + '¬∞N, ' + lon.toFixed(4) + '¬∞E';
    })
    .catch(() => {
      document.getElementById('lname').textContent = lat.toFixed(4) + '¬∞N, ' + lon.toFixed(4) + '¬∞E';
    });
}

// ‚îÄ‚îÄ iOS permission ‚îÄ‚îÄ
function askPermission() {
  document.getElementById('permBtn').style.display = 'none';
  document.getElementById('LSinner').innerHTML =
    '<div class="spin"></div><div class="load-sub">Ruxsat so\'ralmoqda...</div>';

  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {
    DeviceOrientationEvent.requestPermission()
      .then(s => {
        if (s === 'granted') {
          window.addEventListener('deviceorientation', onOrientation, true);
          startGeo();
        } else {
          showDemoBtn('Ruxsat rad etildi.');
        }
      })
      .catch(e => showDemoBtn('Xato: ' + e.message));
  } else {
    window.addEventListener('deviceorientation', onOrientation, true);
    startGeo();
  }
}

// ‚îÄ‚îÄ Demo mode ‚îÄ‚îÄ
let demoT = 0;
function startDemo() {
  if (sensorReady) return;
  sensorReady = true;
  document.getElementById('dot').classList.add('on');
  document.getElementById('stxt').textContent = 'Demo rejim';
  (function tick(){
    demoT = (demoT + 0.5) % 360;
    deviceHead = demoT;
    requestAnimationFrame(tick);
  })();
  hideLoading();
  startGeo();
}

function showDemoBtn(msg) {
  document.getElementById('LSinner').innerHTML =
    `<div class="load-sub" style="text-align:center;padding:0 24px">${msg}</div>`;
  const btn = document.getElementById('permBtn');
  btn.textContent = '‚ñ∂ Demo rejim';
  btn.onclick = startDemo;
  btn.style.display = 'block';
}

function hideLoading() {
  const ls = document.getElementById('LS');
  ls.classList.add('hide');
  setTimeout(() => ls.style.display='none', 700);
}

// ‚îÄ‚îÄ Boot ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded', () => {
  if (window.Telegram?.WebApp) {
    const tg = window.Telegram.WebApp;
    tg.ready(); tg.expand();
    tg.setHeaderColor?.('#0d1117');
    tg.setBackgroundColor?.('#0d1117');
  }

  // Initial Qibla (default coords)
  qiblaTrue = calcQibla(userLat, userLon);
  document.getElementById('qbadge').textContent = Math.round(qiblaTrue) + '¬∞';

  // Start render
  loop();

  const isIOS = typeof DeviceOrientationEvent !== 'undefined' &&
                typeof DeviceOrientationEvent.requestPermission === 'function';

  if (isIOS) {
    document.getElementById('LSinner').innerHTML =
      '<div class="load-sub" style="text-align:center;padding:0 28px;line-height:1.8">Kompasni ishlatish uchun ruxsat bering</div>';
    document.getElementById('permBtn').style.display = 'block';
  } else {
    // Android / desktop
    window.addEventListener('deviceorientation', onOrientation, true);
    startGeo();
    setTimeout(() => {
      if (!sensorReady) showDemoBtn('Kompas sensori topilmadi');
    }, 3000);
  }
});
</script>
</body>
</html>
