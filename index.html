<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Qibla Kompasi & Qur'on</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&family=Amiri&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #1db954;
            --bg: #0a0f1a;
            --card: #131922;
            --text: #e8f4fd;
            --muted: #6b7685;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        /* Navigation */
        nav {
            display: flex;
            background: #0b1e35;
            border-bottom: 1px solid rgba(29, 185, 84, 0.2);
            z-index: 100;
        }
        .nav-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: none;
            color: var(--muted);
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .nav-btn.active { color: var(--primary); border-bottom: 2px solid var(--primary); }
        .nav-btn i { font-style: normal; font-size: 20px; }

        /* Pages */
        .pages { flex: 1; position: relative; }
        .page {
            position: absolute;
            inset: 0;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }
        .page.active { opacity: 1; pointer-events: all; }

        /* Compass UI */
        .compass-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 20px 0;
        }
        #compass-canvas {
            width: 100%;
            height: 100%;
        }
        .kaaba-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            z-index: 10;
        }
        
        .info-card {
            background: var(--card);
            width: 100%;
            max-width: 350px;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .degree-val { font-size: 48px; font-weight: bold; text-align: center; margin: 10px 0; }
        .status-text { font-size: 12px; color: var(--muted); text-align: center; text-transform: uppercase; letter-spacing: 1px; }
        
        /* Permission Overlay */
        #overlay {
            position: fixed;
            inset: 0;
            background: var(--bg);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            text-align: center;
        }
        .btn-main {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 16px;
            font-weight: bold;
            margin-top: 20px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(29, 185, 84, 0.4);
        }

        /* Quran List */
        .quran-list { width: 100%; max-width: 500px; }
        .surah-item {
            background: var(--card);
            padding: 12px;
            margin-bottom: 8px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
        }
        .surah-num { width: 30px; height: 30px; background: #1a2030; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; color: var(--primary); }
        .surah-info { flex: 1; }
        .surah-ar { font-family: 'Amiri', serif; font-size: 18px; text-align: right; }
    </style>
</head>
<body>

<div id="overlay">
    <div style="font-size: 50px; margin-bottom: 20px;">ðŸ§­</div>
    <h2>Qibla Kompasi</h2>
    <p style="color: var(--muted); margin-top: 10px;">Kompas ishlashi uchun sensor va joylashuvga ruxsat berishingiz kerak.</p>
    <button class="btn-main" onclick="initApp()">Boshlash</button>
</div>

<nav>
    <button class="nav-btn active" onclick="showPage('qibla', this)"><i>ðŸ§­</i><span>Qibla</span></button>
    <button class="nav-btn" onclick="showPage('quran', this)"><i>ðŸ“–</i><span>Qur'on</span></button>
</nav>

<div class="pages">
    <!-- Qibla Page -->
    <div id="qibla" class="page active">
        <div class="status-text" id="sensor-status">Sensor kutilmoqda...</div>
        <div class="compass-container">
            <canvas id="compass-canvas" width="600" height="600"></canvas>
            <div class="kaaba-icon">ðŸ•‹</div>
        </div>
        <div class="degree-val" id="heading-display">0Â°</div>
        <div class="info-card">
            <div style="display: flex; justify-content: space-between; font-size: 14px;">
                <span>Qibla burchagi:</span>
                <span id="qibla-angle" style="color: var(--primary); font-weight: bold;">--Â°</span>
            </div>
        </div>
        <div class="info-card">
            <div id="location-text" style="font-size: 13px; color: var(--muted);">Joylashuv aniqlanmoqda...</div>
        </div>
    </div>

    <!-- Quran Page -->
    <div id="quran" class="page">
        <h2 style="margin-bottom: 20px;">Suralar</h2>
        <div class="quran-list" id="surah-container">
            <!-- Suralar bu yerga yuklanadi -->
        </div>
    </div>
</div>

<script>
    const KA_LAT = 21.4225, KA_LON = 39.8262;
    let userLat = 41.2995, userLon = 69.2401; // Default: Toshkent
    let qiblaAngle = 0;
    let currentHeading = 0;
    let isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

    const canvas = document.getElementById('compass-canvas');
    const ctx = canvas.getContext('2d');

    function showPage(id, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    function calculateQibla(lat, lon) {
        const Ï†1 = lat * Math.PI / 180;
        const Ï†2 = KA_LAT * Math.PI / 180;
        const Î”Î» = (KA_LON - lon) * Math.PI / 180;
        const y = Math.sin(Î”Î») * Math.cos(Ï†2);
        const x = Math.cos(Ï†1) * Math.sin(Ï†2) - Math.sin(Ï†1) * Math.cos(Ï†2) * Math.cos(Î”Î»);
        let q = Math.atan2(y, x) * 180 / Math.PI;
        return (q + 360) % 360;
    }

    function drawCompass(heading) {
        const cx = 300, cy = 300, r = 250;
        ctx.clearRect(0, 0, 600, 600);

        // Outer ring
        ctx.beginPath();
        ctx.arc(cx, cy, r + 20, 0, Math.PI * 2);
        ctx.strokeStyle = '#1db954';
        ctx.lineWidth = 5;
        ctx.stroke();

        ctx.save();
        ctx.translate(cx, cy);
        ctx.rotate(-heading * Math.PI / 180);

        // Degrees and letters
        ctx.fillStyle = "white";
        ctx.textAlign = "center";
        ctx.font = "bold 30px Arial";
        
        const directions = { 0: 'N', 90: 'E', 180: 'S', 270: 'W' };
        for (let a = 0; a < 360; a += 30) {
            ctx.save();
            ctx.rotate(a * Math.PI / 180);
            if (directions[a]) {
                ctx.fillStyle = a === 0 ? "#ff4444" : "white";
                ctx.fillText(directions[a], 0, -r + 40);
            } else {
                ctx.fillStyle = "rgba(255,255,255,0.5)";
                ctx.font = "15px Arial";
                ctx.fillText(a, 0, -r + 40);
            }
            ctx.restore();
        }

        // Qibla Needle
        ctx.save();
        ctx.rotate(qiblaAngle * Math.PI / 180);
        ctx.beginPath();
        ctx.moveTo(0, -r + 60);
        ctx.lineTo(15, -r + 100);
        ctx.lineTo(-15, -r + 100);
        ctx.closePath();
        ctx.fillStyle = "#ffd700";
        ctx.fill();
        ctx.restore();

        ctx.restore();
    }

    function updateHeading(h) {
        currentHeading = h;
        document.getElementById('heading-display').textContent = Math.round(h) + "Â°";
        drawCompass(h);
        
        // Check alignment
        let diff = Math.abs((qiblaAngle - h + 360) % 360);
        if (diff < 5 || diff > 355) {
            document.getElementById('sensor-status').textContent = "Qibla yo'nalishi topildi!";
            document.getElementById('sensor-status').style.color = "#1db954";
        } else {
            document.getElementById('sensor-status').textContent = "Kompas faol";
            document.getElementById('sensor-status').style.color = "#6b7685";
        }
    }

    function initApp() {
        document.getElementById('overlay').style.display = 'none';
        
        // 1. Get Location
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(pos => {
                userLat = pos.coords.latitude;
                userLon = pos.coords.longitude;
                qiblaAngle = calculateQibla(userLat, userLon);
                document.getElementById('qibla-angle').textContent = Math.round(qiblaAngle) + "Â°";
                document.getElementById('location-text').textContent = `Joylashuv: ${userLat.toFixed(4)}, ${userLon.toFixed(4)}`;
                drawCompass(currentHeading);
            }, err => {
                document.getElementById('location-text').textContent = "Joylashuvni aniqlab bo'lmadi (Toshkent tanlandi)";
                qiblaAngle = calculateQibla(userLat, userLon);
                document.getElementById('qibla-angle').textContent = Math.round(qiblaAngle) + "Â°";
            });
        }

        // 2. Init Compass
        if (isIOS) {
            if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(response => {
                    if (response == 'granted') {
                        window.addEventListener('deviceorientation', e => {
                            if (e.webkitCompassHeading) updateHeading(e.webkitCompassHeading);
                        });
                    }
                });
            }
        } else {
            window.addEventListener('deviceorientationabsolute', e => {
                if (e.alpha !== null) updateHeading(360 - e.alpha);
            }, true);
            // Fallback
            window.addEventListener('deviceorientation', e => {
                if (!e.absolute && e.alpha !== null) updateHeading(360 - e.alpha);
            }, true);
        }
        
        loadSurahs();
    }

    function loadSurahs() {
        const surahs = [
            {n: 1, name: "Al-Fotiha", ar: "Ø§Ù„ÙØ§ØªØ­Ø©"},
            {n: 2, name: "Al-Baqara", ar: "Ø§Ù„Ø¨Ù‚Ø±Ø©"},
            {n: 36, name: "Yo Sin", ar: "ÙŠØ³"},
            {n: 67, name: "Al-Mulk", ar: "Ø§Ù„Ù…Ù„Ùƒ"},
            {n: 112, name: "Al-Ikhlos", ar: "Ø§Ù„Ø¥Ø®Ù„Ø§Øµ"},
            {n: 113, name: "Al-Falaq", ar: "Ø§Ù„ÙÙ„Ù‚"},
            {n: 114, name: "An-Nos", ar: "Ø§Ù„Ù†Ø§Ø³"}
        ];
        const container = document.getElementById('surah-container');
        container.innerHTML = surahs.map(s => `
            <div class="surah-item">
                <div class="surah-num">${s.n}</div>
                <div class="surah-info">
                    <div style="font-weight: bold;">${s.name}</div>
                </div>
                <div class="surah-ar">${s.ar}</div>
            </div>
        `).join('');
    }

    // Initial draw
    drawCompass(0);
</script>

</body>
</html>
