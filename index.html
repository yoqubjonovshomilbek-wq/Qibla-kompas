<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Qibla Kompas</title>
<link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{
  background:#0a0f1a;
  color:#e8edf5;
  font-family:'Nunito',sans-serif;
  min-height:100dvh;
  display:flex;flex-direction:column;align-items:center;
  overflow-x:hidden;padding-bottom:24px;
}

/* Stars */
.stars{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
.star{position:absolute;border-radius:50%;background:#fff;opacity:0;animation:tw var(--d) ease-in-out infinite var(--dl)}
@keyframes tw{0%,100%{opacity:0}50%{opacity:.65}}

/* Header */
.hdr{z-index:10;display:flex;flex-direction:column;align-items:center;gap:2px;padding:18px 0 6px}
.arabic{font-family:'Amiri',serif;font-size:28px;color:#f0c040;line-height:1}
.latin{font-size:11px;color:#6b7685;letter-spacing:4px;text-transform:uppercase;font-weight:700}

/* Status */
.status{z-index:10;display:flex;align-items:center;gap:7px;padding:2px 0 8px}
.dot{width:8px;height:8px;border-radius:50%;background:#3a4455;transition:all .4s}
.dot.on{background:#22c55e;box-shadow:0 0 8px rgba(34,197,94,.6);animation:pd 1.8s infinite}
@keyframes pd{0%,100%{transform:scale(1)}50%{transform:scale(1.3)}}
.stxt{font-size:11px;color:#6b7685;font-weight:700;letter-spacing:1px}

/* Compass */
.cwrap{z-index:10;position:relative;display:flex;align-items:center;justify-content:center;margin:2px 0 8px}
.gring{
  position:absolute;border-radius:50%;
  width:306px;height:306px;
  box-shadow:0 0 38px 5px rgba(34,197,94,.1);
  transition:box-shadow .7s;pointer-events:none;
}
.gring.on{
  box-shadow:0 0 65px 22px rgba(34,197,94,.55),0 0 120px 45px rgba(34,197,94,.22);
  animation:gp 1.1s ease-in-out infinite;
}
@keyframes gp{
  0%,100%{box-shadow:0 0 65px 22px rgba(34,197,94,.55),0 0 120px 45px rgba(34,197,94,.22)}
  50%{box-shadow:0 0 85px 32px rgba(34,197,94,.75),0 0 160px 65px rgba(34,197,94,.3)}
}
canvas{width:295px;height:295px;border-radius:50%;display:block}
.kaaba{
  position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
  width:58px;height:58px;border-radius:50%;
  background:radial-gradient(circle at 38% 32%,#42a5f5,#0d47a1);
  display:flex;align-items:center;justify-content:center;
  font-size:28px;z-index:20;
  box-shadow:0 0 0 3px rgba(255,255,255,.12),0 4px 18px rgba(0,0,0,.55);
  transition:box-shadow .5s;
}
.kaaba.on{box-shadow:0 0 0 4px #22c55e,0 0 24px rgba(34,197,94,.65)}

/* Degree */
.degwrap{z-index:10;text-align:center;margin-bottom:8px}
.dval{font-size:56px;font-weight:800;color:#e8edf5;letter-spacing:-2px;line-height:1;transition:color .5s}
.dval.on{color:#22c55e}
.ddir{font-size:13px;color:#6b7685;letter-spacing:2px;font-weight:700;text-transform:uppercase;margin-top:2px}
.badge{
  display:inline-block;background:#121826;
  border:1px solid rgba(255,255,255,.07);border-radius:20px;
  padding:5px 14px;font-size:12px;color:#6b7685;margin-top:5px;
}
.badge b{color:#f0c040;font-weight:700}

/* Location */
.loccard{
  z-index:10;width:calc(100% - 32px);max-width:340px;
  background:#131922;border:1px solid rgba(255,255,255,.06);
  border-radius:16px;padding:13px 16px;
  display:flex;align-items:center;gap:12px;margin-bottom:10px;
}
.locico{
  width:38px;height:38px;border-radius:12px;
  background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.2);
  display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;
}
.locname{font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.loccoords{font-size:11px;color:#6b7685;margin-top:1px}

/* Banner */
.banner{
  z-index:10;width:calc(100% - 32px);max-width:340px;
  background:linear-gradient(135deg,rgba(34,197,94,.16),rgba(34,197,94,.05));
  border:1px solid rgba(34,197,94,.35);border-radius:14px;padding:12px 16px;
  display:flex;align-items:center;gap:10px;
  opacity:0;transform:translateY(8px);transition:opacity .5s,transform .5s;
}
.banner.show{opacity:1;transform:translateY(0)}
.bt{font-size:14px;font-weight:800;color:#22c55e}
.bs{font-size:11px;color:#6b7685}

/* Debug (hidden by default) */
.dbg{
  z-index:10;width:calc(100% - 32px);max-width:340px;
  background:#0f1520;border:1px solid rgba(255,255,255,.06);
  border-radius:12px;padding:10px 14px;margin-top:8px;
  font-size:11px;color:#6b7685;line-height:1.8;display:none;
}
.dbg.show{display:block}

/* Loading */
.ls{
  position:fixed;inset:0;background:#0a0f1a;
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  z-index:300;gap:16px;transition:opacity .6s;
}
.ls.hide{opacity:0;pointer-events:none}
.lic{font-size:66px;animation:fl 2.2s ease-in-out infinite}
@keyframes fl{0%,100%{transform:translateY(0) rotate(-3deg)}50%{transform:translateY(-13px) rotate(3deg)}}
.spin{width:34px;height:34px;border-radius:50%;border:3px solid rgba(255,255,255,.08);border-top-color:#22c55e;animation:sp .8s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.lsub{font-size:13px;color:rgba(107,118,133,.75)}
.pbtn{
  display:none;background:linear-gradient(135deg,#22c55e,#15803d);
  border:none;color:#fff;padding:14px 32px;border-radius:50px;
  font-size:15px;font-family:inherit;font-weight:800;
  cursor:pointer;box-shadow:0 4px 22px rgba(34,197,94,.4);letter-spacing:.5px;
}
.pbtn:active{transform:scale(.96)}

@keyframes flash{0%,100%{background:#0a0f1a}45%{background:rgba(34,197,94,.07)}}
body.fl{animation:flash .7s ease}
</style>
</head>
<body>

<div class="stars" id="stars"></div>

<!-- LOADING -->
<div class="ls" id="LS">
  <div class="lic">üïå</div>
  <div style="font-size:18px;font-weight:800">Qibla Kompas</div>
  <div id="LSbody" style="display:flex;flex-direction:column;align-items:center;gap:11px">
    <div class="spin"></div>
    <div class="lsub">Yuklanmoqda...</div>
  </div>
  <button class="pbtn" id="pbtn">üìç Ruxsat berish</button>
</div>

<!-- MAIN -->
<div class="hdr">
  <div class="arabic">ÿßŸÑŸÇÿ®ŸÑÿ©</div>
  <div class="latin">Qibla Kompas</div>
</div>

<div class="status">
  <div class="dot" id="dot"></div>
  <div class="stxt" id="stxt">Sensor kutilmoqda...</div>
</div>

<div class="cwrap">
  <div class="gring" id="gring"></div>
  <canvas id="cv" width="590" height="590"></canvas>
  <div class="kaaba" id="kaaba">üïã</div>
</div>

<div class="degwrap">
  <div class="dval" id="dval">--¬∞</div>
  <div class="ddir" id="ddir">Yuklanmoqda</div>
  <div class="badge">Qibla: <b id="qbdg">--¬∞</b></div>
</div>

<div class="loccard">
  <div class="locico">üìç</div>
  <div style="min-width:0;flex:1">
    <div class="locname" id="lname">Joylashuv aniqlanmoqda...</div>
    <div class="loccoords" id="lcoords"></div>
  </div>
</div>

<div class="banner" id="banner">
  <div style="font-size:22px">‚ú®</div>
  <div>
    <div class="bt">Qibla topildi!</div>
    <div class="bs">Siz to'g'ri yo'nalishdasiz ‚Äî Alloh qabul qilsin</div>
  </div>
</div>

<!-- Debug panel (tap kaaba 5x to toggle) -->
<div class="dbg" id="dbg"></div>

<script>
/* ============================================================
   QIBLA COMPASS ‚Äî mathematically correct implementation
   
   THEORY:
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   ‚Ä¢ qiblaTrue  = great-circle bearing FROM user TO Mecca
                  (0¬∞ = North, 90¬∞ = East, 180¬∞ = South, 270¬∞ = West)
   
   ‚Ä¢ deviceHead = compass heading of device's TOP edge
                  (0¬∞ = North, clockwise)
   
   ‚Ä¢ To show a Qibla arrow FIXED on screen pointing at Mecca:
       needleScreen = qiblaTrue - deviceHead   (mod 360)
   
     Why: if device top points North (head=0) and Qibla is 248¬∞,
          needle should be drawn at 248¬∞ from screen-up.
          If device rotates clockwise by 30¬∞ (head=30¬∞),
          needle = 248-30 = 218¬∞ ‚Äî still pointing at Mecca. ‚úì
   
   SENSOR SOURCES:
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   ‚Ä¢ iOS:     e.webkitCompassHeading  (already clockwise from magnetic N)
   ‚Ä¢ Android: e.alpha is counter-clockwise rotation of device in screen frame
              ‚Üí heading = (360 - alpha) mod 360
   
   GPS + QIBLA:
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   Uses navigator.geolocation with high accuracy.
   Falls back to Toshkent default if GPS unavailable.
============================================================ */

// ‚îÄ‚îÄ Stars ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
(()=>{
  const c=document.getElementById('stars');
  for(let i=0;i<75;i++){
    const s=document.createElement('div');s.className='star';
    const sz=Math.random()<.25?3:Math.random()<.5?2:1;
    s.style.cssText=`width:${sz}px;height:${sz}px;left:${Math.random()*100}%;top:${Math.random()*100}%;--d:${1.8+Math.random()*5}s;--dl:-${Math.random()*7}s`;
    c.appendChild(s);
  }
})();

// ‚îÄ‚îÄ Ka'ba coordinates (center of Masjid al-Haram) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const KA_LAT = 21.4225;
const KA_LON = 39.8262;

// ‚îÄ‚îÄ Application state ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let userLat    = 41.2995;   // Toshkent default
let userLon    = 69.2401;
let qiblaTrue  = 0;         // bearing to Mecca (0=N, clockwise)
let rawHead    = 0;         // latest raw device heading
let smoothHead = 0;         // smoothed heading for rendering
let sensorOK   = false;
let gpsOK      = false;
let prevAligned= false;
let kaabaClicks= 0;

// ‚îÄ‚îÄ Great-circle bearing (Vincenty formula, simplified) ‚îÄ‚îÄ‚îÄ‚îÄ
function calcQibla(lat, lon) {
  const R  = d => d * Math.PI / 180;
  const œÜ1 = R(lat), œÜ2 = R(KA_LAT);
  const ŒîŒª = R(KA_LON - lon);
  const y  = Math.sin(ŒîŒª) * Math.cos(œÜ2);
  const x  = Math.cos(œÜ1)*Math.sin(œÜ2) - Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª);
  return norm(Math.atan2(y,x) * 180 / Math.PI);
}

// ‚îÄ‚îÄ Angle helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function norm(a){ return ((a%360)+360)%360; }

// shortest-path lerp between angles
function lerpAng(cur,tgt,t){
  let d = norm(tgt)-norm(cur);
  if(d>180)d-=360;if(d<-180)d+=360;
  return cur+d*t;
}

function aligned(){
  let d=norm(qiblaTrue)-norm(smoothHead);
  if(d>180)d-=360;if(d<-180)d+=360;
  return Math.abs(d)<5;
}

function cardDir(deg){
  return ["Shimol","Shim-Sharq","Sharq","Jan-Sharq",
          "Janub","Jan-G ªarb","G ªarb","Shim-G ªarb"][Math.round(norm(deg)/45)%8];
}

// ‚îÄ‚îÄ Canvas setup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const cv = document.getElementById('cv');
const ctx= cv.getContext('2d');
const SZ = 590, CX=SZ/2, CY=SZ/2;

function drawCompass(heading){
  ctx.clearRect(0,0,SZ,SZ);
  const aln = aligned();

  // ‚îÄ‚îÄ Outer rim ‚îÄ‚îÄ
  const rim=ctx.createLinearGradient(0,0,SZ,SZ);
  if(aln){rim.addColorStop(0,'#4ade80');rim.addColorStop(1,'#16a34a');}
  else    {rim.addColorStop(0,'#22c55e');rim.addColorStop(1,'#0b5e22');}
  ctx.beginPath();ctx.arc(CX,CY,287,0,Math.PI*2);
  ctx.fillStyle=rim;ctx.fill();

  // ‚îÄ‚îÄ Face ‚îÄ‚îÄ
  const face=ctx.createRadialGradient(CX,CY,50,CX,CY,255);
  face.addColorStop(0,'#1a2030');face.addColorStop(1,'#0a0f1a');
  ctx.beginPath();ctx.arc(CX,CY,257,0,Math.PI*2);
  ctx.fillStyle=face;
  ctx.shadowColor=aln?'rgba(34,197,94,.28)':'transparent';
  ctx.shadowBlur=aln?32:0;
  ctx.fill();ctx.shadowBlur=0;

  // ‚îÄ‚îÄ ROTATING DISC ‚Äî follows the real world ‚îÄ‚îÄ
  // Rotate canvas by -heading so that geographic North stays at top
  ctx.save();
  ctx.translate(CX,CY);
  ctx.rotate(-heading*Math.PI/180);

  // Ticks
  for(let i=0;i<360;i++){
    const rad=i*Math.PI/180;
    const maj=i%30===0, med=i%10===0&&!maj;
    const len=maj?25:med?15:8;
    const r1=250,r2=r1-len;
    ctx.beginPath();
    ctx.moveTo(Math.cos(rad)*r1,Math.sin(rad)*r1);
    ctx.lineTo(Math.cos(rad)*r2,Math.sin(rad)*r2);
    ctx.strokeStyle=maj?'rgba(255,255,255,.88)':med?'rgba(255,255,255,.35)':'rgba(255,255,255,.11)';
    ctx.lineWidth=maj?2.6:1.6;
    ctx.stroke();
  }

  // Degree numbers at 30¬∞ steps (skip 0/90/180/270)
  ctx.font='600 17px Nunito,sans-serif';
  ctx.fillStyle='rgba(190,205,225,.62)';
  ctx.textAlign='center';ctx.textBaseline='middle';
  for(let i=0;i<360;i+=30){
    if(i%90===0)continue;
    const rad=i*Math.PI/180;
    ctx.save();
    ctx.translate(Math.sin(rad)*182,-Math.cos(rad)*182);
    ctx.rotate(rad);
    ctx.fillText(i,0,0);
    ctx.restore();
  }

  // Cardinal letters
  const CARDS=['N','E','S','W'];
  ctx.font='bold 37px Nunito,sans-serif';
  for(let i=0;i<4;i++){
    const rad=i*Math.PI/2;
    ctx.fillStyle=i===0?'#ef4444':'rgba(255,255,255,.84)';
    ctx.fillText(CARDS[i],Math.sin(rad)*210,-Math.cos(rad)*210);
  }

  // Intercardinals
  const IC=['NE','SE','SW','NW'];
  ctx.font='bold 15px Nunito,sans-serif';
  ctx.fillStyle='rgba(255,255,255,.28)';
  for(let i=0;i<4;i++){
    const rad=(i*90+45)*Math.PI/180;
    ctx.fillText(IC[i],Math.sin(rad)*203,-Math.cos(rad)*203);
  }

  ctx.restore(); // end rotating disc

  /* ‚îÄ‚îÄ QIBLA ARROW ‚Äî screen-fixed, points at Mecca ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
     
     needleAngleDeg = qiblaTrue - deviceHeading  (mod 360)
     
     This is the angle (clockwise from screen-up) that points
     toward Mecca regardless of how the device is oriented.
  */
  const needleDeg = norm(qiblaTrue - heading);
  const needleRad = needleDeg * Math.PI / 180;

  // unit vector toward Mecca on screen
  const nx =  Math.sin(needleRad);
  const ny = -Math.cos(needleRad);

  ctx.save();
  ctx.translate(CX,CY);

  // Soft glow trail
  const tg=ctx.createLinearGradient(0,0,nx*240,ny*240);
  tg.addColorStop(0,'rgba(240,192,64,0)');
  tg.addColorStop(.55,'rgba(240,192,64,.12)');
  tg.addColorStop(1,'rgba(240,192,64,.48)');
  ctx.beginPath();ctx.moveTo(0,0);ctx.lineTo(nx*240,ny*240);
  ctx.strokeStyle=tg;ctx.lineWidth=14;ctx.stroke();

  // Gold arc on rim
  const arcHalf=0.115;
  const arcBase=needleRad-Math.PI/2;
  ctx.beginPath();
  ctx.arc(0,0,265,arcBase-arcHalf,arcBase+arcHalf);
  ctx.strokeStyle='rgba(240,192,64,.78)';ctx.lineWidth=18;ctx.stroke();

  // Gold arrow
  ctx.save();
  ctx.rotate(needleRad);
  ctx.shadowColor='rgba(240,192,64,.85)';ctx.shadowBlur=22;

  // Tip triangle
  ctx.beginPath();
  ctx.moveTo(0,-247);
  ctx.lineTo(13,-212);ctx.lineTo(0,-223);ctx.lineTo(-13,-212);
  ctx.closePath();
  ctx.fillStyle='#f0c040';ctx.fill();

  // Shaft
  ctx.beginPath();
  ctx.moveTo(6,-212);ctx.lineTo(5,-128);ctx.lineTo(-5,-128);ctx.lineTo(-6,-212);
  ctx.closePath();
  ctx.fillStyle='rgba(240,192,64,.58)';ctx.fill();
  ctx.shadowBlur=0;
  ctx.restore();

  ctx.restore(); // end translate

  // Aligned pulse ring
  if(aln){
    const p=(Math.sin(Date.now()/270)+1)/2;
    ctx.beginPath();ctx.arc(CX,CY,257,0,Math.PI*2);
    ctx.strokeStyle=`rgba(34,197,94,${.28+p*.52})`;
    ctx.lineWidth=7;ctx.stroke();
  }

  // Fixed green NORTH pointer at screen top
  ctx.save();
  ctx.translate(CX,CY);
  ctx.shadowColor='#22c55e';ctx.shadowBlur=14;
  ctx.beginPath();
  ctx.moveTo(0,-263);ctx.lineTo(9,-243);ctx.lineTo(-9,-243);
  ctx.closePath();
  ctx.fillStyle='#22c55e';ctx.fill();
  ctx.shadowBlur=0;
  ctx.restore();
}

// ‚îÄ‚îÄ Render loop ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function loop(){
  smoothHead = lerpAng(smoothHead, rawHead, 0.10);
  drawCompass(smoothHead);

  const aln   = aligned();
  const hdDeg = Math.round(norm(smoothHead));

  // Update UI
  const dv=document.getElementById('dval');
  dv.textContent=hdDeg+'¬∞';
  dv.classList.toggle('on',aln);
  document.getElementById('ddir').textContent=cardDir(smoothHead);
  document.getElementById('gring').classList.toggle('on',aln);
  document.getElementById('kaaba').classList.toggle('on',aln);
  document.getElementById('banner').classList.toggle('show',aln);

  // Debug
  const dbg=document.getElementById('dbg');
  if(dbg.classList.contains('show')){
    dbg.innerHTML=`
      <b style="color:#e8edf5">Debug:</b><br>
      rawHead: <b>${rawHead.toFixed(2)}¬∞</b><br>
      smoothHead: <b>${smoothHead.toFixed(2)}¬∞</b><br>
      qiblaTrue: <b>${qiblaTrue.toFixed(2)}¬∞</b><br>
      needle: <b>${norm(qiblaTrue-smoothHead).toFixed(2)}¬∞</b><br>
      GPS: <b>${userLat.toFixed(5)}, ${userLon.toFixed(5)}</b><br>
      aligned: <b>${aln}</b>
    `;
  }

  // Vibrate + flash on align
  if(aln && !prevAligned && sensorOK){
    document.body.classList.add('fl');
    setTimeout(()=>document.body.classList.remove('fl'),750);
    if(navigator.vibrate)navigator.vibrate([65,45,100]);
  }
  prevAligned=aln;

  requestAnimationFrame(loop);
}

// ‚îÄ‚îÄ Device Orientation handler ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onOrient(e){
  /*
    iOS:     e.webkitCompassHeading = clockwise from magnetic North  ‚Üí use directly
    Android: e.alpha = device rotation counter-clockwise from North in lab frame
             ‚Üí True heading = (360 - alpha) mod 360
    
    Some Android devices also provide e.webkitCompassHeading (non-standard),
    so we prefer it when available on any platform.
  */
  let heading;

  if(typeof e.webkitCompassHeading==='number' && !isNaN(e.webkitCompassHeading)){
    // iOS (and some Android with WebKit compass)
    heading = e.webkitCompassHeading;
  } else if(typeof e.alpha==='number' && e.alpha!==null){
    // Standard Android DeviceOrientationEvent
    // alpha: 0 when top of device points to North (initially), increases counter-clockwise
    heading = norm(360 - e.alpha);
  } else {
    return; // no usable data
  }

  // If absolute orientation is available, prefer it (more accurate)
  // e.absolute===true means alpha is relative to geographic North, not magnetic
  // On most Android, alpha is already geographic if absolute===true

  rawHead = heading;

  if(!sensorOK){
    sensorOK=true;
    document.getElementById('dot').classList.add('on');
    document.getElementById('stxt').textContent='Kompas faol';
    hideLoading();
  }
}

// For Android: try AbsoluteOrientationSensor if available (most accurate)
function tryAbsoluteSensor(){
  if(typeof AbsoluteOrientationSensor==='undefined')return false;
  try{
    const s=new AbsoluteOrientationSensor({frequency:30,referenceFrame:'screen'});
    s.addEventListener('reading',()=>{
      // quaternion [x,y,z,w] ‚Üí heading
      const [x,y,z,w]=s.quaternion;
      const sinA=2*(w*z+x*y);
      const cosA=1-2*(y*y+z*z);
      let a=Math.atan2(sinA,cosA)*180/Math.PI;
      rawHead=norm(-a); // negate because sensor gives screen rotation
      if(!sensorOK){
        sensorOK=true;
        document.getElementById('dot').classList.add('on');
        document.getElementById('stxt').textContent='Kompas faol (Absolute)';
        hideLoading();
      }
    });
    s.addEventListener('error',()=>{
      // Fall back to deviceorientation
      window.addEventListener('deviceorientationabsolute',onOrient,true);
      window.addEventListener('deviceorientation',onOrient,true);
    });
    s.start();
    return true;
  }catch(e){
    return false;
  }
}

// ‚îÄ‚îÄ Geolocation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function startGeo(){
  setLocDisplay(userLat, userLon, "Toshkent, O'zbekiston"); // show default immediately
  qiblaTrue=calcQibla(userLat,userLon);
  document.getElementById('qbdg').textContent=Math.round(qiblaTrue)+'¬∞';

  if(!navigator.geolocation)return;

  // Try high-accuracy first
  navigator.geolocation.getCurrentPosition(
    onGPS,
    (err)=>{
      // If denied or timed out, try low accuracy
      if(err.code!==1){
        navigator.geolocation.getCurrentPosition(onGPS,onGPSErr,
          {enableHighAccuracy:false,timeout:8000,maximumAge:60000});
      } else {
        onGPSErr(err);
      }
    },
    {enableHighAccuracy:true,timeout:12000,maximumAge:0}
  );
}

function onGPS(pos){
  userLat=pos.coords.latitude;
  userLon=pos.coords.longitude;
  gpsOK=true;
  qiblaTrue=calcQibla(userLat,userLon);
  document.getElementById('qbdg').textContent=Math.round(qiblaTrue)+'¬∞';
  reverseGeo(userLat,userLon);
}

function onGPSErr(err){
  // Keep default coords, show message
  const msgs={1:'GPS ruxsati rad etildi',2:'GPS topilmadi',3:'GPS vaqt tugadi'};
  document.getElementById('lname').textContent=(msgs[err.code]||'GPS xatosi')+' (Toshkent ishlatilmoqda)';
  document.getElementById('lcoords').textContent=userLat.toFixed(4)+'¬∞N, '+userLon.toFixed(4)+'¬∞E';
}

function setLocDisplay(lat,lon,name){
  document.getElementById('lname').textContent=name;
  document.getElementById('lcoords').textContent=lat.toFixed(4)+'¬∞N, '+lon.toFixed(4)+'¬∞E';
}

function reverseGeo(lat,lon){
  fetch('https://nominatim.openstreetmap.org/reverse?lat='+lat+'&lon='+lon+'&format=json&accept-language=uz,en')
    .then(r=>r.json())
    .then(d=>{
      const a=d.address||{};
      const city=a.city||a.town||a.village||a.county||a.state||'Noma\'lum';
      const country=a.country||'';
      setLocDisplay(lat,lon,city+(country?', '+country:''));
    })
    .catch(()=>setLocDisplay(lat,lon,lat.toFixed(4)+'¬∞N, '+lon.toFixed(4)+'¬∞E'));
}

// ‚îÄ‚îÄ Demo mode ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let demoR;
function startDemo(){
  if(sensorOK)return;
  sensorOK=true;
  document.getElementById('dot').classList.add('on');
  document.getElementById('stxt').textContent='Demo rejim';
  let t=0;
  (function tick(){demoR=requestAnimationFrame(tick);t+=.45;rawHead=t%360;})();
  hideLoading();
  startGeo();
}

// ‚îÄ‚îÄ Loading helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function hideLoading(){
  const ls=document.getElementById('LS');
  ls.classList.add('hide');
  setTimeout(()=>ls.style.display='none',700);
}

function showPermBtn(msg,label,fn){
  document.getElementById('LSbody').innerHTML=
    `<div class="lsub" style="text-align:center;padding:0 26px;line-height:1.8">${msg}</div>`;
  const btn=document.getElementById('pbtn');
  if(label)btn.textContent=label;
  if(fn)btn.onclick=fn;
  btn.style.display='block';
}

// ‚îÄ‚îÄ iOS permission ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function askPermission(){
  document.getElementById('pbtn').style.display='none';
  document.getElementById('LSbody').innerHTML='<div class="spin"></div><div class="lsub">Ruxsat so\'ralmoqda...</div>';

  const isIOS=typeof DeviceOrientationEvent!=='undefined' &&
               typeof DeviceOrientationEvent.requestPermission==='function';
  if(isIOS){
    DeviceOrientationEvent.requestPermission()
      .then(s=>{
        if(s==='granted'){
          window.addEventListener('deviceorientation',onOrient,true);
          startGeo();
        } else {
          showPermBtn('Ruxsat rad etildi. Brauzer sozlamalarini tekshiring.','‚ñ∂ Demo',startDemo);
        }
      })
      .catch(e=>showPermBtn('Xato: '+e.message,'‚ñ∂ Demo',startDemo));
  } else {
    window.addEventListener('deviceorientation',onOrient,true);
    startGeo();
  }
}

// ‚îÄ‚îÄ Ka'ba tap ‚Üí debug ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('kaaba').addEventListener('click',()=>{
  kaabaClicks++;
  if(kaabaClicks>=5){
    kaabaClicks=0;
    document.getElementById('dbg').classList.toggle('show');
  }
});

// ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addEventListener('DOMContentLoaded',()=>{

  // Telegram Mini App
  if(window.Telegram?.WebApp){
    const tg=window.Telegram.WebApp;
    tg.ready();tg.expand();
    tg.setHeaderColor?.('#0a0f1a');
    tg.setBackgroundColor?.('#0a0f1a');
  }

  // Initial Qibla (default coords until GPS ready)
  qiblaTrue=calcQibla(userLat,userLon);
  document.getElementById('qbdg').textContent=Math.round(qiblaTrue)+'¬∞';

  // Start render immediately
  loop();

  // Detect platform
  const isIOS = typeof DeviceOrientationEvent!=='undefined' &&
                typeof DeviceOrientationEvent.requestPermission==='function';

  if(isIOS){
    // iOS: must request permission via user gesture
    showPermBtn('Kompasni ishlatish uchun qurilma ruxsatini bering','üìç Ruxsat berish',askPermission);
  } else {
    // Android / desktop
    // Try sensors
    const usedAbsolute = tryAbsoluteSensor();
    if(!usedAbsolute){
      // Prefer deviceorientationabsolute (gives geographic North, no magnetic declination needed)
      window.addEventListener('deviceorientationabsolute', onOrient, true);
      // Fallback to standard deviceorientation
      window.addEventListener('deviceorientation', onOrient, true);
    }
    startGeo();

    // After 4s, if still no sensor, offer demo
    setTimeout(()=>{
      if(!sensorOK){
        showPermBtn('Kompas sensori ishlamayapti yoki ruxsat yo\'q','‚ñ∂ Demo rejim',startDemo);
      }
    },4000);
  }
});
</script>
</body>
</html>
